<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Ana Guimarães Doceria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body { font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; scroll-padding-top: 140px; }
        
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #db2777;
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        #toast { transition: opacity 0.5s, transform 0.5s; }
        #subcategory-nav a.active { 
            color: #db2777;
            border-bottom-color: #db2777;
        }
        #subcategory-nav::-webkit-scrollbar { display: none; }
        #subcategory-nav { -ms-overflow-style: none; scrollbar-width: none; }
        .map-placeholder { height: 300px; width: 100%; border-radius: 0.5rem; background-color: #f9fafb; display: flex; align-items: center; justify-content: center; color: #6b7280; }
    </style>
	<!-- Google Maps API 
        IMPORTANTE: Para o mapa funcionar corretamente, você precisa:-->
	
	<script 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUiV11tfJJySiaunNXWhbrhtpDPlMmx8k&libraries=places,marker&v=weekly"
		async defer></script>
		
</head>
<body class="bg-pink-50">
    <!-- CABEÇALHO -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="/logotipo.png" alt="Logotipo" class="h-10">
                <h1 class="text-2xl font-bold text-pink-600">Nosso Cardápio</h1>
            </div>
            <button id="cart-button" class="relative">
                <i class="fa-solid fa-shopping-cart text-2xl text-gray-600"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </header>
    
    <!-- NAVEGAÇÃO DE SUBCATEGORIAS -->
    <nav id="subcategory-nav-container" class="bg-white sticky top-[72px] z-10 shadow-sm">
        <div id="subcategory-nav" class="container mx-auto px-6 flex items-center space-x-6 overflow-x-auto whitespace-nowrap"></div>
    </nav>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="container mx-auto px-6 py-8">
        <div id="product-list" class="space-y-12">
            <div id="loading-message" class="col-span-full flex flex-col items-center justify-center py-16">
                <div class="loader"></div>
                <p class="text-pink-600 mt-4">Carregando nosso cardápio...</p>
            </div>
        </div>
    </main>

    <!-- MODAIS -->

    <!-- Modal do Carrinho -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Seu Pedido</h2>
                <button id="close-cart" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="cart-items" class="p-6 max-h-80 overflow-y-auto"></div>
            <div class="p-6 border-t space-y-4">
                <div id="cart-summary" class="space-y-1 text-gray-700">
                    <div class="flex justify-between"><span>Subtotal:</span><span id="cart-subtotal">R$ 0,00</span></div>
                    <div id="discount-line" class="flex justify-between text-green-600 hidden"><span>Desconto:</span><span id="cart-discount"></span></div>
                    <div id="shipping-line" class="flex justify-between hidden"><span>Frete:</span><span id="cart-shipping">R$ 0,00</span></div>
                    <div class="flex justify-between items-center font-bold text-xl"><span>Total:</span><span id="cart-total">R$ 0,00</span></div>
                </div>
                <button id="checkout-button" class="w-full bg-pink-600 text-white py-3 rounded-lg mt-2 font-bold hover:bg-pink-700 transition-colors">Finalizar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Identificação -->
    <div id="identification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Como deseja continuar?</h2>
            <p class="text-gray-600 mb-6">Você pode buscar seu cadastro ou continuar como visitante.</p>
            <div class="space-y-4">
                <button id="use-phone-button" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-mobile-screen-button"></i> Usar número de celular
                </button>
                <button id="continue-guest-button" class="w-full bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors">Continuar sem cadastro</button>
                <button id="close-identification-modal" class="text-sm text-gray-500 mt-4 hover:underline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Login com Telefone -->
    <div id="phone-login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Identificar Cliente</h2>
                <button id="close-phone-login-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Digite seu número de celular para buscar seu cadastro.</p>
                <input id="phone-input" type="tel" placeholder="(00) 00000-0000" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                <p id="phone-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t">
                <button id="search-phone-button" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700 transition-colors">Buscar</button>
            </div>
        </div>
    </div>

	<!-- Modal de Gerenciamento de Endereço -->
	<div id="address-management-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
		<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
			<div class="p-6 border-b bg-white">
				<h2 class="text-2xl font-bold text-pink-600">Seus Endereços</h2>
				<p class="text-gray-600 mt-1">Olá, <strong id="confirm-customer-name"></strong>! Escolha ou adicione um endereço.</p>
			</div>
			
			<div class="p-6 overflow-y-auto flex-grow">
				<!-- Lista de Endereços Existentes -->
				<div id="address-list" class="space-y-4 mb-6">
					<!-- Endereços serão carregados aqui dinamicamente -->
				</div>

				<!-- Botão para Adicionar Novo Endereço -->
				<div class="border-t pt-6">
					<button id="show-new-address-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
						<i class="fa-solid fa-plus-circle"></i>
						Adicionar Novo Endereço
					</button>
				</div>

				<!-- Seção de Novo Endereço (inicialmente oculta) -->
				<div id="new-address-section" class="hidden mt-6 border-t pt-6">
					<h3 class="text-xl font-bold text-gray-800 mb-4">Novo Endereço</h3>
					
					<div class="space-y-4">
						<!-- Formulário de Endereço -->
						<div class="space-y-4">
							<!-- Container para o mapa e input -->
							<div id="address-map-container" class="relative">
								<!-- O mapa ou o placeholder serão inseridos aqui via JS -->
							</div>
							
							<!-- Número e Complemento -->
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
									<input id="manual-address-number" type="text" placeholder="Número" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
									<input id="manual-address-complement" type="text" placeholder="Apto, Bloco, etc." 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
							</div>

							<!-- Bairro, Cidade e CEP -->
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Bairro *</label>
									<input id="manual-address-neighborhood" type="text" placeholder="Bairro" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
									<input id="manual-address-city" type="text" placeholder="Cidade" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors" value="Goiânia">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
									<input id="manual-address-zip" type="text" placeholder="CEP" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
							</div>
                             <!-- Endereço Completo (oculto, preenchido pelo mapa) -->
                            <input id="manual-address-input" type="hidden">
							<!-- Apelido do Endereço -->
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">Apelido do endereço *</label>
								<input id="manual-address-nickname" type="text" placeholder="Como você chama este endereço? (Ex: Casa, Trabalho)" 
									   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
							</div>
						</div>

						<!-- Botões de Ação -->
						<div class="flex gap-3 pt-4">
							<button id="save-manual-address-button" 
									class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
								<i class="fa-solid fa-save"></i>
								Salvar Endereço
							</button>
							<button id="cancel-new-address-button" 
									class="bg-gray-500 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-600 transition-colors">
								Cancelar
							</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Rodapé do Modal -->
			<div class="p-6 border-t bg-gray-50">
				<button id="close-address-management-modal" class="w-full bg-gray-500 text-white py-3 rounded-lg font-bold hover:bg-gray-600 transition-colors">
					Fechar
				</button>
			</div>
		</div>
	</div>

    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <button id="back-to-address" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-pink-600 text-center flex-grow">Forma de Pagamento</h2>
                <button id="close-payment-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm">
                    <p class="text-gray-500">Entregar em:</p>
                    <p id="selected-address-text" class="font-semibold text-gray-800"></p>
                </div>
                <div class="space-y-2 mb-4">
                    <div class="flex gap-2">
                        <input id="payment-cupom-input" type="text" placeholder="Tem um cupom?" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 uppercase">
                        <button id="payment-verify-cupom-button" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700 transition-colors flex-shrink-0">Aplicar</button>
                    </div>
                    <p id="payment-cupom-message" class="text-sm"></p>
                </div>
                <div id="payment-summary" class="mb-4 p-4 border rounded-lg space-y-2">
                    <h3 class="font-bold text-gray-700">Resumo do Pedido</h3>
                    <div class="flex justify-between text-sm"><span>Subtotal Produtos:</span><span id="payment-subtotal" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div id="payment-discount-row" class="flex justify-between text-sm text-green-600 hidden"><span>Desconto:</span><span id="payment-discount" class="font-medium">- R$ 0,00</span></div>
                    <div id="payment-shipping-row" class="flex justify-between text-sm"><span>Frete:</span><span id="payment-shipping" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Total a pagar:</span><span id="payment-total" class="text-pink-600">R$ 0,00</span></div>
                </div>
                <p class="text-gray-600 mb-4">Selecione como você prefere pagar.</p>
                <select id="payment-method-select" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                    <option value="" disabled selected>Escolha uma opção...</option>
                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                    <option value="Cartão de Débito">Cartão de Débito</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Link de Pagamento">Link de Pagamento</option>
                </select>
                <p id="payment-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t">
                <button id="confirm-order-button" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700 transition-colors">Confirmar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Informações do Visitante (Simplificado) -->
    <div id="guest-info-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Quase lá!</h2>
                <button id="close-guest-info-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <p class="text-gray-600 mb-4">Por favor, informe seus dados para entrega e pagamento.</p>
                <div id="guest-summary" class="mb-4 p-4 border rounded-lg space-y-2">
                    <h3 class="font-bold text-gray-700">Resumo do Pedido</h3>
                    <div class="flex justify-between text-sm"><span>Subtotal Produtos:</span><span id="guest-subtotal" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div id="guest-discount-row" class="flex justify-between text-sm text-green-600 hidden"><span>Desconto:</span><span id="guest-discount" class="font-medium">- R$ 0,00</span></div>
                    <div id="guest-shipping-row" class="flex justify-between text-sm"><span>Frete:</span><span id="guest-shipping" class="font-medium text-gray-800">R$ 5,00</span></div>
                    <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Total a pagar:</span><span id="guest-total" class="text-pink-600">R$ 0,00</span></div>
                </div>
                <div class="space-y-2 mb-4">
                    <div class="flex gap-2">
                        <input id="guest-cupom-input" type="text" placeholder="Tem um cupom?" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 uppercase">
                        <button id="guest-verify-cupom-button" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700 transition-colors flex-shrink-0">Aplicar</button>
                    </div>
                    <p id="guest-cupom-message" class="text-sm"></p>
                </div>
                <div class="space-y-4">
                    <input id="guest-name" type="text" placeholder="Seu nome completo" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <input id="guest-phone" type="tel" placeholder="Seu telefone (WhatsApp)" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <div>
                        <label for="guest-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço de entrega</label>
                        <textarea id="guest-address" placeholder="Digite seu endereço completo (Rua, número, bairro, cidade)" 
                                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 h-20"></textarea>
                    </div>
                    <select id="guest-payment-method" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                        <option value="" disabled selected>Forma de Pagamento</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Cartão de Débito">Cartão de Débito</option>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Link de Pagamento">Link de Pagamento</option>
                    </select>
                </div>
            </div>
            <div class="p-6 border-t">
                <button id="send-whatsapp-button" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-brands fa-whatsapp"></i> Enviar Pedido via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido (WhatsApp) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Enviado!</h2>
            <p class="text-gray-600">Obrigado! Seu pedido foi registrado e a mensagem está pronta para ser enviada.</p>
            <button id="close-confirmation" class="bg-pink-600 text-white py-2 px-6 rounded-lg mt-6 font-bold hover:bg-pink-700 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido (Plataforma) -->
    <div id="platform-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Registrado!</h2>
            <p class="text-gray-600">Obrigado! Seu pedido foi enviado diretamente para a nossa plataforma.</p>
            <button id="close-platform-confirmation" class="bg-pink-600 text-white py-2 px-6 rounded-lg mt-6 font-bold hover:bg-pink-700 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden opacity-0 transform translate-y-2">
        <p id="toast-message"></p>
    </div>

    <!-- SCRIPTS -->
	<!-- 
        Google Maps API 
        IMPORTANTE: Para o mapa funcionar corretamente, você precisa:
        1. Ativar as APIs "Maps JavaScript API", "Places API", e "Geocoding API" no seu projeto do Google Cloud Console.
        2. Criar um "Map ID" no Google Cloud Console e substituir 'DEMO_MAP_ID' abaixo.
    
	<script 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUiV11tfJJySiaunNXWhbrhtpDPlMmx8k&libraries=places,marker&v=weekly"
		async defer></script>
	-->
	<script type="module">
	  import { db, doc, getDoc } from "./firebaseClientConfig.js";

	  // Variável global para armazenar os dados de frete
	  window.dadosFrete = null;

	  async function carregarConfiguracoesFrete() {
		try {
		  const freteRef = doc(db, "configuracoes", "frete");
		  const freteSnap = await getDoc(freteRef);
		  if (freteSnap.exists()) {
			window.dadosFrete = freteSnap.data();
			console.log("✅ Configurações de frete carregadas:", window.dadosFrete);
		  } else {
			console.error("❌ Documento 'frete' não encontrado");
		  }
		} catch (error) {
		  console.error("Erro ao carregar frete:", error);
		}
	  }

	  document.addEventListener("DOMContentLoaded", carregarConfiguracoesFrete);
	</script>

	<script>
    // --- LÓGICA DO GOOGLE MAPS ---
	let map, marker, geocoder, placeAutocomplete;
    // Variável global para armazenar coordenadas e habilitar a comunicação entre scripts
    window.currentLatLng = null; 

    // --- VARIÁVEIS DE VALIDAÇÃO ---
    const saveAddressBtn = document.getElementById('save-manual-address-button');
    // Desabilitar inicialmente
    saveAddressBtn.disabled = true;
    saveAddressBtn.classList.add('opacity-50', 'cursor-not-allowed');

    // Função de verificação geral
    function validateAddressForm() {
        const rua = document.getElementById('manual-address-input').value.trim();
        const bairro = document.getElementById('manual-address-neighborhood').value.trim();
        const cidade = document.getElementById('manual-address-city').value.trim();
        const apelido = document.getElementById('manual-address-nickname').value.trim();

        const isValid =
            rua.length > 0 &&
            bairro.length > 0 &&
            cidade.length > 0 &&
            apelido.length > 0 &&
            window.currentLatLng?.lat &&
            window.currentLatLng?.lng;

        if (isValid) {
            saveAddressBtn.disabled = false;
            saveAddressBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            saveAddressBtn.disabled = true;
            saveAddressBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    async function initAddressMap() {
        const addressMapContainer = document.getElementById('address-map-container');
        addressMapContainer.innerHTML = ''; // Limpa o container para reinicialização

        try {
            const defaultCenter = { lat: -16.6869, lng: -49.2648 }; // Goiânia
            geocoder = new google.maps.Geocoder();

            // Carrega as bibliotecas da API
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            // Elemento do mapa
            const mapDiv = document.createElement('div');
            mapDiv.style.height = '300px';
            mapDiv.style.width = '100%';
            mapDiv.style.borderRadius = '0.5rem';
            mapDiv.style.marginTop = '0.75rem';

            // Inicializa mapa
            map = new Map(mapDiv, {
                center: defaultCenter,
                zoom: 14,
                mapId: 'DEMO_MAP_ID', // SUBSTITUA PELO SEU MAP ID REAL
            });

            // Novo marcador avançado
            marker = new AdvancedMarkerElement({
                map: map,
                position: defaultCenter,
                gmpDraggable: true,
            });

            marker.addListener('dragend', () => {
                reverseGeocode(marker.position);
            });

            // Campo de busca (PlaceAutocompleteElement)
			placeAutocomplete = new google.maps.places.PlaceAutocompleteElement()
			placeAutocomplete.className = 'w-full mb-2 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500'
			placeAutocomplete.setAttribute('aria-label', 'Buscar endereço')
			placeAutocomplete.setAttribute('placeholder', 'Digite o endereço...')

			// ✅ CÓDIGO CORRIGIDO - Suporta ambas as versões da API

			// ✅ EVENTO ANTIGO (gmp-placeselect) - Para compatibilidade
			placeAutocomplete.addEventListener('gmp-placeselect', async (event) => {
			  try {
				console.log('🔵 Evento gmp-placeselect disparado (versão antiga)');
				const place = event.detail?.place || event.place;
				
				await place.fetchFields({ 
				  fields: ['geometry', 'addressComponents', 'formattedAddress'] 
				});
				
				if (!place.geometry || !place.geometry.location) {
				  throw new Error('Localização não disponível');
				}
				
				const location = place.geometry.location;
				const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
				const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
				
				const newPosition = { lat: lat, lng: lng };
				
				console.log('📍 Endereço:', place.formattedAddress);
				console.log('📍 Coordenadas:', newPosition);
				
				if (map) {
				  map.setCenter(newPosition);
				  map.setZoom(18);
				  console.log('✅ Mapa centralizado');
				}
				
				if (marker) {
				  marker.position = newPosition;
				  console.log('✅ Marcador movido');
				}
				
				window.currentLatLng = newPosition;
				fillAddressFields(place);
				validateAddressForm();
				
				// Mostrar toast se a função existir
				if (typeof showToast === 'function') {
				  showToast('📍 Endereço encontrado!');
				} else {
				  alert('📍 Endereço encontrado!');
				}
				
			  } catch (error) {
				console.error('❌ Erro (versão antiga):', error);
				if (typeof showToast === 'function') {
				  showToast('Erro: ' + error.message, true);
				} else {
				  alert('Erro: ' + error.message);
				}
			  }
			});

			// ✅ REMOVA todos os event listeners antigos e use APENAS estes:

			// Evento gmp-select (versão nova da API)
			placeAutocomplete.addEventListener('gmp-select', async ({ placePrediction }) => {
			  try {
				console.log('🟢 Evento gmp-select disparado');
				
				const place = placePrediction.toPlace();
				
				// ✅ Use 'location' ao invés de 'geometry'
				await place.fetchFields({ 
				  fields: ['displayName', 'formattedAddress', 'location', 'addressComponents'] 
				});
				
				console.log('📦 Place completo:', place);
				console.log('📦 Location:', place.location);
				
				if (!place.location) {
				  console.error('❌ Localização não disponível');
				  alert('Não foi possível obter as coordenadas deste endereço.');
				  return;
				}
				
				// Extrair coordenadas
				const location = place.location;
				const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
				const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
				
				const newPosition = { lat: lat, lng: lng };
				
				console.log('📍 Endereço:', place.formattedAddress);
				console.log('📍 Display Name:', place.displayName);
				console.log('📍 Coordenadas:', newPosition);
				
				// Mover mapa
				if (map) {
				  map.setCenter(newPosition);
				  map.setZoom(18);
				  console.log('✅ Mapa centralizado');
				}
				
				// Mover marcador
				if (marker) {
				  marker.position = newPosition;
				  console.log('✅ Marcador movido para:', newPosition);
				}
				
				// ✅ IMPORTANTE: Salvar coordenadas globalmente
				window.currentLatLng = newPosition;
				console.log('✅ Coordenadas salvas em window.currentLatLng:', window.currentLatLng);
				
				// Preencher formulário
				if (typeof fillAddressFields === 'function') {
				  fillAddressFields(place);
				  console.log('✅ Campos preenchidos');
				}
				
				// Validar formulário
				if (typeof validateAddressForm === 'function') {
				  validateAddressForm();
				  console.log('✅ Formulário validado');
				}
				
				// Feedback visual
				console.log('✅ SUCESSO COMPLETO!');
				
				// Mostrar toast de sucesso
				const toastEl = document.getElementById('toast');
				const toastMessage = document.getElementById('toastMessage');
				if (toastEl && toastMessage) {
				  toastMessage.textContent = '📍 Endereço encontrado e marcador movido!';
				  toastEl.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 bg-green-500';
				  toastEl.classList.remove('hidden');
				  setTimeout(() => { 
					toastEl.classList.remove('opacity-0', 'translate-y-2'); 
				  }, 10);
				  setTimeout(() => { 
					toastEl.classList.add('opacity-0', 'translate-y-2'); 
					setTimeout(() => toastEl.classList.add('hidden'), 500); 
				  }, 3000);
				}
				
			  } catch (error) {
				console.error('❌ Erro completo:', error);
				console.error('❌ Stack:', error.stack);
				alert('Erro ao buscar endereço: ' + error.message);
			  }
			});


			// ✅ EVENTO ANTIGO (gmp-placeselect) - Para compatibilidade
			placeAutocomplete.addEventListener('gmp-placeselect', async (event) => {
			  try {
				console.log('🔵 Evento gmp-placeselect disparado (versão antiga)');
				const place = event.detail?.place || event.place;
				
				await place.fetchFields({ 
				  fields: ['geometry', 'addressComponents', 'formattedAddress'] 
				});
				
				if (!place.geometry || !place.geometry.location) {
				  throw new Error('Localização não disponível');
				}
				
				const location = place.geometry.location;
				const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
				const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
				
				const newPosition = { lat: lat, lng: lng };
				
				console.log('📍 Endereço:', place.formattedAddress);
				console.log('📍 Coordenadas:', newPosition);
				
				if (map) {
				  map.setCenter(newPosition);
				  map.setZoom(18);
				  console.log('✅ Mapa centralizado');
				}
				
				if (marker) {
				  marker.position = newPosition;
				  console.log('✅ Marcador movido');
				}
				
				window.currentLatLng = newPosition;
				fillAddressFields(place);
				validateAddressForm();
				showToast('📍 Endereço encontrado!');
				
			  } catch (error) {
				console.error('❌ Erro (versão antiga):', error);
				showToast('Erro: ' + error.message, true);
			  }
			});


            // Botão "Minha localização"
            const locationBtn = document.createElement('button');
            locationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Minha localização';
            locationBtn.className = 'w-full bg-pink-600 text-white px-3 py-2 rounded-lg font-bold mb-2 hover:bg-pink-700 transition-colors';
            locationBtn.type = 'button';

            locationBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const coords = {
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                            };
                            map.panTo(coords);
                            map.setZoom(17);
                            marker.position = coords;
                            reverseGeocode(coords);
                        },
                        (err) => alert('Não foi possível obter localização: ' + err.message),
                        { timeout: 10000 }
                    );
                } else {
                    alert('Geolocalização não suportada neste navegador.');
                }
            });

            // Adiciona elementos ao container
            addressMapContainer.appendChild(placeAutocomplete);
            addressMapContainer.appendChild(locationBtn);
            addressMapContainer.appendChild(mapDiv);
            
            // Validação inicial
            validateAddressForm();

        } catch (error) {
            console.error("Erro ao inicializar o mapa:", error);
            addressMapContainer.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-700">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                    Ocorreu um erro ao carregar o mapa. Verifique a chave de API e as configurações.
                </div>
            `;
        }
    }

	function reverseGeocode(latlng) {
	  // Garante que a coordenada seja um objeto literal
	  if (typeof latlng.lat === 'function') {
		window.currentLatLng = { lat: latlng.lat(), lng: latlng.lng() };
	  } else {
		window.currentLatLng = latlng;
	  }
	  
	  console.log('🔄 Fazendo geocode reverso para:', window.currentLatLng);
	  
	  geocoder.geocode({ location: latlng }, (results, status) => {
		if (status === 'OK' && results[0]) {
		  console.log('✅ Geocode reverso bem-sucedido');
		  fillAddressFields(results[0]);
		} else {
		  console.warn('⚠️ Geocode reverso falhou, mas coordenadas foram salvas');
		  // Mesmo se o geocode falhar, valida o formulário
		  // porque as coordenadas já foram salvas
		  validateAddressForm();
		}
	  });
	}


	function fillAddressFields(place) {
	  const components = place.addressComponents || place.addresscomponents;
	  const get = (type) => components?.find(c => c.types.includes(type))?.longName;
	  
	  // ✅ Preencher o campo hidden com o endereço completo formatado
	  const enderecoCompleto = place.formattedAddress || place.formattedaddress || '';
	  document.getElementById('manual-address-input').value = enderecoCompleto;
	  
	  // Preencher outros campos
	  document.getElementById('manual-address-number').value = get('street_number') || '';
	  document.getElementById('manual-address-neighborhood').value = 
		get('sublocality_level_1') || get('sublocality') || get('political') || '';
	  document.getElementById('manual-address-city').value = 
		get('administrative_area_level_2') || 'Goiânia';
	  document.getElementById('manual-address-zip').value = get('postal_code') || '';
	  
	  console.log('✅ Campo manual-address-input preenchido com:', enderecoCompleto);
	  
	  // Dispara a validação após preencher os campos
	  validateAddressForm();
	}


    // Inicializar mapa ao abrir a seção de novo endereço
    document.getElementById('show-new-address-btn').addEventListener('click', () => {
        setTimeout(initAddressMap, 300);
    });

    // Listeners para os campos de texto do formulário de endereço
    ['manual-address-input','manual-address-number','manual-address-neighborhood','manual-address-city','manual-address-nickname']
    .forEach(id => {
        document.getElementById(id).addEventListener('input', validateAddressForm);
    });
	</script>

    
    <script type="module">
        // --- VARIÁVEIS GLOBAIS ---
        const WHATSAPP_NUMBER = '5562991056075';
        let allProducts = [], cart = [], currentClient = null, pendingOrderDetails = {}, appliedCupom = null;
        const subcategoryOrder = ['Queridinhos', 'Bolo no pote', 'Copo da felicidade', 'Bombom aberto', 'Pipoca', 'Cone recheado', 'Bolo gelado', 'Bombom recheado'];
        let valorFrete = 0; // Valor fixo temporário
        let storeConfig = {};

        // --- SELEÇÃO DE ELEMENTOS DOM ---
        const productList = document.getElementById('product-list'),
              subcategoryNav = document.getElementById('subcategory-nav'),
              loadingMessage = document.getElementById('loading-message'),
              cartButton = document.getElementById('cart-button'),
              cartModal = document.getElementById('cart-modal'),
              closeCartButton = document.getElementById('close-cart'),
              cartItemsContainer = document.getElementById('cart-items'),
              cartCount = document.getElementById('cart-count'),
              cartSubtotal = document.getElementById('cart-subtotal'),
              cartDiscountLine = document.getElementById('discount-line'),
              cartDiscount = document.getElementById('cart-discount'),
              cartShippingLine = document.getElementById('shipping-line'),
              cartShipping = document.getElementById('cart-shipping'),
              cartTotal = document.getElementById('cart-total'),
              checkoutButton = document.getElementById('checkout-button'),
              identificationModal = document.getElementById('identification-modal'),
              usePhoneButton = document.getElementById('use-phone-button'),
              continueGuestButton = document.getElementById('continue-guest-button'),
              closeIdentificationModal = document.getElementById('close-identification-modal'),
              guestInfoModal = document.getElementById('guest-info-modal'),
              closeGuestInfoModal = document.getElementById('close-guest-info-modal'),
              sendWhatsappButton = document.getElementById('send-whatsapp-button'),
              guestNameInput = document.getElementById('guest-name'),
              guestPhoneInput = document.getElementById('guest-phone'),
              guestAddressInput = document.getElementById('guest-address'),
              guestPaymentMethodSelect = document.getElementById('guest-payment-method'),
              phoneLoginModal = document.getElementById('phone-login-modal'),
              closePhoneLoginModal = document.getElementById('close-phone-login-modal'),
              phoneInput = document.getElementById('phone-input'),
              phoneError = document.getElementById('phone-error'),
              searchPhoneButton = document.getElementById('search-phone-button'),
              addressManagementModal = document.getElementById('address-management-modal'),
              addressModalTitle = document.getElementById('address-modal-title'),
              confirmCustomerName = document.getElementById('confirm-customer-name'),
              addressList = document.getElementById('address-list'),
              closeAddressManagementModal = document.getElementById('close-address-management-modal'),
              paymentModal = document.getElementById('payment-modal'),
              closePaymentModal = document.getElementById('close-payment-modal'),
              backToAddressButton = document.getElementById('back-to-address'),
              selectedAddressText = document.getElementById('selected-address-text'),
              paymentMethodSelect = document.getElementById('payment-method-select'),
              confirmOrderButton = document.getElementById('confirm-order-button'),
              paymentError = document.getElementById('payment-error'),
              confirmationModal = document.getElementById('confirmation-modal'),
              closeConfirmationButton = document.getElementById('close-confirmation'),
              platformConfirmationModal = document.getElementById('platform-confirmation-modal'),
              closePlatformConfirmationButton = document.getElementById('close-platform-confirmation'),
              toast = document.getElementById('toast'),
              toastMessage = document.getElementById('toast-message'),
              guestCupomInput = document.getElementById('guest-cupom-input'),
              guestVerifyCupomButton = document.getElementById('guest-verify-cupom-button'),
              guestCupomMessage = document.getElementById('guest-cupom-message'),
              paymentCupomInput = document.getElementById('payment-cupom-input'),
              paymentVerifyCupomButton = document.getElementById('payment-verify-cupom-button'),
              paymentCupomMessage = document.getElementById('payment-cupom-message');

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        async function initApp() {
            try {
                await fetchStoreConfig();
                await fetchProducts();
                setupEventListeners();
                renderCart();
                console.log("✅ Aplicação inicializada com sucesso!");
            } catch (error) {
                console.error('❌ Erro ao inicializar aplicação:', error);
                showToast('Erro ao carregar a aplicação.', true);
            }
        }

        // --- FUNÇÕES PRINCIPAIS ---

        // Funções de Produtos
        async function fetchStoreConfig() {
            try {
                const { db, doc, getDoc } = await import('./firebaseClientConfig.js');
                const configDoc = await getDoc(doc(db, "configuracoes", "frete"));
                if (configDoc.exists()) {
                    storeConfig = configDoc.data();
                    console.log("✅ Configurações da loja carregadas:", storeConfig);
                }
            } catch (error) {
                console.error("Erro ao carregar configurações:", error);
            }
        }

        async function fetchProducts() {
            try {
                console.log("🔄 Buscando produtos do Firebase...");
                
                const { db, collection, getDocs, query, where } = await import('./firebaseClientConfig.js');
                
                const q = query(collection(db, "produtos"), where("status", "==", "Ativo"));
                const querySnapshot = await getDocs(q);
                allProducts = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                console.log(`✅ ${allProducts.length} produtos carregados`);
                
                if (allProducts.length === 0) {
                    throw new Error('Nenhum produto encontrado');
                }
                
                renderMenu();
                
            } catch (error) { 
                console.error("❌ Erro ao buscar produtos:", error);
                loadingMessage.innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 text-lg font-bold mb-2">Erro ao carregar o cardápio</p>
                        <p class="text-gray-600 text-sm">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700">
                            Tentar Novamente
                        </button>
                    </div>
                `;
                showToast("Erro ao buscar produtos: " + error.message, true);
            } finally { 
                loadingMessage.style.display = 'none'; 
            }
        }

        function renderMenu() {
            const deliveryProducts = allProducts.filter(p => p.categoria === 'Delivery');
            
            if (deliveryProducts.length === 0) {
                productList.innerHTML = `
                    <div class="text-center py-16">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-600 text-lg">Nenhum produto disponível para delivery no momento.</p>
                    </div>
                `;
                return;
            }

            const productsBySubcategory = deliveryProducts.reduce((acc, product) => { 
                const sub = product.subcategoria || 'Outros'; 
                if (!acc[sub]) acc[sub] = []; 
                acc[sub].push(product); 
                return acc; 
            }, {});
            
            const availableSubcategories = subcategoryOrder.filter(sub => productsBySubcategory[sub]?.length > 0);
            const otherSubcategories = Object.keys(productsBySubcategory)
                .filter(sub => !subcategoryOrder.includes(sub) && productsBySubcategory[sub]?.length > 0);
            
            const allSubcategories = [...availableSubcategories, ...otherSubcategories];
            
            productList.innerHTML = ''; 
            subcategoryNav.innerHTML = '';
            
            allSubcategories.forEach(sub => { 
                const slug = sub.toLowerCase().replace(/\s+/g, '-'); 
                const link = document.createElement('a'); 
                link.href = `#${slug}`; 
                link.textContent = sub; 
                link.className = 'py-4 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:text-pink-600 transition-colors'; 
                subcategoryNav.appendChild(link); 
            });
            
            allSubcategories.forEach(sub => { 
                const slug = sub.toLowerCase().replace(/\s+/g, '-'); 
                const section = document.createElement('section'); 
                section.id = slug;
                section.className = 'mb-12';
                
                section.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-2">${sub}</h2>
                `; 
                
                const grid = document.createElement('div'); 
                grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6';
                
                productsBySubcategory[sub].forEach(product => { 
                    grid.innerHTML += createProductCard(product); 
                });
                
                section.appendChild(grid); 
                productList.appendChild(section);
            });
            
            setupScrollSpy();
        }

        function createProductCard(product) {
            const isOutOfStock = product.estoque !== null && product.estoque <= 0;
            const imageUrl = product.imageUrl || 'https://placehold.co/600x400/FFC0CB/FFFFFF?text=Doce+Ana+Guimarães';
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col h-full transform hover:scale-105 transition-transform duration-300 ${isOutOfStock ? 'opacity-50 grayscale' : ''}">
                    <img src="${imageUrl}" alt="${product.nome}" 
                         class="w-full h-48 object-cover" 
                         onerror="this.src='https://placehold.co/600x400/FFC0CB/FFFFFF?text=Doce+Ana+Guimarães'">
                    <div class="p-4 flex flex-col flex-grow justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 leading-tight mb-2">${product.nome}</h3>
                            <p class="text-gray-600 text-sm mb-3">${product.descricao || 'Delicioso produto da Ana Guimarães Doceria'}</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-lg font-bold text-pink-600">R$ ${product.preco?.toFixed(2) || '0,00'}</span>
                            <button class="bg-pink-600 text-white font-bold py-2 px-4 rounded-md hover:bg-pink-700 transition-colors ${isOutOfStock ? 'cursor-not-allowed bg-gray-300' : ''}" 
                                    onclick="addToCart('${product.id}')" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Esgotado' : 'Adicionar'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funções do Carrinho
        window.addToCart = (productId) => {
            const product = allProducts.find(p => p.id === productId); 
            if (!product) {
                showToast('Produto não encontrado!', true);
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            if (product.estoque !== null && (existingItem?.quantity || 0) >= product.estoque) { 
                showToast('Quantidade máxima em estoque atingida!', true); 
                return; 
            }
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ 
                    id: product.id,
                    nome: product.nome,
                    preco: product.preco,
                    quantity: 1 
                });
            }
            
            renderCart();
            showToast(`${product.nome} adicionado ao carrinho!`);
        };

        window.removeFromCart = (productId) => { 
            cart = cart.filter(item => item.id !== productId); 
            renderCart(); 
            showToast('Item removido do carrinho', true);
        };

        window.updateQuantity = (productId, change) => {
            const item = cart.find(item => item.id === productId); 
            if (!item) return;
            
            if (change > 0) { 
                const product = allProducts.find(p => p.id === productId); 
                if (product.estoque !== null && item.quantity >= product.estoque) { 
                    showToast('Quantidade máxima em estoque atingida!', true); 
                    return; 
                } 
            }
            
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
        };

        function renderCart() {
            cartItemsContainer.innerHTML = cart.length === 0 
                ? '<p class="text-gray-500 text-center py-8">Seu carrinho está vazio.</p>' 
                : cart.map(item => `
                    <div class="flex justify-between items-center mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${item.nome}</p>
                            <p class="text-sm text-gray-500">R$ ${item.preco.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center" 
                                    onclick="updateQuantity('${item.id}', -1)">-</button>
                            <span class="font-semibold min-w-8 text-center">${item.quantity}</span>
                            <button class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center" 
                                    onclick="updateQuantity('${item.id}', 1)">+</button>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 ml-2">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            
            updateCartInfo();
        }

		function updateCartInfo() {
			const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			const desconto = appliedCupom?.valorDesconto || 0;
			const total = subtotal - desconto + valorFrete;
			
			cartCount.textContent = totalItems;
			cartSubtotal.textContent = `R$ ${subtotal.toFixed(2)}`;
			cartTotal.textContent = `R$ ${total.toFixed(2)}`;
			
			if (desconto > 0) {
				cartDiscount.textContent = `- R$ ${desconto.toFixed(2)}`;
				cartDiscountLine.classList.remove('hidden');
			} else {
				cartDiscountLine.classList.add('hidden');
			}
			
			// Modificação aqui: só mostra frete se for maior que zero
			if (valorFrete > 0) {
				cartShipping.textContent = `R$ ${valorFrete.toFixed(2)}`;
				cartShippingLine.classList.remove('hidden');
			} else {
				cartShipping.textContent = `R$ 0,00`;
				cartShippingLine.classList.add('hidden');
			}
		}


        // Funções de Navegação
        function setupScrollSpy() {
            const sections = document.querySelectorAll('#product-list section');
            const navLinks = document.querySelectorAll('#subcategory-nav a');
            
            if (sections.length === 0 || navLinks.length === 0) return;
            
            const observer = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    if (entry.isIntersecting && entry.target.id) { 
                        navLinks.forEach(link => { 
                            const targetId = (link.getAttribute('href') || '').substring(1);
                            link.classList.toggle('active', targetId === entry.target.id);
                            if (targetId === entry.target.id) {
                                link.style.color = '#db2777';
                                link.style.borderBottomColor = '#db2777';
                            } else {
                                link.style.color = '';
                                link.style.borderBottomColor = '';
                            }
                        }); 
                    } 
                }); 
            }, { rootMargin: '-150px 0px -50% 0px', threshold: 0.1 });
            
            sections.forEach(section => observer.observe(section));
        }

        // Toast Notifications
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { 
                toast.classList.remove('opacity-0', 'translate-y-2'); 
            }, 10);
            setTimeout(() => { 
                toast.classList.add('opacity-0', 'translate-y-2'); 
                setTimeout(() => toast.classList.add('hidden'), 500); 
            }, 3000);
        }

        // Event Listeners
        function setupEventListeners() {
            cartButton.addEventListener('click', () => cartModal.classList.remove('hidden'));
            closeCartButton.addEventListener('click', () => cartModal.classList.add('hidden'));
            
            checkoutButton.addEventListener('click', () => { 
                if (cart.length === 0) { 
                    showToast('Seu carrinho está vazio!', true); 
                    return; 
                } 
                cartModal.classList.add('hidden'); 
                identificationModal.classList.remove('hidden'); 
            });
            
            closeIdentificationModal.addEventListener('click', () => identificationModal.classList.add('hidden'));
            
            usePhoneButton.addEventListener('click', () => { 
                identificationModal.classList.add('hidden'); 
                phoneLoginModal.classList.remove('hidden'); 
                phoneInput.value = ''; 
                phoneError.classList.add('hidden'); 
            });
            
            closePhoneLoginModal.addEventListener('click', () => { 
                phoneLoginModal.classList.add('hidden'); 
                currentClient = null; 
            });

            continueGuestButton.addEventListener('click', () => { 
                identificationModal.classList.add('hidden'); 
                updateGuestSummary(); 
                guestInfoModal.classList.remove('hidden'); 
            });

            closeGuestInfoModal.addEventListener('click', () => guestInfoModal.classList.add('hidden'));

            searchPhoneButton.addEventListener('click', handlePhoneSearch);

            // Endereços
            document.getElementById('show-new-address-btn').addEventListener('click', showNewAddressSection);
            document.getElementById('cancel-new-address-button').addEventListener('click', cancelNewAddress);
            document.getElementById('save-manual-address-button').addEventListener('click', saveManualAddress);

            // Fechar modais
            closeAddressManagementModal.addEventListener('click', () => { 
                addressManagementModal.classList.add('hidden'); 
                currentClient = null; 
            });

            closePaymentModal.addEventListener('click', () => paymentModal.classList.add('hidden'));
            backToAddressButton.addEventListener('click', () => { 
                paymentModal.classList.add('hidden'); 
                addressManagementModal.classList.remove('hidden'); 
            });

            // Finalização
            sendWhatsappButton.addEventListener('click', handleGuestOrder);
            confirmOrderButton.addEventListener('click', handlePlatformOrder);

            closeConfirmationButton.addEventListener('click', () => { 
                confirmationModal.classList.add('hidden'); 
                location.reload(); 
            });
            closePlatformConfirmationButton.addEventListener('click', () => { 
                platformConfirmationModal.classList.add('hidden'); 
                location.reload(); 
            });

            // Cupons
            guestVerifyCupomButton.addEventListener('click', () => handleVerifyCupom('guest'));
            paymentVerifyCupomButton.addEventListener('click', () => handleVerifyCupom('payment'));
        }

        // Funções de Endereço
        function showNewAddressSection() {
            document.getElementById('new-address-section').classList.remove('hidden');
            document.getElementById('show-new-address-btn').classList.add('hidden');
        }

        function cancelNewAddress() {
            document.getElementById('new-address-section').classList.add('hidden');
            document.getElementById('show-new-address-btn').classList.remove('hidden');
        }

        async function saveManualAddress() {
            const nickname = document.getElementById('manual-address-nickname').value.trim();
            const address = document.getElementById('manual-address-input').value.trim();
            const number = document.getElementById('manual-address-number').value.trim();
            const complement = document.getElementById('manual-address-complement').value.trim();
            const neighborhood = document.getElementById('manual-address-neighborhood').value.trim();
            const city = document.getElementById('manual-address-city').value.trim();
            const zip = document.getElementById('manual-address-zip').value.trim();

            if (!address || !nickname) {
                showToast("Preencha o endereço (buscando no mapa) e o apelido.", true);
                return;
            }

            const addressText = `${address}${number ? ', ' + number : ''}${complement ? ' - ' + complement : ''}${neighborhood ? ', ' + neighborhood : ''}${city ? ', ' + city : ''}${zip ? ' - CEP: ' + zip : ''}`;

            try {
                const { db, doc, getDoc, updateDoc } = await import('./firebaseClientConfig.js');
                const clientDocRef = doc(db, "clientes", currentClient.id);
                const clientDoc = await getDoc(clientDocRef);
                const existingAddresses = clientDoc.exists() ? (clientDoc.data().enderecos || []) : [];

                const newAddress = {
                    enderecoCompleto: addressText,
                    nickname: nickname,
                    lat: window.currentLatLng.lat,
                    lng: window.currentLatLng.lng,
                    criadoEm: new Date().toISOString()
                };

                const updatedAddresses = existingAddresses.map(addr => {
                    if (typeof addr === 'string') {
                        return {
                            enderecoCompleto: addr,
                            nickname: `Endereço ${existingAddresses.indexOf(addr) + 1}`,
                            criadoEm: new Date().toISOString()
                        };
                    }
                    return addr;
                });

                updatedAddresses.push(newAddress);
                await updateDoc(clientDocRef, { enderecos: updatedAddresses });
                
                showToast("✅ Endereço salvo com sucesso!");
                cancelNewAddress();
                openAddressManagementModal({ ...currentClient, enderecos: updatedAddresses });

            } catch (error) {
                console.error("Erro ao salvar endereço:", error);
                showToast("❌ Erro ao salvar endereço. Tente novamente.", true);
            }
        }

		function openAddressManagementModal(client) {
			console.log("Abrindo modal de endereços para:", client);
			currentClient = client;
			addressList.innerHTML = '';
			
			if (confirmCustomerName) {
				confirmCustomerName.textContent = client.nome || 'Cliente';
			}
			
			document.getElementById('new-address-section').classList.add('hidden');
			document.getElementById('show-new-address-btn').classList.remove('hidden');
			
			if (client.enderecos && client.enderecos.length > 0) {
				client.enderecos.forEach((address, index) => {
					let addressText, nickname;
					
					if (typeof address === 'string') {
						addressText = address;
						nickname = `Endereço ${index + 1}`;
					} else if (address.enderecoCompleto) {
						addressText = address.enderecoCompleto;
						nickname = address.nickname || `Endereço ${index + 1}`;
					} else {
						addressText = String(address);
						nickname = `Endereço ${index + 1}`;
					}
					
					const addressDiv = document.createElement('div');
					addressDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow mb-4';
					addressDiv.innerHTML = `
						<div class="flex items-center justify-between gap-2 mb-2">
							<span class="bg-pink-100 text-pink-800 text-xs font-medium px-2 py-1 rounded">${nickname}</span>
							<button class="text-red-500 hover:text-red-700 transition-colors delete-address-btn" title="Excluir endereço">
								<i class="fa-solid fa-trash-alt text-lg"></i>
							</button>
						</div>
						<p class="text-gray-800 font-medium text-sm leading-tight">${addressText}</p>
						<button class="w-full mt-3 bg-pink-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-pink-700 transition-colors flex items-center justify-center gap-2 use-address-btn">
							<i class="fa-solid fa-truck"></i>
							Usar este Endereço
						</button>
					`;

					
					// Evento para usar o endereço (já existe)
					addressDiv.querySelector('.use-address-btn').onclick = () => useExistingAddress(addressText, address);

					// NOVO: Evento para deletar o endereço
					addressDiv.querySelector('.delete-address-btn').onclick = (e) => {
						e.stopPropagation(); // Evita que o clique se propague
						deleteAddress(index);
					};

					addressList.appendChild(addressDiv);

				});
			} else {
				addressList.innerHTML = `
					<div class="text-center py-8 bg-gray-50 rounded-lg">
						<i class="fa-solid fa-map-marker-alt text-4xl text-gray-300 mb-3"></i>
						<p class="text-gray-500">Nenhum endereço cadastrado ainda.</p>
						<p class="text-sm text-gray-400 mt-1">Adicione seu primeiro endereço abaixo!</p>
					</div>
				`;
			}
			
			addressManagementModal.classList.remove('hidden');
		}
		
		// Função para deletar endereço
		async function deleteAddress(addressIndex) {
			// Confirmação antes de deletar
			const confirmDelete = confirm('Tem certeza que deseja excluir este endereço?');
			if (!confirmDelete) return;

			try {
				const { db, doc, getDoc, updateDoc } = await import('./firebaseClientConfig.js');
				
				// Buscar documento do cliente
				const clientDocRef = doc(db, 'clientes', currentClient.id);
				const clientDoc = await getDoc(clientDocRef);
				
				if (!clientDoc.exists()) {
					throw new Error('Cliente não encontrado');
				}

				// Remover o endereço do array
				const existingAddresses = clientDoc.data().enderecos || [];
				existingAddresses.splice(addressIndex, 1);

				// Atualizar no Firebase
				await updateDoc(clientDocRef, {
					enderecos: existingAddresses
				});

				showToast('Endereço excluído com sucesso!');
				
				// Atualizar a lista de endereços na tela
				openAddressManagementModal({
					...currentClient,
					enderecos: existingAddresses
				});

			} catch (error) {
				console.error('Erro ao deletar endereço:', error);
				showToast('Erro ao excluir endereço. Tente novamente.', true);
			}
		}


		async function useExistingAddress(addressText, addressData) {
			pendingOrderDetails = {
				clienteId: currentClient.id,
				clienteNome: currentClient.nome,
				clienteEndereco: addressText,
				telefone: currentClient.telefone
			};

			selectedAddressText.textContent = addressText;
			addressManagementModal.classList.add('hidden');

			// Calcular frete se houver lat/lng
			if (addressData?.lat && addressData?.lng) {
				try {
					console.log('🔄 Aguardando Google Maps carregar...');
					await aguardarGoogleMaps();
					
					console.log('🔄 Calculando frete para endereço selecionado...');
					const resultado = await calcularFreteParaEndereco({ 
						lat: parseFloat(addressData.lat), 
						lng: parseFloat(addressData.lng) 
					});
					
					valorFrete = parseFloat(resultado.valorFrete);
					console.log('✅ Frete calculado com sucesso: R$', valorFrete.toFixed(2));
					
					updateCartInfo();
					updatePaymentSummary();
					showToast(`Frete calculado: R$ ${valorFrete.toFixed(2)}`);
				} catch (error) {
					console.error('❌ Erro ao calcular frete:', error);
					showToast('Não foi possível calcular o frete. Continuando sem frete.', true);
					valorFrete = 0;
					updateCartInfo();
					updatePaymentSummary();
				}
			} else {
				console.warn('⚠️ Endereço não possui coordenadas');
				valorFrete = 0;
				updateCartInfo();
				updatePaymentSummary();
			}

			paymentModal.classList.remove('hidden');
			updatePaymentSummary();
		}



        // Funções de Busca de Cliente
        async function handlePhoneSearch() {
            const phone = phoneInput.value.trim();
            const phoneDigits = phone.replace(/\D/g, ''); 
            
            if (phoneDigits.length < 10) {
                phoneError.textContent = 'Digite um número válido com DDD';
                phoneError.classList.remove('hidden');
                return;
            }

            phoneError.classList.add('hidden');
            searchPhoneButton.disabled = true;
            searchPhoneButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div> Buscando...';
            
            try {
                const { db, collection, getDocs, query, where } = await import('./firebaseClientConfig.js');
                const q = query(collection(db, "clientes"), where("telefone", "==", phoneDigits));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const clientDoc = querySnapshot.docs[0];
                    currentClient = { id: clientDoc.id, ...clientDoc.data() };
                    console.log("✅ Cliente encontrado:", currentClient);
                    
                    openAddressManagementModal(currentClient);
                    phoneLoginModal.classList.add('hidden');
                    
                } else {
                    const createNew = confirm("Cliente não encontrado. Deseja criar um novo cadastro?");
                    if (createNew) {
                        const { addDoc, collection } = await import('./firebaseClientConfig.js');
                        const newClient = {
                            nome: `Cliente ${phoneDigits.slice(-4)}`,
                            telefone: phoneDigits,
                            enderecos: []
                        };
                        const docRef = await addDoc(collection(db, "clientes"), newClient);
                        currentClient = { id: docRef.id, ...newClient };
                        showToast("Novo cliente criado!");
                        openAddressManagementModal(currentClient);
                    }
                    phoneLoginModal.classList.add('hidden');
                }
                
            } catch (error) { 
                console.error("Error searching client:", error);
                phoneError.textContent = 'Erro ao buscar cliente. Tente novamente.'; 
                phoneError.classList.remove('hidden'); 
            } finally {
                searchPhoneButton.disabled = false;
                searchPhoneButton.textContent = 'Buscar';
            }
        }

        // Funções de Resumo
        function updateAllSummaries() { 
            updateCartInfo(); 
            updatePaymentSummary(); 
            updateGuestSummary(); 
        }

		function updatePaymentSummary() {
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			let discount = appliedCupom?.valorDesconto || 0;
			let total = subtotal - discount + valorFrete;
			
			document.getElementById('payment-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
			document.getElementById('payment-total').textContent = `R$ ${total.toFixed(2)}`;
			
			document.getElementById('payment-discount-row').classList.toggle('hidden', discount === 0);
			if (discount > 0) {
				document.getElementById('payment-discount').textContent = `- R$ ${discount.toFixed(2)}`;
			}
			
			// Modificação aqui
			if (valorFrete > 0) {
				document.getElementById('payment-shipping').textContent = `R$ ${valorFrete.toFixed(2)}`;
				document.getElementById('payment-shipping-row').classList.remove('hidden');
			} else {
				document.getElementById('payment-shipping').textContent = `R$ 0,00`;
				document.getElementById('payment-shipping-row').classList.add('hidden');
			}
		}


		function updateGuestSummary() {
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			let discount = appliedCupom?.valorDesconto || 0;
			let total = subtotal - discount + valorFrete;
			
			document.getElementById('guest-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
			document.getElementById('guest-total').textContent = `R$ ${total.toFixed(2)}`;
			
			document.getElementById('guest-discount-row').classList.toggle('hidden', discount === 0);
			if (discount > 0) {
				document.getElementById('guest-discount').textContent = `- R$ ${discount.toFixed(2)}`;
			}
			
			// Modificação aqui
			if (valorFrete > 0) {
				document.getElementById('guest-shipping').textContent = `R$ ${valorFrete.toFixed(2)}`;
				document.getElementById('guest-shipping-row').classList.remove('hidden');
			} else {
				document.getElementById('guest-shipping').textContent = `R$ 0,00`;
				document.getElementById('guest-shipping-row').classList.add('hidden');
			}
		}

        // Funções de Cupom
        async function handleVerifyCupom(type) {
            const cupomInput = type === 'guest' ? guestCupomInput : paymentCupomInput;
            const cupomMessage = type === 'guest' ? guestCupomMessage : paymentCupomMessage;
            const verifyButton = type === 'guest' ? guestVerifyCupomButton : paymentVerifyCupomButton;
            
            if (appliedCupom) { 
                removeCupom(); 
                return; 
            }
            
            const codigo = cupomInput.value.trim().toUpperCase(); 
            if (!codigo) { 
                showToast('Digite um cupom.', true); 
                return; 
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0); 
            if (subtotal <= 0) { 
                showToast('Adicione itens ao carrinho.', true); 
                return; 
            }
            
            verifyButton.disabled = true; 
            verifyButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div>';
            
            try {
                const { db, collection, getDocs, query, where } = await import('./firebaseClientConfig.js');
                const q = query(collection(db, "cupons"), where("codigo", "==", codigo));
                const cupomSnapshot = await getDocs(q);
                
                if (cupomSnapshot.empty) throw new Error('Cupom inválido.');
                
                const cupomDoc = cupomSnapshot.docs[0];
                const cupom = { id: cupomDoc.id, ...cupomDoc.data() };

                if (cupom.status !== 'Ativo') throw new Error('Cupom inativo.');
                if (subtotal < (cupom.valorMinimo || 0)) throw new Error(`Pedido mínimo de R$ ${cupom.valorMinimo.toFixed(2)}.`);
                
                appliedCupom = cupom;
                const valorDesconto = cupom.tipoDesconto === 'percentual' ? (subtotal * cupom.valor) / 100 : cupom.valor;
                appliedCupom.valorDesconto = valorDesconto;
                
                cupomMessage.textContent = `Cupom "${appliedCupom.codigo}" aplicado!`; 
                cupomMessage.className = 'text-sm text-green-600';
                cupomInput.value = appliedCupom.codigo; 
                cupomInput.disabled = true;
                verifyButton.textContent = 'Remover'; 
                verifyButton.classList.replace('bg-gray-600', 'bg-red-600');
                showToast('Cupom aplicado!'); 
                updateAllSummaries();

            } catch (error) { 
                cupomMessage.textContent = error.message; 
                cupomMessage.className = 'text-sm text-red-500'; 
                appliedCupom = null;
            } finally { 
                verifyButton.disabled = false; 
                if(!appliedCupom) { 
                    verifyButton.innerHTML = 'Aplicar'; 
                } else { 
                    verifyButton.innerHTML = 'Remover'; 
                } 
            }
        }

        function removeCupom() {
            if (appliedCupom) {
                showToast('Cupom removido.');
                appliedCupom = null;
            }
            [guestCupomInput, paymentCupomInput].forEach(input => { 
                input.value = ''; 
                input.disabled = false; 
            });
            [guestVerifyCupomButton, paymentVerifyCupomButton].forEach(btn => { 
                btn.textContent = 'Aplicar'; 
                btn.classList.replace('bg-red-600', 'bg-gray-600'); 
            });
            [guestCupomMessage, paymentCupomMessage].forEach(msg => { 
                msg.textContent = ''; 
            });
            updateAllSummaries();
        }

        // Funções de Finalização de Pedido
		async function handleGuestOrder() {
			const name = guestNameInput.value.trim();
			const address = guestAddressInput.value.trim();
			const phone = guestPhoneInput.value.trim();
			const paymentMethod = guestPaymentMethodSelect.value;
			
			if (!name || !address || !phone || !paymentMethod) {
				showToast('Preencha todos os campos.', true);
				return;
			}
			
			sendWhatsappButton.disabled = true;
			sendWhatsappButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processando...';
			
			try {
				// Aguardar Google Maps e tentar calcular frete
				await aguardarGoogleMaps();
				
				if (window.google?.maps && window.dadosFrete) {
					console.log('🔄 Tentando geocodificar endereço do visitante...');
					const geocoder = new google.maps.Geocoder();
					
					try {
						const geocodeResult = await new Promise((resolve, reject) => {
							geocoder.geocode({ address: address }, (results, status) => {
								if (status === 'OK' && results[0]) {
									resolve(results[0]);
								} else {
									reject(status);
								}
							});
						});
						
						const location = geocodeResult.geometry.location;
						console.log('✅ Endereço geocodificado:', location.lat(), location.lng());
						
						const resultado = await calcularFreteParaEndereco({ 
							lat: location.lat(), 
							lng: location.lng() 
						});
						
						valorFrete = parseFloat(resultado.valorFrete);
						console.log('✅ Frete calculado para visitante: R$', valorFrete.toFixed(2));
						updateGuestSummary();
					} catch (geocodeError) {
						console.warn('⚠️ Não foi possível geocodificar o endereço:', geocodeError);
						valorFrete = 0;
						updateGuestSummary();
					}
				}
				
				// Finalizar pedido
				await finalizeOrder({
					clienteNome: name,
					clienteEndereco: address,
					telefone: phone,
					formaPagamento: paymentMethod
				}, null, false);
				
			} catch (error) {
				console.error('❌ Erro ao processar pedido:', error);
				showToast('Erro ao processar o pedido.', true);
				sendWhatsappButton.disabled = false;
				sendWhatsappButton.innerHTML = '<i class="fa-brands fa-whatsapp"></i> Enviar Pedido';
			}
		}


        async function handlePlatformOrder() {
            if (!paymentMethodSelect.value) { 
                paymentError.textContent = 'Selecione uma forma de pagamento.'; 
                paymentError.classList.remove('hidden'); 
                return; 
            }
            paymentError.classList.add('hidden');
            confirmOrderButton.disabled = true;
            confirmOrderButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div> Confirmando...';
            
            try {
                const finalOrderDetails = { 
                    ...pendingOrderDetails, 
                    formaPagamento: paymentMethodSelect.value 
                };
                await finalizeOrder(finalOrderDetails, finalOrderDetails.clienteId, true);
            } catch (error) {
                console.error('Error confirming order:', error);
                showToast('Erro ao confirmar o pedido.', true);
            } finally {
                confirmOrderButton.disabled = false;
                confirmOrderButton.textContent = 'Confirmar Pedido';
            }
        }

        async function finalizeOrder(clientInfo, clientId, isPlatform) {
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            let cupomData = null;
            if(appliedCupom && subtotal >= (appliedCupom.valorMinimo || 0)) {
                let valorDesconto = appliedCupom.tipoDesconto === 'percentual' ? (subtotal * appliedCupom.valor) / 100 : appliedCupom.valor;
                cupomData = {
                    codigo: appliedCupom.codigo,
                    valorDesconto: valorDesconto
                };
            }
            const desconto = cupomData?.valorDesconto || 0;
            const total = subtotal - desconto + valorFrete;
            
            const { db, collection, addDoc, serverTimestamp } = await import('./firebaseClientConfig.js');
            
            const orderData = {
                clienteId: clientId,
                clienteNome: clientInfo.clienteNome,
                clienteEndereco: clientInfo.clienteEndereco,
                telefone: clientInfo.telefone,
                formaPagamento: clientInfo.formaPagamento,
                itens: cart.map(item => ({ produtoId: item.id, nome: item.nome, quantity: item.quantity, preco: item.preco })),
                subtotal: subtotal,
                desconto: desconto,
                valorFrete: valorFrete,
                total: total,
                cupom: cupomData,
                status: 'Pendente',
                origem: isPlatform ? 'Plataforma' : 'Cardapio Online',
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, "pedidos"), orderData);
                
                if (!isPlatform) {
                    let message = `Olá! *Novo Pedido* 🎂 (Nº ${docRef.id.substring(0, 5)})\n\n*Itens:*\n${cart.map(item => `• ${item.quantity}x ${item.nome}`).join('\n')}\n\n*Resumo:*\nSubtotal: R$ ${subtotal.toFixed(2)}\n`;
                    if (cupomData) message += `Desconto (${cupomData.codigo}): -R$ ${desconto.toFixed(2)}\n`;
                    message += `Frete: R$ ${valorFrete.toFixed(2)}\n*Total: R$ ${total.toFixed(2)}*\n\n*Dados:*\nNome: ${clientInfo.clienteNome}\nTelefone: ${clientInfo.telefone}\nEndereço: ${clientInfo.clienteEndereco}\nPagamento: ${clientInfo.formaPagamento}\n\n_Pedido enviado via Cardápio Online_`;
                    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
                    confirmationModal.classList.remove('hidden');
                } else {
                    platformConfirmationModal.classList.remove('hidden');
                }
                
                // Limpar carrinho
                cart = []; 
                currentClient = null; 
                pendingOrderDetails = {}; 
                removeCupom(); 
                renderCart();
                
            } catch (error) {
                console.error("Error saving order:", error);
                showToast('Erro ao confirmar o pedido. Tente novamente.', true);
            }
        }

        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
	

	<script type="module">
		import { db, doc, getDoc } from './firebaseClientConfig.js';

	let valorPorKM = 0;
	let pontoPartida = null;

	// 🔸 Carrega configurações de frete da loja no Firestore
	async function carregarConfiguracoesFrete() {
		const docRef = doc(db, 'config_loja', 'frete');
		const snapshot = await getDoc(docRef);
		if (snapshot.exists()) {
			const data = snapshot.data();
			valorPorKM = parseFloat(data.valorPorKM);
			pontoPartida = { lat: data.latitude, lng: data.longitude };
		} else {
			console.warn('Configurações de frete não encontradas.');
		}
	}

	// 🔸 Atualiza UI do carrinho com o valor de frete
	function atualizarFreteNoCarrinho(valorFrete) {
		const shippingLine = document.getElementById('shipping-line');
		const cartShipping = document.getElementById('cart-shipping');
		const cartTotal = document.getElementById('cart-total');
		const cartSubtotal = document.getElementById('cart-subtotal');

		shippingLine.classList.remove('hidden');
		cartShipping.textContent = `R$ ${valorFrete.toFixed(2)}`;

		const subtotal = parseFloat(cartSubtotal.textContent.replace('R$', '').replace(',', '.')) || 0;
		const total = subtotal + valorFrete;
		cartTotal.textContent = `R$ ${total.toFixed(2)}`;
	}

	// 🔸 Inicializa
	document.addEventListener('DOMContentLoaded', async () => {
		document.getElementById('shipping-line').classList.add('hidden');
		document.getElementById('cart-shipping').textContent = 'R$ 0,00';

		await carregarConfiguracoesFrete();

		// Exemplo: depois de selecionar endereço real do cliente
		window.aplicarFreteEndereco = async (lat, lng) => {
			const valorFrete = await calcularFreteParaEndereco({ lat, lng });
			atualizarFreteNoCarrinho(valorFrete);
		};
	});
	</script>

	<script>
	// ==================== CÁLCULO DE FRETE - VERSÃO ÚNICA ====================

	// Função auxiliar para aguardar o Google Maps carregar
	function aguardarGoogleMaps() {
		return new Promise((resolve) => {
			if (window.google && window.google.maps) {
				console.log('✅ Google Maps já está carregado');
				resolve();
			} else {
				console.log('⏳ Aguardando Google Maps carregar...');
				const checkInterval = setInterval(() => {
					if (window.google && window.google.maps) {
						console.log('✅ Google Maps carregado com sucesso');
						clearInterval(checkInterval);
						resolve();
					}
				}, 100);
				
				// Timeout de 10 segundos
				setTimeout(() => {
					console.warn('⚠️ Timeout ao aguardar Google Maps');
					clearInterval(checkInterval);
					resolve();
				}, 10000);
			}
		});
	}

	// Função para calcular frete usando Google Distance Matrix API
	async function calcularFreteParaEndereco(destinoLatLng) {
		console.log('🚚 Iniciando cálculo de frete...');
		console.log('📍 Destino:', destinoLatLng);
		console.log('⚙️ Dados de frete disponíveis:', window.dadosFrete);
		
		return new Promise((resolve, reject) => {
			// Verificar se as configurações de frete estão carregadas
			if (!window.dadosFrete) {
				console.error('❌ Configurações de frete não carregadas');
				return reject('Configurações de frete ainda não carregadas');
			}
			
			// Verificar se o Google Maps está disponível
			if (!window.google || !window.google.maps) {
				console.error('❌ Google Maps não está carregado');
				return reject('Google Maps ainda não foi carregado');
			}
			
			const loja = {
				lat: parseFloat(window.dadosFrete.lat),
				lng: parseFloat(window.dadosFrete.lng)
			};
			
			const valorPorKm = parseFloat(window.dadosFrete.valorPorKm);
			
			console.log('🏪 Endereço da loja:', loja);
			console.log('💰 Valor por KM:', valorPorKm);
			
			const service = new google.maps.DistanceMatrixService();
			service.getDistanceMatrix({
				origins: [loja],
				destinations: [destinoLatLng],
				travelMode: google.maps.TravelMode.DRIVING,
				unitSystem: google.maps.UnitSystem.METRIC
			}, (response, status) => {
				console.log('📡 Resposta do Google Maps:', status);
				
				if (status !== 'OK') {
					console.error('❌ Erro ao calcular distância:', status);
					return reject(status);
				}
				
				if (!response.rows[0] || !response.rows[0].elements[0]) {
					console.error('❌ Resposta inválida do Google Maps');
					return reject('Resposta inválida');
				}
				
				const element = response.rows[0].elements[0];
				
				if (element.status !== 'OK') {
					console.error('❌ Não foi possível calcular a rota:', element.status);
					return reject(element.status);
				}
				
				const distanceMeters = element.distance.value;
				const distanceKm = distanceMeters / 1000
				let valorFrete = (distanceKm * valorPorKm).toFixed(2)

				// Aplicar valor mínimo de frete de R$ 2,00
				if (parseFloat(valorFrete) < 2) {
					valorFrete = '2.00'
					console.log('Frete ajustado para o valor mínimo de R$ 2,00')
				}

				console.log('Distância calculada:', distanceKm.toFixed(2), 'km')
				console.log('Valor do frete:', 'R$', valorFrete)

				resolve({
					distanciaKm: distanceKm.toFixed(2),
					valorFrete: valorFrete
				});
			});
		});
	}

	console.log('✅ Módulo de cálculo de frete carregado');
	</script>

</body>
</html>

