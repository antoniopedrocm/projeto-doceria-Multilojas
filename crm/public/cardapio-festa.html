<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Ana Guimarães Doceria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	<link rel="icon" type="image/png" href="/logo.png" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body { font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; scroll-padding-top: 140px; }
        
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #db2777;
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        #toast { transition: opacity 0.5s, transform 0.5s; }
        #subcategory-nav a.active { 
            color: #db2777;
            border-bottom-color: #db2777;
        }
        #subcategory-nav::-webkit-scrollbar { display: none; }
        #subcategory-nav { -ms-overflow-style: none; scrollbar-width: none; }
        .map-placeholder { height: 300px; width: 100%; border-radius: 0.5rem; background-color: #f9fafb; display: flex; align-items: center; justify-content: center; color: #6b7280; }
		
		/* ===== RESPONSIVIDADE MOBILE ===== */

		/* Layout responsivo para produtos */
		@media (max-width: 768px) {
			/* Ajuste do container principal */
			#product-list {
				padding: 0 1rem;
			}
			
			/* Layout dos cards de produto em lista vertical */
			#product-list > div > div[class*="grid"] {
				display: flex !important;
				flex-direction: column !important;
				gap: 1rem !important;
			}
			
			/* Card individual do produto - layout horizontal */
			#product-list div[class*="grid"] > div {
				display: flex !important;
				flex-direction: row !important;
				align-items: flex-start !important;
				background: white;
				border-radius: 8px;
				padding: 0.75rem;
				box-shadow: 0 1px 3px rgba(0,0,0,0.1);
				gap: 0.75rem;
				min-height: 120px;
			}
			
			/* Imagem do produto - tamanho fixo à esquerda */
			#product-list div[class*="grid"] > div img {
				width: 100px !important;
				min-width: 100px !important;
				height: 100px !important;
				object-fit: cover !important;
				border-radius: 8px !important;
				flex-shrink: 0;
			}
			
			/* Container de informações do produto */
			#product-list div[class*="grid"] > div > div {
				display: flex !important;
				flex-direction: column !important;
				justify-content: space-between !important;
				flex: 1;
				min-height: 100px;
			}
			
			/* Título do produto */
			#product-list div[class*="grid"] > div h3,
			#product-list div[class*="grid"] > div h2 {
				font-size: 1rem !important;
				line-height: 1.3 !important;
				font-weight: 600 !important;
				margin: 0 0 0.35rem 0 !important;
				color: #1f2937;
			}
			
			/* Descrição do produto */
			#product-list div[class*="grid"] > div p {
				font-size: 0.813rem !important;
				line-height: 1.4 !important;
				color: #6b7280 !important;
				margin: 0 0 0.5rem 0 !important;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
			}
			
			/* Preço do produto */
			#product-list div[class*="grid"] > div span[class*="text"],
			#product-list div[class*="grid"] > div div[class*="text"] {
				font-size: 1.125rem !important;
				font-weight: 700 !important;
				color: #db2777 !important;
				margin-top: auto;
			}
			
			/* Botão de adicionar ao carrinho */
			#product-list div[class*="grid"] > div button {
				margin-top: 0.5rem !important;
				padding: 0.5rem 1rem !important;
				font-size: 0.875rem !important;
				width: 100% !important;
			}
			
			/* Ajuste do header para mobile */
			header {
				padding: 0.75rem 1rem !important;
			}
			
			/* Logo menor em mobile */
			header img {
				max-height: 40px !important;
			}
			
			/* Barra de busca em mobile */
			header input[type="text"],
			header input[type="search"] {
				font-size: 0.875rem !important;
				padding: 0.5rem !important;
			}
			
			/* Menu de categorias horizontal scrollável */
			#subcategory-nav {
				padding: 0.75rem 1rem !important;
				gap: 1rem !important;
			}
			
			#subcategory-nav a {
				font-size: 0.875rem !important;
				padding: 0.5rem 0 !important;
				white-space: nowrap;
			}
			
			/* Espaçamento entre seções */
			#product-list > div {
				margin-bottom: 1.5rem !important;
			}
			
			/* Título das categorias */
			#product-list h2 {
				font-size: 1.25rem !important;
				padding: 0 0 0.75rem 0 !important;
				margin-bottom: 0.75rem !important;
			}
			
			/* Carrinho de compras mobile */
			#cart-button {
				padding: 0.5rem !important;
				font-size: 0.875rem !important;
			}
			
			/* Modal do carrinho em mobile */
			#cart-modal > div {
				max-width: 95% !important;
				margin: 1rem !important;
			}
		}

		/* Ajustes extras para telas muito pequenas */
		@media (max-width: 380px) {
			/* Imagem ainda menor em telas pequenas */
			#product-list div[class*="grid"] > div img {
				width: 85px !important;
				min-width: 85px !important;
				height: 85px !important;
			}
			
			/* Título menor */
			#product-list div[class*="grid"] > div h3,
			#product-list div[class*="grid"] > div h2 {
				font-size: 0.938rem !important;
			}
			
			/* Descrição menor */
			#product-list div[class*="grid"] > div p {
				font-size: 0.75rem !important;
			}
			
			/* Preço mantém destaque */
			#product-list div[class*="grid"] > div span[class*="text"] {
				font-size: 1rem !important;
			}
		}

    </style>
	
	<!-- Google Maps API -->
	<script 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUiV11tfJJySiaunNXWhbrhtpDPlMmx8k&libraries=places,marker&v=weekly"
		async defer></script>
		
</head>
<body class="bg-pink-50">
    <!-- CABEÇALHO -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="/logotipo.png" alt="Logotipo" class="h-10">
                <h1 class="text-2xl font-bold text-pink-600">Nosso Cardápio</h1>
            </div>
            <button id="cart-button" class="relative">
                <i class="fa-solid fa-shopping-cart text-2xl text-gray-600"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </header>
    
    <!-- NAVEGAÇÃO DE SUBCATEGORIAS -->
    <nav id="subcategory-nav-container" class="bg-white sticky top-[72px] z-10 shadow-sm">
        <div id="subcategory-nav" class="container mx-auto px-6 flex items-center space-x-6 overflow-x-auto whitespace-nowrap"></div>
    </nav>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="container mx-auto px-6 py-8">
        <div id="product-list" class="space-y-12">
            <div id="loading-message" class="col-span-full flex flex-col items-center justify-center py-16">
                <div class="loader"></div>
                <p class="text-pink-600 mt-4">Carregando nosso cardápio...</p>
            </div>
        </div>
    </main>

    <!-- MODAIS -->

    <!-- Modal do Carrinho -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Seu Pedido</h2>
                <button id="close-cart" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="cart-items" class="p-6 max-h-80 overflow-y-auto"></div>
            <div class="p-6 border-t space-y-4">
                <div id="cart-summary" class="space-y-1 text-gray-700">
                    <div class="flex justify-between"><span>Subtotal:</span><span id="cart-subtotal">R$ 0,00</span></div>
                    <div id="discount-line" class="flex justify-between text-green-600 hidden"><span>Desconto:</span><span id="cart-discount"></span></div>
                    <div id="shipping-line" class="flex justify-between hidden"><span>Frete:</span><span id="cart-shipping">R$ 0,00</span></div>
                    <div class="flex justify-between items-center font-bold text-xl"><span>Total:</span><span id="cart-total">R$ 0,00</span></div>
                </div>
                <button id="checkout-button" class="w-full bg-pink-600 text-white py-3 rounded-lg mt-2 font-bold hover:bg-pink-700 transition-colors">Finalizar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Identificação -->
    <div id="identification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Como deseja continuar?</h2>
            <p class="text-gray-600 mb-6">Você pode buscar seu cadastro ou continuar como visitante.</p>
            <div class="space-y-4">
                <button id="use-phone-button" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-mobile-screen-button"></i> Usar número de celular
                </button>
                <button id="continue-guest-button" class="w-full bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors">Continuar sem cadastro</button>
                <button id="close-identification-modal" class="text-sm text-gray-500 mt-4 hover:underline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Login com Telefone -->
    <div id="phone-login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Identificar Cliente</h2>
                <button id="close-phone-login-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Digite seu número de celular para buscar seu cadastro.</p>
                <input id="phone-input" type="tel" placeholder="(00) 00000-0000" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                <p id="phone-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t">
                <button id="search-phone-button" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700 transition-colors">Buscar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Dados do Cliente (Novo/Edição) -->
    <div id="customer-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="customer-modal-title" class="text-2xl font-bold text-pink-600"></h2>
                <button id="close-customer-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="customer-form" class="space-y-4">
                    <p class="text-gray-600">Telefone: <strong id="customer-modal-phone"></strong></p>
                    <div>
                        <label for="customer-modal-name" class="block text-sm font-medium text-gray-700">Nome Completo *</label>
                        <input id="customer-modal-name" type="text" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label for="customer-modal-birthdate" class="block text-sm font-medium text-gray-700">Data de Nascimento *</label>
                        <input id="customer-modal-birthdate" type="date" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <p id="customer-modal-error" class="text-red-500 text-sm hidden"></p>
                </form>
            </div>
            <div id="customer-modal-footer" class="p-6 border-t flex gap-3">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

	<!-- Modal de Gerenciamento de Endereço -->
	<div id="address-management-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
		<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
			<div class="p-6 border-b bg-white flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-pink-600">Seus Endereços</h2>
                    <p class="text-gray-600 mt-1">Olá, <strong id="confirm-customer-name"></strong>!</p>
                </div>
                <button id="edit-profile-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-600 text-sm flex items-center gap-2">
                    <i class="fa-solid fa-user-pen"></i> Editar Perfil
                </button>
            </div>
			
			<div class="p-6 overflow-y-auto flex-grow">
				<!-- Lista de Endereços Existentes -->
				<div id="address-list" class="space-y-4 mb-6">
					<!-- Endereços serão carregados aqui dinamicamente -->
				</div>

				<!-- Botão para Adicionar Novo Endereço -->
				<div class="border-t pt-6">
					<button id="show-new-address-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
						<i class="fa-solid fa-plus-circle"></i>
						Adicionar Novo Endereço
					</button>
				</div>

				<!-- Seção de Novo Endereço (inicialmente oculta) -->
				<div id="new-address-section" class="hidden mt-6 border-t pt-6">
					<h3 class="text-xl font-bold text-gray-800 mb-4">Novo Endereço</h3>
					
					<div class="space-y-4">
						<!-- Formulário de Endereço -->
						<div class="space-y-4">
							<!-- Container para o mapa e input -->
							<div id="address-map-container" class="relative">
								<!-- O mapa ou o placeholder serão inseridos aqui via JS -->
							</div>
							
							<!-- Número e Complemento -->
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Número</label>
									<input id="manual-address-number" type="text" placeholder="Número" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
									<input id="manual-address-complement" type="text" placeholder="Apto, Bloco, etc." 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
							</div>

							<!-- Bairro, Cidade e CEP -->
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Bairro *</label>
									<input id="manual-address-neighborhood" type="text" placeholder="Bairro" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
									<input id="manual-address-city" type="text" placeholder="Cidade" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors" value="Goiânia">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
									<input id="manual-address-zip" type="text" placeholder="CEP" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
							</div>
                             <!-- Endereço Completo (oculto, preenchido pelo mapa) -->
                            <input id="manual-address-input" type="hidden">
							<!-- Apelido do Endereço -->
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">Apelido do endereço *</label>
								<input id="manual-address-nickname" type="text" placeholder="Como você chama este endereço? (Ex: Casa, Trabalho)" 
									   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
							</div>
						</div>

						<!-- Botões de Ação -->
						<div class="flex gap-3 pt-4">
							<button id="save-manual-address-button" 
									class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
								<i class="fa-solid fa-save"></i>
								Salvar Endereço
							</button>
							<button id="cancel-new-address-button" 
									class="bg-gray-500 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-600 transition-colors">
								Cancelar
							</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Rodapé do Modal -->
			<div class="p-6 border-t bg-gray-50">
				<button id="close-address-management-modal" class="w-full bg-gray-500 text-white py-3 rounded-lg font-bold hover:bg-gray-600 transition-colors">
					Fechar
				</button>
			</div>
		</div>
	</div>

    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <button id="back-to-address" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-pink-600 text-center flex-grow">Forma de Pagamento</h2>
                <button id="close-payment-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm">
                    <p class="text-gray-500">Entregar em:</p>
                    <p id="selected-address-text" class="font-semibold text-gray-800"></p>
                </div>
                <div class="space-y-2 mb-4">
                    <div class="flex gap-2">
                        <input id="payment-cupom-input" type="text" placeholder="Tem um cupom?" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 uppercase">
                        <button id="payment-verify-cupom-button" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700 transition-colors flex-shrink-0">Aplicar</button>
                    </div>
                    <p id="payment-cupom-message" class="text-sm"></p>
                </div>
                <div id="payment-summary" class="mb-4 p-4 border rounded-lg space-y-2">
                    <h3 class="font-bold text-gray-700">Resumo do Pedido</h3>
                    <div class="flex justify-between text-sm"><span>Subtotal Produtos:</span><span id="payment-subtotal" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div id="payment-discount-row" class="flex justify-between text-sm text-green-600 hidden"><span>Desconto:</span><span id="payment-discount" class="font-medium">- R$ 0,00</span></div>
                    <div id="payment-shipping-row" class="flex justify-between text-sm"><span>Frete:</span><span id="payment-shipping" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Total a pagar:</span><span id="payment-total" class="text-pink-600">R$ 0,00</span></div>
                </div>
                <p class="text-gray-600 mb-4">Selecione como você prefere pagar.</p>
                <select id="payment-method-select" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                    <option value="" disabled selected>Escolha uma opção...</option>
                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                    <option value="Cartão de Débito">Cartão de Débito</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Link de Pagamento">Link de Pagamento</option>
                </select>
                <p id="payment-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t">
                <button id="confirm-order-button" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700 transition-colors">Confirmar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Checkout do Visitante -->
    <div id="guest-checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Informações para Entrega</h2>
                <button id="close-guest-checkout-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- Dados Pessoais -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Seus Dados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="guest-name" type="text" placeholder="Seu nome completo *" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <input id="guest-phone" type="tel" placeholder="Seu telefone (WhatsApp) *" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                </div>

                <!-- Endereço de Entrega com Mapa -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Endereço de Entrega</h3>
                    <div id="guest-address-map-container" class="relative">
                        <!-- O mapa será inserido aqui -->
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="guest-address-street" class="block text-sm font-medium text-gray-700">Rua*</label>
                            <input id="guest-address-street" type="text" placeholder="Nome da rua" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="guest-address-neighborhood" class="block text-sm font-medium text-gray-700">Bairro/Setor*</label>
                            <input id="guest-address-neighborhood" type="text" placeholder="Nome do bairro" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="guest-address-number" class="block text-sm font-medium text-gray-700">Número</label>
                            <input id="guest-address-number" type="text" placeholder="Nº" class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="guest-address-complement" class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input id="guest-address-complement" type="text" placeholder="Apto, bloco, etc." class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="guest-address-block" class="block text-sm font-medium text-gray-700">Quadra*</label>
                            <input id="guest-address-block" type="text" placeholder="Qd." class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="guest-address-lot" class="block text-sm font-medium text-gray-700">Lote*</label>
                            <input id="guest-address-lot" type="text" placeholder="Lt." class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        </div>
                    </div>
                    <input id="guest-address-full" type="hidden"> <!-- Campo oculto para endereço completo -->
                </div>


                <!-- Cupom -->
                <div class="space-y-2">
                    <h3 class="text-lg font-semibold text-gray-800">Cupom de Desconto</h3>
                    <div class="flex gap-2">
                        <input id="guest-cupom-input" type="text" placeholder="Tem um cupom?" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 uppercase">
                        <button id="guest-verify-cupom-button" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700 transition-colors flex-shrink-0">Aplicar</button>
                    </div>
                    <p id="guest-cupom-message" class="text-sm"></p>
                </div>

                <!-- Resumo e Pagamento -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Resumo e Pagamento</h3>
                    <div id="guest-summary" class="mb-4 p-4 border rounded-lg space-y-2">
                        <div class="flex justify-between text-sm"><span>Subtotal Produtos:</span><span id="guest-subtotal" class="font-medium text-gray-800">R$ 0,00</span></div>
                        <div id="guest-discount-row" class="flex justify-between text-sm text-green-600 hidden"><span>Desconto:</span><span id="guest-discount" class="font-medium">- R$ 0,00</span></div>
                        <div id="guest-shipping-row" class="flex justify-between text-sm"><span>Frete:</span><span id="guest-shipping" class="font-medium text-gray-800">Aguardando endereço...</span></div>
                        <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Total a pagar:</span><span id="guest-total" class="text-pink-600">R$ 0,00</span></div>
                    </div>
                    <select id="guest-payment-method" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                        <option value="" disabled selected>Forma de Pagamento *</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Cartão de Débito">Cartão de Débito</option>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Link de Pagamento">Link de Pagamento</option>
                    </select>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50">
                <button id="send-whatsapp-button" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-brands fa-whatsapp"></i> Finalizar e Enviar via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido (WhatsApp) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Enviado!</h2>
            <p class="text-gray-600">Obrigado! Seu pedido foi registrado e a mensagem está pronta para ser enviada.</p>
            <button id="close-confirmation" class="bg-pink-600 text-white py-2 px-6 rounded-lg mt-6 font-bold hover:bg-pink-700 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido (Plataforma) -->
    <div id="platform-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Registrado!</h2>
            <p class="text-gray-600">Obrigado! Seu pedido foi enviado diretamente para a nossa plataforma.</p>
            <button id="close-platform-confirmation" class="bg-pink-600 text-white py-2 px-6 rounded-lg mt-6 font-bold hover:bg-pink-700 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden opacity-0 transform translate-y-2">
        <p id="toast-message"></p>
    </div>

    <!-- SCRIPTS -->
	<script type="module">
	  import { db, doc, getDoc } from "./firebaseClientConfig.js";

	  // Variável global para armazenar os dados de frete
	  window.dadosFrete = null;

	  async function carregarConfiguracoesFrete() {
		try {
		  const freteRef = doc(db, "configuracoes", "frete");
		  const freteSnap = await getDoc(freteRef);
		  if (freteSnap.exists()) {
			window.dadosFrete = freteSnap.data();
			console.log("✅ Configurações de frete carregadas:", window.dadosFrete);
		  } else {
			console.error("❌ Documento 'frete' não encontrado");
		  }
		} catch (error) {
		  console.error("Erro ao carregar frete:", error);
		}
	  }

	  document.addEventListener("DOMContentLoaded", carregarConfiguracoesFrete);
	</script>

	<script>
    // --- LÓGICA DO GOOGLE MAPS (CLIENTE CADASTRADO) ---
	let map, marker, geocoder, placeAutocomplete;
    window.currentLatLng = null; 

    const saveAddressBtn = document.getElementById('save-manual-address-button');
    if(saveAddressBtn) {
        saveAddressBtn.disabled = true;
        saveAddressBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

	function validateAddressForm() {
	  const bairro = document.getElementById('manual-address-neighborhood').value.trim();
	  const cidade = document.getElementById('manual-address-city').value.trim();
	  const apelido = document.getElementById('manual-address-nickname').value.trim();
	  const hasCoords = window.currentLatLng?.lat && window.currentLatLng?.lng;
	  const hasBasicInfo = bairro.length > 0 && cidade.length > 0 && apelido.length > 0;
	  const isValid = hasCoords && hasBasicInfo;
	  
	  if (saveAddressBtn) {
        if (isValid) {
            saveAddressBtn.disabled = false;
            saveAddressBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            saveAddressBtn.disabled = true;
            saveAddressBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
	}

    async function initAddressMap() {
        const addressMapContainer = document.getElementById('address-map-container');
        addressMapContainer.innerHTML = '';

        try {
            const defaultCenter = { lat: -16.6869, lng: -49.2648 };
            geocoder = new google.maps.Geocoder();
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            const mapDiv = document.createElement('div');
            mapDiv.style.cssText = 'height:300px; width:100%; border-radius:0.5rem; margin-top:0.75rem;';
            
            map = new Map(mapDiv, { center: defaultCenter, zoom: 14, mapId: 'DEMO_MAP_ID' });
            marker = new AdvancedMarkerElement({ map: map, position: defaultCenter, gmpDraggable: true });
            marker.addListener('dragend', () => reverseGeocode(marker.position));
            
			placeAutocomplete = new google.maps.places.PlaceAutocompleteElement();
			placeAutocomplete.className = 'w-full mb-2 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500';
			placeAutocomplete.setAttribute('placeholder', 'Digite o endereço...');

			placeAutocomplete.addEventListener('gmp-select', async ({ placePrediction }) => {
			  try {
				const place = placePrediction.toPlace();
				await place.fetchFields({ fields: ['location', 'formattedAddress', 'addressComponents'] });
				
				if (place.location) {
				  const newPosition = { lat: place.location.lat, lng: place.location.lng };
				  map.setCenter(newPosition);
				  map.setZoom(18);
				  marker.position = newPosition;
				  window.currentLatLng = newPosition;
				  fillAddressFields(place);
				  validateAddressForm();
				}
			  } catch (error) {
				console.error('Erro ao buscar detalhes do local:', error);
			  }
			});

            const locationBtn = document.createElement('button');
            locationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Minha localização';
            locationBtn.className = 'w-full bg-pink-600 text-white px-3 py-2 rounded-lg font-bold mb-2 hover:bg-pink-700 transition-colors';
            locationBtn.type = 'button';
            locationBtn.onclick = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            map.panTo(coords);
                            map.setZoom(17);
                            marker.position = coords;
                            reverseGeocode(coords);
                        },
                        (err) => alert('Não foi possível obter localização: ' + err.message)
                    );
                } else {
                    alert('Geolocalização não suportada.');
                }
            };

            addressMapContainer.append(placeAutocomplete, locationBtn, mapDiv);
            validateAddressForm();
        } catch (error) {
            console.error("Erro ao inicializar o mapa:", error);
            addressMapContainer.innerHTML = `<div class="bg-red-50 p-4 rounded-lg text-red-700">Erro ao carregar o mapa.</div>`;
        }
    }

	function reverseGeocode(latlng) {
	  window.currentLatLng = (typeof latlng.lat === 'function') ? { lat: latlng.lat(), lng: latlng.lng() } : latlng;
	  validateAddressForm();
	  
	  geocoder.geocode({ location: latlng }, (results, status) => {
		if (status === 'OK' && results[0]) {
			fillAddressFields(results[0]);
			validateAddressForm();
		}
	  });
	}

	function fillAddressFields(place) {
	  const components = place.addressComponents || [];
	  const get = (type) => components.find(c => c.types.includes(type))?.longName || '';
	  
	  document.getElementById('manual-address-input').value = get('route');
	  document.getElementById('manual-address-number').value = get('street_number');
	  document.getElementById('manual-address-neighborhood').value = get('sublocality_level_1') || get('political');
	  document.getElementById('manual-address-city').value = get('administrative_area_level_2') || 'Goiânia';
	  document.getElementById('manual-address-zip').value = get('postal_code');
	  validateAddressForm();
	}

    document.getElementById('show-new-address-btn').addEventListener('click', () => {
        setTimeout(initAddressMap, 300);
    });

    ['manual-address-input','manual-address-number','manual-address-neighborhood','manual-address-city','manual-address-nickname']
    .forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', validateAddressForm);
    });
	</script>
    
    <script type="module">
        // --- VARIÁVEIS GLOBAIS ---
        const WHATSAPP_NUMBER = '5562991056075';
        let allProducts = [], cart = [], currentClient = null, pendingOrderDetails = {}, appliedCupom = null;
        const subcategoryOrder = ['Queridinhos', 'Bolo no pote', 'Copo da felicidade', 'Bombom aberto', 'Pipoca', 'Cone recheado', 'Bolo gelado', 'Bombom recheado'];
        window.valorFrete = 0;
        let storeConfig = {};

        // --- SELEÇÃO DE ELEMENTOS DOM ---
        const productList = document.getElementById('product-list'),
              subcategoryNav = document.getElementById('subcategory-nav'),
              loadingMessage = document.getElementById('loading-message'),
              cartButton = document.getElementById('cart-button'),
              cartModal = document.getElementById('cart-modal'),
              closeCartButton = document.getElementById('close-cart'),
              cartItemsContainer = document.getElementById('cart-items'),
              cartCount = document.getElementById('cart-count'),
              cartSubtotal = document.getElementById('cart-subtotal'),
              cartDiscountLine = document.getElementById('discount-line'),
              cartDiscount = document.getElementById('cart-discount'),
              cartShippingLine = document.getElementById('shipping-line'),
              cartShipping = document.getElementById('cart-shipping'),
              cartTotal = document.getElementById('cart-total'),
              checkoutButton = document.getElementById('checkout-button'),
              identificationModal = document.getElementById('identification-modal'),
              usePhoneButton = document.getElementById('use-phone-button'),
              continueGuestButton = document.getElementById('continue-guest-button'),
              closeIdentificationModal = document.getElementById('close-identification-modal'),
              
              guestCheckoutModal = document.getElementById('guest-checkout-modal'),
              closeGuestCheckoutModal = document.getElementById('close-guest-checkout-modal'),
              sendWhatsappButton = document.getElementById('send-whatsapp-button'),
              guestNameInput = document.getElementById('guest-name'),
              guestPhoneInput = document.getElementById('guest-phone'),
              guestAddressFullInput = document.getElementById('guest-address-full'),
              guestAddressNumberInput = document.getElementById('guest-address-number'),
              guestAddressComplementInput = document.getElementById('guest-address-complement'),
              guestPaymentMethodSelect = document.getElementById('guest-payment-method'),

              phoneLoginModal = document.getElementById('phone-login-modal'),
              closePhoneLoginModal = document.getElementById('close-phone-login-modal'),
              phoneInput = document.getElementById('phone-input'),
              phoneError = document.getElementById('phone-error'),
              searchPhoneButton = document.getElementById('search-phone-button'),
              addressManagementModal = document.getElementById('address-management-modal'),
              addressModalTitle = document.getElementById('address-modal-title'),
              confirmCustomerName = document.getElementById('confirm-customer-name'),
              addressList = document.getElementById('address-list'),
              closeAddressManagementModal = document.getElementById('close-address-management-modal'),
              paymentModal = document.getElementById('payment-modal'),
              closePaymentModal = document.getElementById('close-payment-modal'),
              backToAddressButton = document.getElementById('back-to-address'),
              selectedAddressText = document.getElementById('selected-address-text'),
              paymentMethodSelect = document.getElementById('payment-method-select'),
              confirmOrderButton = document.getElementById('confirm-order-button'),
              paymentError = document.getElementById('payment-error'),
              confirmationModal = document.getElementById('confirmation-modal'),
              closeConfirmationButton = document.getElementById('close-confirmation'),
              platformConfirmationModal = document.getElementById('platform-confirmation-modal'),
              closePlatformConfirmationButton = document.getElementById('close-platform-confirmation'),
              toast = document.getElementById('toast'),
              toastMessage = document.getElementById('toast-message'),
              guestCupomInput = document.getElementById('guest-cupom-input'),
              guestVerifyCupomButton = document.getElementById('guest-verify-cupom-button'),
              guestCupomMessage = document.getElementById('guest-cupom-message'),
              paymentCupomInput = document.getElementById('payment-cupom-input'),
              paymentVerifyCupomButton = document.getElementById('payment-verify-cupom-button'),
              paymentCupomMessage = document.getElementById('payment-cupom-message');

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        async function initApp() {
            try {
                await fetchStoreConfig();
                await fetchProducts();
                setupEventListeners();
                renderCart();
                console.log("✅ Aplicação inicializada com sucesso!");
            } catch (error) {
                console.error('❌ Erro ao inicializar aplicação:', error);
                showToast('Erro ao carregar a aplicação.', true);
            }
        }

        // --- FUNÇÕES PRINCIPAIS ---

        // Funções de Produtos
        async function fetchStoreConfig() {
            try {
                const { db, doc, getDoc } = await import('./firebaseClientConfig.js');
                const configDoc = await getDoc(doc(db, "configuracoes", "frete"));
                if (configDoc.exists()) {
                    storeConfig = configDoc.data();
                    console.log("✅ Configurações da loja carregadas:", storeConfig);
                }
            } catch (error) {
                console.error("Erro ao carregar configurações:", error);
            }
        }

        async function fetchProducts() {
            try {
                console.log("🔄 Buscando produtos do Firebase...");
                
                const { db, collection, getDocs, query, where } = await import('./firebaseClientConfig.js');
                
                const q = query(collection(db, "produtos"), where("status", "==", "Ativo"));
                const querySnapshot = await getDocs(q);
                allProducts = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                console.log(`✅ ${allProducts.length} produtos carregados`);
                
                if (allProducts.length === 0) {
                    throw new Error('Nenhum produto encontrado');
                }
                
                renderMenu();
                
            } catch (error) { 
                console.error("❌ Erro ao buscar produtos:", error);
                loadingMessage.innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 text-lg font-bold mb-2">Erro ao carregar o cardápio</p>
                        <p class="text-gray-600 text-sm">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700">
                            Tentar Novamente
                        </button>
                    </div>
                `;
                showToast("Erro ao buscar produtos: " + error.message, true);
            } finally { 
                loadingMessage.style.display = 'none'; 
            }
        }

        function renderMenu() {
            const deliveryFesta = allProducts.filter(p => p.categoria === 'Festa');
            
            if (deliveryFesta.length === 0) {
                productList.innerHTML = `
                    <div class="text-center py-16">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-600 text-lg">Nenhum produto disponível para Festa no momento.</p>
                    </div>
                `;
                return;
            }

            const productsBySubcategory = deliveryFesta.reduce((acc, product) => { 
                const sub = product.subcategoria || 'Outros'; 
                if (!acc[sub]) acc[sub] = []; 
                acc[sub].push(product); 
                return acc; 
            }, {});
            
            const availableSubcategories = subcategoryOrder.filter(sub => productsBySubcategory[sub]?.length > 0);
            const otherSubcategories = Object.keys(productsBySubcategory)
                .filter(sub => !subcategoryOrder.includes(sub) && productsBySubcategory[sub]?.length > 0);
            
            const allSubcategories = [...availableSubcategories, ...otherSubcategories];
            
            productList.innerHTML = ''; 
            subcategoryNav.innerHTML = '';
            
            allSubcategories.forEach(sub => { 
                const slug = sub.toLowerCase().replace(/\s+/g, '-'); 
                const link = document.createElement('a'); 
                link.href = `#${slug}`; 
                link.textContent = sub; 
                link.className = 'py-4 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:text-pink-600 transition-colors'; 
                subcategoryNav.appendChild(link); 
            });
            
            allSubcategories.forEach(sub => { 
                const slug = sub.toLowerCase().replace(/\s+/g, '-'); 
                const section = document.createElement('section'); 
                section.id = slug;
                section.className = 'mb-12';
                
                section.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-2">${sub}</h2>
                `; 
                
                const grid = document.createElement('div'); 
                grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6';
                
                productsBySubcategory[sub].forEach(product => { 
                    grid.innerHTML += createProductCard(product); 
                });
                
                section.appendChild(grid); 
                productList.appendChild(section);
            });
            
            setupScrollSpy();
        }

        function createProductCard(product) {
            const isOutOfStock = product.estoque !== null && product.estoque <= 0;
            const imageUrl = product.imageUrl || 'https://placehold.co/600x400/FFC0CB/FFFFFF?text=Doce+Ana+Guimarães';
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col h-full transform hover:scale-105 transition-transform duration-300 ${isOutOfStock ? 'opacity-50 grayscale' : ''}">
                    <img src="${imageUrl}" alt="${product.nome}" 
                         class="w-full h-48 object-cover" 
                         onerror="this.src='https://placehold.co/600x400/FFC0CB/FFFFFF?text=Doce+Ana+Guimarães'">
                    <div class="p-4 flex flex-col flex-grow justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 leading-tight mb-2">${product.nome}</h3>
                            <p class="text-gray-600 text-sm mb-3">${product.descricao || 'Delicioso produto da Ana Guimarães Doceria'}</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-lg font-bold text-pink-600">R$ ${product.preco?.toFixed(2) || '0,00'}</span>
                            <button class="bg-pink-600 text-white font-bold py-2 px-4 rounded-md hover:bg-pink-700 transition-colors ${isOutOfStock ? 'cursor-not-allowed bg-gray-300' : ''}" 
                                    onclick="addToCart('${product.id}')" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Esgotado' : 'Adicionar'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funções do Carrinho
        window.addToCart = (productId) => {
            const product = allProducts.find(p => p.id === productId); 
            if (!product) {
                showToast('Produto não encontrado!', true);
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            if (product.estoque !== null && (existingItem?.quantity || 0) >= product.estoque) { 
                showToast('Quantidade máxima em estoque atingida!', true); 
                return; 
            }
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ 
                    id: product.id,
                    nome: product.nome,
                    preco: product.preco,
                    quantity: 1 
                });
            }
            
            renderCart();
            showToast(`${product.nome} adicionado ao carrinho!`);
        };

        window.removeFromCart = (productId) => { 
            cart = cart.filter(item => item.id !== productId); 
            renderCart(); 
            showToast('Item removido do carrinho', true);
        };

        window.updateQuantity = (productId, change) => {
            const item = cart.find(item => item.id === productId); 
            if (!item) return;
            
            if (change > 0) { 
                const product = allProducts.find(p => p.id === productId); 
                if (product.estoque !== null && item.quantity >= product.estoque) { 
                    showToast('Quantidade máxima em estoque atingida!', true); 
                    return; 
                } 
            }
            
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
        };

        function renderCart() {
            cartItemsContainer.innerHTML = cart.length === 0 
                ? '<p class="text-gray-500 text-center py-8">Seu carrinho está vazio.</p>' 
                : cart.map(item => `
                    <div class="flex justify-between items-center mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${item.nome}</p>
                            <p class="text-sm text-gray-500">R$ ${item.preco.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center" 
                                    onclick="updateQuantity('${item.id}', -1)">-</button>
                            <span class="font-semibold min-w-8 text-center">${item.quantity}</span>
                            <button class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center" 
                                    onclick="updateQuantity('${item.id}', 1)">+</button>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 ml-2">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            
            updateCartInfo();
        }

		function updateCartInfo() {
			const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			const desconto = appliedCupom?.valorDesconto || 0;
			const total = subtotal - desconto + window.valorFrete;
			
			cartCount.textContent = totalItems;
			cartSubtotal.textContent = `R$ ${subtotal.toFixed(2)}`;
			cartTotal.textContent = `R$ ${total.toFixed(2)}`;
			
			if (desconto > 0) {
				cartDiscount.textContent = `- R$ ${desconto.toFixed(2)}`;
				cartDiscountLine.classList.remove('hidden');
			} else {
				cartDiscountLine.classList.add('hidden');
			}
			
			if (window.valorFrete > 0) {
				cartShipping.textContent = `R$ ${window.valorFrete.toFixed(2)}`;
				cartShippingLine.classList.remove('hidden');
			} else {
				cartShipping.textContent = `R$ 0,00`;
				cartShippingLine.classList.add('hidden');
			}
		}


        // Funções de Navegação
        function setupScrollSpy() {
            const sections = document.querySelectorAll('#product-list section');
            const navLinks = document.querySelectorAll('#subcategory-nav a');
            
            if (sections.length === 0 || navLinks.length === 0) return;
            
            const observer = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    if (entry.isIntersecting && entry.target.id) { 
                        navLinks.forEach(link => { 
                            const targetId = (link.getAttribute('href') || '').substring(1);
                            link.classList.toggle('active', targetId === entry.target.id);
                            if (targetId === entry.target.id) {
                                link.style.color = '#db2777';
                                link.style.borderBottomColor = '#db2777';
                            } else {
                                link.style.color = '';
                                link.style.borderBottomColor = '';
                            }
                        }); 
                    } 
                }); 
            }, { rootMargin: '-150px 0px -50% 0px', threshold: 0.1 });
            
            sections.forEach(section => observer.observe(section));
        }

        // Toast Notifications
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { 
                toast.classList.remove('opacity-0', 'translate-y-2'); 
            }, 10);
            setTimeout(() => { 
                toast.classList.add('opacity-0', 'translate-y-2'); 
                setTimeout(() => toast.classList.add('hidden'), 500); 
            }, 3000);
        }
        window.showToast = showToast;

        // Event Listeners
        function setupEventListeners() {
            cartButton.addEventListener('click', () => cartModal.classList.remove('hidden'));
            closeCartButton.addEventListener('click', () => cartModal.classList.add('hidden'));
            
            checkoutButton.addEventListener('click', () => { 
                if (cart.length === 0) { 
                    showToast('Seu carrinho está vazio!', true); 
                    return; 
                } 
                cartModal.classList.add('hidden'); 
                identificationModal.classList.remove('hidden'); 
            });
            
            closeIdentificationModal.addEventListener('click', () => identificationModal.classList.add('hidden'));
            
            usePhoneButton.addEventListener('click', () => { 
                identificationModal.classList.add('hidden'); 
                phoneLoginModal.classList.remove('hidden'); 
                phoneInput.value = ''; 
                phoneError.classList.add('hidden'); 
            });
            
            closePhoneLoginModal.addEventListener('click', () => { 
                phoneLoginModal.classList.add('hidden'); 
                currentClient = null; 
            });

            continueGuestButton.addEventListener('click', () => { 
                identificationModal.classList.add('hidden');
                guestCheckoutModal.classList.remove('hidden');
                updateGuestSummary();
                setTimeout(window.initGuestAddressMap, 300);
            });

            closeGuestCheckoutModal.addEventListener('click', () => guestCheckoutModal.classList.add('hidden'));

            searchPhoneButton.addEventListener('click', handlePhoneSearch);

            document.getElementById('close-customer-modal').addEventListener('click', () => {
                document.getElementById('customer-details-modal').classList.add('hidden');
            });
            
            document.getElementById('edit-profile-btn').addEventListener('click', () => {
                if (currentClient) {
                    addressManagementModal.classList.add('hidden');
                    openCustomerModalForEdit(currentClient);
                }
            });

            document.getElementById('show-new-address-btn').addEventListener('click', showNewAddressSection);
            document.getElementById('cancel-new-address-button').addEventListener('click', cancelNewAddress);
            document.getElementById('save-manual-address-button').addEventListener('click', saveManualAddress);

            closeAddressManagementModal.addEventListener('click', () => { 
                addressManagementModal.classList.add('hidden'); 
                currentClient = null; 
            });

            closePaymentModal.addEventListener('click', () => paymentModal.classList.add('hidden'));
            backToAddressButton.addEventListener('click', () => { 
                paymentModal.classList.add('hidden'); 
                addressManagementModal.classList.remove('hidden'); 
            });

            sendWhatsappButton.addEventListener('click', handleGuestOrder);
            confirmOrderButton.addEventListener('click', handlePlatformOrder);

            closeConfirmationButton.addEventListener('click', () => { 
                confirmationModal.classList.add('hidden'); 
                location.reload(); 
            });
            closePlatformConfirmationButton.addEventListener('click', () => { 
                platformConfirmationModal.classList.add('hidden'); 
                location.reload(); 
            });

            guestVerifyCupomButton.addEventListener('click', () => handleVerifyCupom('guest'));
            paymentVerifyCupomButton.addEventListener('click', () => handleVerifyCupom('payment'));
        
            ['guest-address-street', 'guest-address-neighborhood', 'guest-address-block', 'guest-address-lot'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('blur', async () => {
                        const street = document.getElementById('guest-address-street').value.trim();
                        const neighborhood = document.getElementById('guest-address-neighborhood').value.trim();
                        const block = document.getElementById('guest-address-block').value.trim();
                        const lot = document.getElementById('guest-address-lot').value.trim();

                        if (street && neighborhood && block && lot) {
                            const fullAddressForGeocode = `${street}, ${neighborhood}, Goiânia`;
                            
                            try {
                                await window.aguardarGoogleMaps();
                                const geocoder = new google.maps.Geocoder();
                                geocoder.geocode({ address: fullAddressForGeocode }, (results, status) => {
                                    if (status === 'OK' && results[0]) {
                                        const location = results[0].geometry.location;
                                        const latlng = { lat: location.lat(), lng: location.lng() };
                                        window.updateGuestShippingAndSummary(latlng);
                                    } else {
                                        console.warn('Não foi possível geocodificar o endereço digitado:', status);
                                        showToast('Endereço não encontrado para cálculo. Tente mover o pino no mapa.', true);
                                    }
                                });
                            } catch (error) {
                                console.error('Erro ao geocodificar endereço do visitante:', error);
                            }
                        }
                    });
                }
            });
        }

        function showNewAddressSection() {
            document.getElementById('new-address-section').classList.remove('hidden');
            document.getElementById('show-new-address-btn').classList.add('hidden');
        }

        function cancelNewAddress() {
            document.getElementById('new-address-section').classList.add('hidden');
            document.getElementById('show-new-address-btn').classList.remove('hidden');
        }

        async function saveManualAddress() {
            const nickname = document.getElementById('manual-address-nickname').value.trim();
            const address = document.getElementById('manual-address-input').value.trim();
            const number = document.getElementById('manual-address-number').value.trim();
            const complement = document.getElementById('manual-address-complement').value.trim();
            const neighborhood = document.getElementById('manual-address-neighborhood').value.trim();
            const city = document.getElementById('manual-address-city').value.trim();
            const zip = document.getElementById('manual-address-zip').value.trim();

			if (!window.currentLatLng || !window.currentLatLng.lat || !window.currentLatLng.lng) {
				showToast("Selecione a localização no mapa antes de salvar.", true);
				return;
			}

			if (!nickname) {
				showToast("Digite um apelido para o endereço.", true);
				return;
			}

            const addressText = `${address}${number ? ', ' + number : ''}${complement ? ' - ' + complement : ''}${neighborhood ? ', ' + neighborhood : ''}${city ? ', ' + city : ''}${zip ? ' - CEP: ' + zip : ''}`;

            try {
                const { db, doc, getDoc, updateDoc } = await import('./firebaseClientConfig.js');
                const clientDocRef = doc(db, "clientes", currentClient.id);
                const clientDoc = await getDoc(clientDocRef);
                const existingAddresses = clientDoc.exists() ? (clientDoc.data().enderecos || []) : [];

                const newAddress = {
                    enderecoCompleto: addressText,
                    nickname: nickname,
                    lat: window.currentLatLng.lat,
                    lng: window.currentLatLng.lng,
                    criadoEm: new Date().toISOString()
                };

                const updatedAddresses = existingAddresses.map(addr => (typeof addr === 'string') ? { enderecoCompleto: addr, nickname: `Endereço Antigo` } : addr);
                updatedAddresses.push(newAddress);

                await updateDoc(clientDocRef, { enderecos: updatedAddresses });
                
                showToast("✅ Endereço salvo com sucesso!");
                cancelNewAddress();
                openAddressManagementModal({ ...currentClient, enderecos: updatedAddresses });

            } catch (error) {
                console.error("Erro ao salvar endereço:", error);
                showToast("❌ Erro ao salvar endereço.", true);
            }
        }

		function openAddressManagementModal(client) {
			currentClient = client;
			addressList.innerHTML = '';
			confirmCustomerName.textContent = client.nome || 'Cliente';
			
			document.getElementById('new-address-section').classList.add('hidden');
			document.getElementById('show-new-address-btn').classList.remove('hidden');
			
			if (client.enderecos && client.enderecos.length > 0) {
				client.enderecos.forEach((address, index) => {
					const { enderecoCompleto, nickname } = (typeof address === 'string') 
                        ? { enderecoCompleto: address, nickname: `Endereço ${index + 1}` } 
                        : { enderecoCompleto: address.enderecoCompleto, nickname: address.nickname || `Endereço ${index + 1}`};
					
					const addressDiv = document.createElement('div');
					addressDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow mb-4';
					addressDiv.innerHTML = `
						<div class="flex items-center justify-between gap-2 mb-2">
							<span class="bg-pink-100 text-pink-800 text-xs font-medium px-2 py-1 rounded">${nickname}</span>
							<button class="text-red-500 hover:text-red-700 transition-colors delete-address-btn" title="Excluir endereço"><i class="fa-solid fa-trash-alt text-lg"></i></button>
						</div>
						<p class="text-gray-800 font-medium text-sm leading-tight">${enderecoCompleto}</p>
						<button class="w-full mt-3 bg-pink-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-pink-700 transition-colors flex items-center justify-center gap-2 use-address-btn"><i class="fa-solid fa-truck"></i> Usar este Endereço</button>
					`;
					
					addressDiv.querySelector('.use-address-btn').onclick = () => useExistingAddress(enderecoCompleto, address);
					addressDiv.querySelector('.delete-address-btn').onclick = (e) => { e.stopPropagation(); deleteAddress(index); };
					addressList.appendChild(addressDiv);
				});
			} else {
				addressList.innerHTML = `<div class="text-center py-8 bg-gray-50 rounded-lg"><i class="fa-solid fa-map-marker-alt text-4xl text-gray-300 mb-3"></i><p class="text-gray-500">Nenhum endereço cadastrado.</p></div>`;
			}
			addressManagementModal.classList.remove('hidden');
		}
		
		async function deleteAddress(addressIndex) {
			if (!confirm('Tem certeza que deseja excluir este endereço?')) return;

			try {
				const { db, doc, getDoc, updateDoc } = await import('./firebaseClientConfig.js');
				const clientDocRef = doc(db, 'clientes', currentClient.id);
				const clientDoc = await getDoc(clientDocRef);
				if (!clientDoc.exists()) throw new Error('Cliente não encontrado');

				const existingAddresses = clientDoc.data().enderecos || [];
				existingAddresses.splice(addressIndex, 1);

				await updateDoc(clientDocRef, { enderecos: existingAddresses });
				showToast('Endereço excluído!');
				openAddressManagementModal({ ...currentClient, enderecos: existingAddresses });

			} catch (error) {
				console.error('Erro ao deletar endereço:', error);
				showToast('Erro ao excluir endereço.', true);
			}
		}

		async function useExistingAddress(addressText, addressData) {
			pendingOrderDetails = {
				clienteId: currentClient.id,
				clienteNome: currentClient.nome,
				clienteEndereco: addressText,
				telefone: currentClient.telefone
			};
			selectedAddressText.textContent = addressText;
			addressManagementModal.classList.add('hidden');

			if (addressData?.lat && addressData?.lng) {
				try {
					await window.aguardarGoogleMaps();
					const resultado = await window.calcularFreteParaEndereco({ lat: parseFloat(addressData.lat), lng: parseFloat(addressData.lng) });
					window.valorFrete = parseFloat(resultado.valorFrete);
					showToast(`Frete: R$ ${window.valorFrete.toFixed(2)}`);
				} catch (error) {
					console.error('Erro ao calcular frete:', error);
					showToast('Não foi possível calcular o frete.', true);
					window.valorFrete = 0;
				}
			} else {
				window.valorFrete = 0;
			}
            updateAllSummaries();
			paymentModal.classList.remove('hidden');
		}

        function openCustomerModalForEdit(client) {
            const modal = document.getElementById('customer-details-modal');
            document.getElementById('customer-modal-title').textContent = 'Editar Perfil';
            document.getElementById('customer-modal-phone').textContent = client.telefone;
            const nameInput = document.getElementById('customer-modal-name');
            const birthdateInput = document.getElementById('customer-modal-birthdate');
            
            nameInput.value = client.nome || '';
            birthdateInput.value = client.aniversario || '';
            
            nameInput.readOnly = false;
            birthdateInput.readOnly = false;
            nameInput.classList.remove('bg-gray-100');
            birthdateInput.classList.remove('bg-gray-100');

            const footer = document.getElementById('customer-modal-footer');
            footer.innerHTML = `
                <button id="cancel-edit-btn" type="button" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600">Cancelar</button>
                <button id="save-customer-btn" type="button" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-600">Salvar Alterações</button>
            `;

            document.getElementById('cancel-edit-btn').onclick = () => {
                modal.classList.add('hidden');
                openAddressManagementModal(currentClient); // Go back
            };

            document.getElementById('save-customer-btn').onclick = async () => {
                const newName = nameInput.value.trim();
                const newBirthdate = birthdateInput.value;
                if (!newName || !newBirthdate) {
                    document.getElementById('customer-modal-error').textContent = 'Nome e data de nascimento são obrigatórios.';
                    document.getElementById('customer-modal-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('customer-modal-error').classList.add('hidden');

                try {
                    const { db, doc, updateDoc } = await import('./firebaseClientConfig.js');
                    const clientRef = doc(db, 'clientes', client.id);
                    await updateDoc(clientRef, { nome: newName, aniversario: newBirthdate });
                    
                    currentClient.nome = newName;
                    currentClient.aniversario = newBirthdate;

                    showToast('Dados atualizados com sucesso!');
                    modal.classList.add('hidden');
                    openAddressManagementModal(currentClient); // Reopen address modal with updated name
                } catch (error) {
                    console.error("Erro ao atualizar cliente:", error);
                    showToast('Erro ao atualizar dados.', true);
                }
            };

            modal.classList.remove('hidden');
        }

        function openCustomerModalForCreate(phone) {
            const modal = document.getElementById('customer-details-modal');
            document.getElementById('customer-modal-title').textContent = 'Novo Cadastro';
            document.getElementById('customer-modal-phone').textContent = phone;
            const nameInput = document.getElementById('customer-modal-name');
            const birthdateInput = document.getElementById('customer-modal-birthdate');
            nameInput.value = '';
            birthdateInput.value = '';
            nameInput.readOnly = false;
            birthdateInput.readOnly = false;
            nameInput.classList.remove('bg-gray-100');
            birthdateInput.classList.remove('bg-gray-100');

            const footer = document.getElementById('customer-modal-footer');
            footer.innerHTML = `
                <button id="create-customer-btn" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700">Criar Cadastro e Continuar</button>
            `;

            document.getElementById('create-customer-btn').onclick = async () => {
                const newName = nameInput.value.trim();
                const newBirthdate = birthdateInput.value;
                if (!newName || !newBirthdate) {
                    document.getElementById('customer-modal-error').textContent = 'Nome e data de nascimento são obrigatórios.';
                    document.getElementById('customer-modal-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('customer-modal-error').classList.add('hidden');

                const button = document.getElementById('create-customer-btn');
                button.disabled = true;
                button.textContent = 'Criando...';

                try {
                    const { db, addDoc, collection, serverTimestamp } = await import('./firebaseClientConfig.js');
                    const newClientData = {
                        nome: newName,
                        aniversario: newBirthdate,
                        telefone: phone.replace(/\D/g, ''),
                        enderecos: [],
                        createdAt: serverTimestamp()
                    };
                    const docRef = await addDoc(collection(db, "clientes"), newClientData);
                    currentClient = { id: docRef.id, ...newClientData };
                    showToast("Novo cliente criado com sucesso!");
                    modal.classList.add('hidden');
                    openAddressManagementModal(currentClient);

                } catch (error) {
                    console.error("Erro ao criar cliente:", error);
                    showToast("Erro ao criar cadastro. Tente novamente.", true);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Criar Cadastro e Continuar';
                }
            };

            modal.classList.remove('hidden');
            nameInput.focus();
        }

        async function handlePhoneSearch() {
            const phone = phoneInput.value.trim();
            const phoneDigits = phone.replace(/\D/g, ''); 
            
            if (phoneDigits.length < 10) {
                phoneError.textContent = 'Digite um número válido com DDD';
                phoneError.classList.remove('hidden');
                return;
            }

            phoneError.classList.add('hidden');
            searchPhoneButton.disabled = true;
            searchPhoneButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div> Buscando...';
            
            try {
                const { db, collection, getDocs, query, where } = await import('./firebaseClientConfig.js');
                const q = query(collection(db, "clientes"), where("telefone", "==", phoneDigits));
                const querySnapshot = await getDocs(q);
                
                phoneLoginModal.classList.add('hidden');

                if (!querySnapshot.empty) {
                    const clientDoc = querySnapshot.docs[0];
                    currentClient = { id: clientDoc.id, ...clientDoc.data() };
                    console.log("✅ Cliente encontrado:", currentClient);
                    openAddressManagementModal(currentClient);
                } else {
                    console.log("❌ Cliente não encontrado. Abrindo modal de criação.");
                    openCustomerModalForCreate(phone);
                }
                
            } catch (error) { 
                console.error("Error searching client:", error);
                phoneError.textContent = 'Erro ao buscar cliente. Tente novamente.'; 
                phoneError.classList.remove('hidden');
                phoneLoginModal.classList.remove('hidden');
            } finally {
                searchPhoneButton.disabled = false;
                searchPhoneButton.textContent = 'Buscar';
            }
        }

        function updateAllSummaries() { 
            updateCartInfo(); 
            updatePaymentSummary(); 
            updateGuestSummary(); 
        }

		function updatePaymentSummary() {
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			let discount = appliedCupom?.valorDesconto || 0;
			let total = subtotal - discount + window.valorFrete;
			
			document.getElementById('payment-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
			document.getElementById('payment-total').textContent = `R$ ${total.toFixed(2)}`;
			document.getElementById('payment-discount-row').classList.toggle('hidden', discount === 0);
			if (discount > 0) document.getElementById('payment-discount').textContent = `- R$ ${discount.toFixed(2)}`;
			
			if (window.valorFrete > 0) {
				document.getElementById('payment-shipping').textContent = `R$ ${window.valorFrete.toFixed(2)}`;
				document.getElementById('payment-shipping-row').classList.remove('hidden');
			} else {
                document.getElementById('payment-shipping-row').classList.add('hidden');
			}
		}

		function updateGuestSummary() {
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			let discount = appliedCupom?.valorDesconto || 0;
			let total = subtotal - discount + window.valorFrete;
			
			document.getElementById('guest-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
			document.getElementById('guest-total').textContent = `R$ ${total.toFixed(2)}`;
			document.getElementById('guest-discount-row').classList.toggle('hidden', discount === 0);
			if (discount > 0) document.getElementById('guest-discount').textContent = `- R$ ${discount.toFixed(2)}`;
			
			if (window.valorFrete > 0) {
				document.getElementById('guest-shipping').textContent = `R$ ${window.valorFrete.toFixed(2)}`;
				document.getElementById('guest-shipping-row').classList.remove('hidden');
			} else {
                document.getElementById('guest-shipping-row').classList.remove('hidden');
				document.getElementById('guest-shipping').textContent = `Aguardando endereço...`;
			}
		}
        window.updateGuestSummary = updateGuestSummary;

        async function handleVerifyCupom(type) {
            const isGuest = type === 'guest';
            const cupomInput = isGuest ? guestCupomInput : paymentCupomInput;
            const cupomMessage = isGuest ? guestCupomMessage : paymentCupomMessage;
            const verifyButton = isGuest ? guestVerifyCupomButton : paymentVerifyCupomButton;
            
            if (appliedCupom) { removeCupom(); return; }
            
            const codigo = cupomInput.value.trim().toUpperCase(); 
            if (!codigo) { showToast('Digite um cupom.', true); return; }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0); 
            if (subtotal <= 0) { showToast('Adicione itens ao carrinho.', true); return; }
            
            verifyButton.disabled = true; 
            verifyButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div>';
            
            try {
                const { db, collection, getDocs, query, where, getDoc, doc } = await import('./firebaseClientConfig.js');

                if (!isGuest && currentClient?.id) {
                    const clientDoc = await getDoc(doc(db, "clientes", currentClient.id));
                    if (clientDoc.exists() && clientDoc.data().cuponsUsados?.includes(codigo)) {
                        throw new Error('Você já utilizou este cupom.');
                    }
                }
                
                const q = query(collection(db, "cupons"), where("codigo", "==", codigo));
                const cupomSnapshot = await getDocs(q);
                if (cupomSnapshot.empty) throw new Error('Cupom inválido.');
                
                const cupom = { id: cupomSnapshot.docs[0].id, ...cupomSnapshot.docs[0].data() };

                if (cupom.status !== 'Ativo') throw new Error('Cupom inativo.');
                if (cupom.limiteUso > 0 && (cupom.usos || 0) >= cupom.limiteUso) throw new Error('Cupom esgotado.');
                if (subtotal < (cupom.valorMinimo || 0)) throw new Error(`Pedido mínimo de R$ ${cupom.valorMinimo.toFixed(2)}.`);
                
                appliedCupom = cupom;
                appliedCupom.valorDesconto = cupom.tipoDesconto === 'percentual' ? (subtotal * cupom.valor) / 100 : cupom.valor;
                
                cupomMessage.textContent = `Cupom "${appliedCupom.codigo}" aplicado!`; 
                cupomMessage.className = 'text-sm text-green-600';
                cupomInput.value = appliedCupom.codigo; 
                cupomInput.disabled = true;
                verifyButton.textContent = 'Remover'; 
                verifyButton.classList.replace('bg-gray-600', 'bg-red-600');
                showToast('Cupom aplicado!'); 
                updateAllSummaries();

            } catch (error) { 
                cupomMessage.textContent = error.message; 
                cupomMessage.className = 'text-sm text-red-500'; 
                appliedCupom = null;
            } finally { 
                verifyButton.disabled = false; 
                verifyButton.innerHTML = appliedCupom ? 'Remover' : 'Aplicar'; 
            }
        }

        function removeCupom() {
            if (appliedCupom) { showToast('Cupom removido.'); appliedCupom = null; }
            [guestCupomInput, paymentCupomInput].forEach(input => { input.value = ''; input.disabled = false; });
            [guestVerifyCupomButton, paymentVerifyCupomButton].forEach(btn => { btn.textContent = 'Aplicar'; btn.classList.replace('bg-red-600', 'bg-gray-600'); });
            [guestCupomMessage, paymentCupomMessage].forEach(msg => { msg.textContent = ''; });
            updateAllSummaries();
        }

		async function handleGuestOrder() {
            const name = guestNameInput.value.trim();
            const phone = guestPhoneInput.value.trim();
            const paymentMethod = guestPaymentMethodSelect.value;
            const street = document.getElementById('guest-address-street').value.trim();
            const neighborhood = document.getElementById('guest-address-neighborhood').value.trim();
            const number = document.getElementById('guest-address-number').value.trim();
            const block = document.getElementById('guest-address-block').value.trim();
            const lot = document.getElementById('guest-address-lot').value.trim();
            const complement = document.getElementById('guest-address-complement').value.trim();

            if (!name || !phone || !paymentMethod || !street || !neighborhood || !block || !lot) {
                showToast('Preencha todos os campos obrigatórios (*).', true);
                return;
            }
            
            let fullAddress = `${street}, ${number ? 'Nº ' + number : 'S/N'}, ${neighborhood}, Qd. ${block}, Lt. ${lot}`;
            if (complement) fullAddress += ` - ${complement}`;
			
			sendWhatsappButton.disabled = true;
			sendWhatsappButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processando...';
			
			try {
				await finalizeOrder({
					clienteNome: name,
					clienteEndereco: fullAddress,
					telefone: phone,
					formaPagamento: paymentMethod
				}, null, false);
				
			} catch (error) {
				console.error('Erro ao processar pedido do visitante:', error);
				showToast('Erro ao processar o pedido.', true);
				sendWhatsappButton.disabled = false;
				sendWhatsappButton.innerHTML = '<i class="fa-brands fa-whatsapp"></i> Finalizar e Enviar via WhatsApp';
			}
		}

        async function handlePlatformOrder() {
            if (!paymentMethodSelect.value) { 
                paymentError.textContent = 'Selecione uma forma de pagamento.'; 
                paymentError.classList.remove('hidden'); 
                return; 
            }
            paymentError.classList.add('hidden');
            confirmOrderButton.disabled = true;
            confirmOrderButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div> Confirmando...';
            
            try {
                const finalOrderDetails = { ...pendingOrderDetails, formaPagamento: paymentMethodSelect.value };
                await finalizeOrder(finalOrderDetails, finalOrderDetails.clienteId, true);
            } catch (error) {
                console.error('Erro ao confirmar pedido:', error);
                showToast('Erro ao confirmar o pedido.', true);
            } finally {
                confirmOrderButton.disabled = false;
                confirmOrderButton.textContent = 'Confirmar Pedido';
            }
        }

        async function finalizeOrder(clientInfo, clientId, isPlatform) {
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            let cupomData = null;
            if(appliedCupom) {
                cupomData = { codigo: appliedCupom.codigo, valorDesconto: appliedCupom.valorDesconto };
            }
            const desconto = cupomData?.valorDesconto || 0;
            const total = subtotal - desconto + window.valorFrete;
            
            const { db, collection, addDoc, serverTimestamp, doc, updateDoc, arrayUnion, getDoc } = await import('./firebaseClientConfig.js');
            
            const orderData = {
                clienteId: clientId,
                clienteNome: clientInfo.clienteNome,
                clienteEndereco: clientInfo.clienteEndereco,
                telefone: clientInfo.telefone,
                formaPagamento: clientInfo.formaPagamento,
                itens: cart.map(item => ({ produtoId: item.id, nome: item.nome, quantity: item.quantity, preco: item.preco })),
                subtotal, desconto, valorFrete: window.valorFrete, total, cupom: cupomData,
                status: 'Pendente',
                origem: isPlatform ? 'Plataforma' : 'Cardapio Online',
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, "pedidos"), orderData);

                // --- INÍCIO DA LÓGICA DE ATUALIZAÇÃO DE ESTOQUE ---
                for (const item of cart) {
                    try {
                        const productRef = doc(db, "produtos", item.id);
                        const productSnap = await getDoc(productRef);

                        if (productSnap.exists()) {
                            const productData = productSnap.data();
                            // Verifica se o controle de estoque está ativo para este produto
                            if (typeof productData.estoque === 'number') {
                                const newStock = productData.estoque - item.quantity;
                                await updateDoc(productRef, { estoque: newStock });
                                console.log(`Estoque do produto ${item.nome} atualizado para ${newStock}.`);
                            }
                        }
                    } catch (stockError) {
                        console.error(`Falha ao atualizar o estoque para o produto ${item.id}:`, stockError);
                        // Apenas registra o erro no console, mas não impede a finalização do pedido.
                    }
                }
                // --- FIM DA LÓGICA DE ATUALIZAÇÃO DE ESTOQUE ---

                if (clientId && appliedCupom) {
                    try {
                        const clientDocRef = doc(db, "clientes", clientId);
                        await updateDoc(clientDocRef, { cuponsUsados: arrayUnion(appliedCupom.codigo) });
                        const cupomDocRef = doc(db, "cupons", appliedCupom.id);
                        const cupomDoc = await getDoc(cupomDocRef);
                        if (cupomDoc.exists()) {
                            await updateDoc(cupomDocRef, { usos: (cupomDoc.data().usos || 0) + 1 });
                        }
                    } catch (updateError) {
                        console.error("Erro ao registrar o uso do cupom:", updateError);
                    }
                }
                
                if (!isPlatform) {
                    let message = `*Novo Pedido* 🎂 (Nº ${docRef.id.substring(0, 5)})\n\n*Itens:*\n${cart.map(item => `• ${item.quantity}x ${item.nome}`).join('\n')}\n\n*Resumo:*\nSubtotal: R$ ${subtotal.toFixed(2)}\n`;
                    if (cupomData) message += `Desconto (${cupomData.codigo}): -R$ ${desconto.toFixed(2)}\n`;
                    if (window.valorFrete > 0) message += `Frete: R$ ${window.valorFrete.toFixed(2)}\n`;
                    message += `*Total: R$ ${total.toFixed(2)}*\n\n*Dados:*\nNome: ${clientInfo.clienteNome}\nTelefone: ${clientInfo.telefone}\nEndereço: ${clientInfo.clienteEndereco}\nPagamento: ${clientInfo.formaPagamento}\n\n_Pedido via Cardápio Online_`;
                    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
                    confirmationModal.classList.remove('hidden');
                } else {
                    platformConfirmationModal.classList.remove('hidden');
                }
                
                cart = []; 
                currentClient = null; 
                pendingOrderDetails = {}; 
                removeCupom(); 
                renderCart();
                
            } catch (error) {
                console.error("Erro ao salvar pedido:", error);
                showToast('Erro ao confirmar o pedido.', true);
            }
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
	
	<script type="module">
		import { db, doc, getDoc } from './firebaseClientConfig.js';
	</script>

	<script>
	// ==================== CÁLCULO DE FRETE E MAPA PARA VISITANTES ====================
    let guestMap, guestMarker, guestGeocoder, guestPlaceAutocomplete;

    async function updateGuestShippingAndSummary(latlng) {
        document.getElementById('guest-shipping').textContent = 'Calculando...';
        window.valorFrete = 0;
        window.updateGuestSummary();

        try {
            await window.aguardarGoogleMaps();
            const resultado = await window.calcularFreteParaEndereco(latlng);
            window.valorFrete = parseFloat(resultado.valorFrete);
            window.showToast(`Frete: R$ ${window.valorFrete.toFixed(2)}`);
        } catch (error) {
            console.error('Falha ao calcular frete para visitante:', error);
            window.showToast('Não foi possível calcular o frete.', true);
            window.valorFrete = 0;
        } finally {
            window.updateGuestSummary();
        }
    }
    window.updateGuestShippingAndSummary = updateGuestShippingAndSummary;

    function fillGuestAddressFields(place) {
        const components = place.addressComponents || [];
        const get = (type) => components.find(c => c.types.includes(type))?.longName || '';
        
        document.getElementById('guest-address-street').value = get('route');
        document.getElementById('guest-address-neighborhood').value = get('sublocality_level_1') || get('political');
        document.getElementById('guest-address-number').value = get('street_number');
        document.getElementById('guest-address-full').value = place.formattedAddress || '';
    }

    function reverseGeocodeGuest(latlng) {
        guestGeocoder.geocode({ location: latlng }, (results, status) => {
            if (status === 'OK' && results[0]) {
                fillGuestAddressFields(results[0]);
            }
            updateGuestShippingAndSummary(latlng);
        });
    }

    window.initGuestAddressMap = async function() {
        const addressMapContainer = document.getElementById('guest-address-map-container');
        if (addressMapContainer.dataset.initialized) return;
        addressMapContainer.innerHTML = ''; 

        try {
            const defaultCenter = { lat: -16.6869, lng: -49.2648 };
            guestGeocoder = new google.maps.Geocoder();
            
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            const mapDiv = document.createElement('div');
            mapDiv.style.cssText = 'height:300px; width:100%; border-radius:0.5rem; margin-top:0.75rem;';
            
            guestMap = new Map(mapDiv, { center: defaultCenter, zoom: 14, mapId: 'DEMO_MAP_ID' });
            guestMarker = new AdvancedMarkerElement({ map: guestMap, position: defaultCenter, gmpDraggable: true });
            guestMarker.addListener('dragend', () => reverseGeocodeGuest(guestMarker.position));
            
            guestPlaceAutocomplete = new google.maps.places.PlaceAutocompleteElement();
            guestPlaceAutocomplete.className = 'w-full mb-2 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500';
            guestPlaceAutocomplete.setAttribute('placeholder', 'Digite o endereço para entrega...');

            guestPlaceAutocomplete.addEventListener('gmp-select', async ({ placePrediction }) => {
                const place = placePrediction.toPlace();
                await place.fetchFields({ fields: ['location', 'formattedAddress', 'addressComponents'] });
                if (place.location) {
                    const newPosition = { lat: place.location.lat, lng: place.location.lng };
                    guestMap.setCenter(newPosition);
                    guestMap.setZoom(18);
                    guestMarker.position = newPosition;
                    fillGuestAddressFields(place);
                    updateGuestShippingAndSummary(newPosition);
                }
            });
            
            const locationBtn = document.createElement('button');
            locationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Usar minha localização';
            locationBtn.className = 'w-full bg-pink-600 text-white px-3 py-2 rounded-lg font-bold mb-2 hover:bg-pink-700 transition-colors';
            locationBtn.type = 'button';
            locationBtn.onclick = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        guestMap.panTo(coords);
                        guestMap.setZoom(17);
                        guestMarker.position = coords;
                        reverseGeocodeGuest(coords);
                    });
                }
            };
            
            addressMapContainer.append(guestPlaceAutocomplete, locationBtn, mapDiv);
            addressMapContainer.dataset.initialized = 'true';
        } catch (error) {
            console.error("Erro ao inicializar mapa do visitante:", error);
            addressMapContainer.innerHTML = `<div class="bg-red-50 p-4 text-red-700 rounded-lg">Erro ao carregar o mapa.</div>`;
        }
    }
	// ==================== CÁLCULO DE FRETE - VERSÃO ÚNICA ====================

	// Função auxiliar para aguardar o Google Maps carregar
	function aguardarGoogleMaps() {
		return new Promise((resolve, reject) => {
			if (window.google && window.google.maps) {
				return resolve();
			}
            let attempt = 0;
			const checkInterval = setInterval(() => {
                attempt++;
				if (window.google && window.google.maps) {
					clearInterval(checkInterval);
					resolve();
				} else if (attempt > 50) { // Timeout after 10 seconds
                    clearInterval(checkInterval);
                    reject('Timeout: Google Maps não carregou.');
                }
			}, 200);
		});
	}
    window.aguardarGoogleMaps = aguardarGoogleMaps;

	// Função para calcular frete usando Google Distance Matrix API
	async function calcularFreteParaEndereco(destinoLatLng) {
		console.log('🚚 Iniciando cálculo de frete...');
		
		return new Promise((resolve, reject) => {
			if (!window.dadosFrete) {
				return reject('Configurações de frete não carregadas');
			}
			if (!window.google || !window.google.maps) {
				return reject('Google Maps não carregado');
			}
			
			const loja = {
				lat: parseFloat(window.dadosFrete.lat),
				lng: parseFloat(window.dadosFrete.lng)
			};
			const valorPorKm = parseFloat(window.dadosFrete.valorPorKm);
			
			const service = new google.maps.DistanceMatrixService();
			service.getDistanceMatrix({
				origins: [loja],
				destinations: [destinoLatLng],
				travelMode: google.maps.TravelMode.DRIVING,
				unitSystem: google.maps.UnitSystem.METRIC
			}, (response, status) => {
				if (status !== 'OK' || response.rows[0]?.elements[0]?.status !== 'OK') {
                    console.error('Erro no Distance Matrix:', status, response);
					return reject(status);
				}
				
				const element = response.rows[0].elements[0];
				const distanceKm = element.distance.value / 1000;
				let valorFreteCalculado = distanceKm * valorPorKm;

				if (valorFreteCalculado < 2) {
					valorFreteCalculado = 2.00;
				}

				resolve({
					distanciaKm: distanceKm.toFixed(2),
					valorFrete: valorFreteCalculado.toFixed(2)
				});
			});
		});
	}
    window.calcularFreteParaEndereco = calcularFreteParaEndereco;

	console.log('✅ Módulos de frete e mapa carregados');
	</script>

</body>
</html>
