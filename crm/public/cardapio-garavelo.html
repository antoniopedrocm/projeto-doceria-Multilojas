<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Ana Guimarães Doceria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	<link rel="icon" type="image/png" href="/logo.png" />
    
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
		
		body { font-family: 'Poppins', sans-serif; }
		html { scroll-behavior: smooth; scroll-padding-top: 140px; }
		
		.loader { 
			border: 4px solid #f3f3f3; 
			border-top: 4px solid #db2777;
			border-radius: 50%; 
			width: 40px; 
			height: 40px; 
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin { 
			0% { transform: rotate(0deg); } 
			100% { transform: rotate(360deg); } 
		}
		
		#toast { transition: opacity 0.5s, transform 0.5s; }
		#subcategory-nav a.active { 
			color: #db2777;
			border-bottom-color: #db2777;
		}
		#subcategory-nav::-webkit-scrollbar { display: none; }
		#subcategory-nav { -ms-overflow-style: none; scrollbar-width: none; }
		.map-placeholder { height: 300px; width: 100%; border-radius: 0.5rem; background-color: #f9fafb; display: flex; align-items: center; justify-content: center; color: #6b7280; }
		
		/* ===== CORREÇÃO FOCADA APENAS NA BARRA PRINCIPAL ===== */
		@media (max-width: 768px) {
			/* HEADER PRINCIPAL - MAIS AMIGÁVEL (APENAS ISSO) */
			header {
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				right: 0 !important;
				z-index: 25 !important;
				background: white;
				height: 72px !important; /* Altura mais amigável */
				padding: 0.75rem 1rem !important; /* Mais padding */
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			}
			
			header .container {
				height: 100% !important;
				display: flex !important;
				align-items: center !important;
				justify-content: space-between !important;
			}
			
			/* Logo e título um pouco maiores */
			header img {
				max-height: 40px !important; /* Logo um pouco maior */
			}
			
			header h1 {
				font-size: 1.3rem !important; /* Título um pouco maior */
				margin: 0 !important;
			}
			
			/* Botão do carrinho mais amigável */
			#cart-button {
				padding: 0.625rem !important; /* Um pouco mais de padding */
			}
			
			/* BARRA DE NAVEGAÇÃO - APENAS COMPENSAÇÃO DA ALTURA DO HEADER */
			#subcategory-nav-container {
				position: fixed !important;
				top: 72px !important; /* Ajustado para nova altura do header */
				left: 0 !important;
				right: 0 !important;
				z-index: 20 !important;
				background: white;
				padding: 0 !important;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				height: 48px !important;
				touch-action: pan-x !important;
				overflow: hidden !important;
			}
			
			#subcategory-nav {
				padding: 0.75rem 1rem !important;
				gap: 1rem !important;
				overflow-x: auto !important;
				overflow-y: hidden !important;
				-webkit-overflow-scrolling: touch;
				width: 100%;
				height: 100% !important;
				display: flex !important;
				align-items: center !important;
				touch-action: pan-x !important;
				scrollbar-width: none !important;
				-ms-overflow-style: none !important;
				white-space: nowrap !important;
			}
			
			#subcategory-nav a {
				font-size: 0.875rem !important;
				padding: 0.5rem 0 !important;
				white-space: nowrap;
				flex-shrink: 0;
				height: fit-content !important;
				touch-action: pan-x !important;
			}
			
			/* COMPENSAÇÃO PARA AS BARRAS FIXAS */
			/* Header (72px) + Barra Navegação (48px) = 120px total */
			main {
				padding-top: 120px !important; /* Ajustado para nova altura */
				min-height: calc(100vh - 120px) !important;
			}
			
			/* Ajustar o scroll padding para a navegação suave */
			html {
				scroll-padding-top: 120px !important;
			}
			
			/* O RESTO PERMANECE EXATAMENTE COMO ESTAVA ANTES */
			/* Ajuste do container principal */
			#product-list {
				padding: 0 1rem;
				margin-top: 0 !important;
			}
			
			/* Layout dos cards de produto em lista vertical */
			#product-list > div > div[class*="grid"] {
				display: flex !important;
				flex-direction: column !important;
				gap: 1rem !important;
			}
			
			/* Card individual do produto - layout horizontal */
			#product-list div[class*="grid"] > div {
				display: flex !important;
				flex-direction: row !important;
				align-items: flex-start !important;
				background: white;
				border-radius: 8px;
				padding: 0.75rem;
				box-shadow: 0 1px 3px rgba(0,0,0,0.1);
				gap: 0.75rem;
				min-height: 120px;
			}
			
			/* Imagem do produto - tamanho fixo à esquerda */
			#product-list div[class*="grid"] > div img {
				width: 100px !important;
				min-width: 100px !important;
				height: 100px !important;
				object-fit: cover !important;
				border-radius: 8px !important;
				flex-shrink: 0;
			}
			
			/* Container de informações do produto */
			#product-list div[class*="grid"] > div > div {
				display: flex !important;
				flex-direction: column !important;
				justify-content: space-between !important;
				flex: 1;
				min-height: 100px;
			}
			
			/* Título do produto */
			#product-list div[class*="grid"] > div h3,
			#product-list div[class*="grid"] > div h2 {
				font-size: 1rem !important;
				line-height: 1.3 !important;
				font-weight: 600 !important;
				margin: 0 0 0.35rem 0 !important;
				color: #1f2937;
			}
			
			/* Descrição do produto */
			#product-list div[class*="grid"] > div p {
				font-size: 0.813rem !important;
				line-height: 1.4 !important;
				color: #6b7280 !important;
				margin: 0 0 0.5rem 0 !important;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
			}
			
			/* Preço do produto */
			#product-list div[class*="grid"] > div span[class*="text"],
			#product-list div[class*="grid"] > div div[class*="text"] {
				font-size: 1.125rem !important;
				font-weight: 700 !important;
				color: #db2777 !important;
				margin-top: auto;
			}
			
			/* Botão de adicionar ao carrinho */
			#product-list div[class*="grid"] > div button {
				margin-top: 0.5rem !important;
				padding: 0.5rem 1rem !important;
				font-size: 0.875rem !important;
				width: 100% !important;
			}
			
			/* Espaçamento entre seções */
			#product-list > div {
				margin-bottom: 1.5rem !important;
			}
			
			/* Título das categorias */
			#product-list h2 {
				font-size: 1.25rem !important;
				padding: 0 0 0.75rem 0 !important;
				margin-bottom: 0.75rem !important;
			}
			
			/* Modal do carrinho em mobile */
			#cart-modal > div {
				max-width: 95% !important;
				margin: 1rem !important;
			}
		}

		/* Ajustes extras para telas muito pequenas */
		@media (max-width: 380px) {
			header {
				height: 68px !important;
				padding: 0.5rem 0.75rem !important;
			}
			
			header h1 {
				font-size: 1.2rem !important;
			}
			
			header img {
				max-height: 36px !important;
			}
			
			#subcategory-nav-container {
				top: 68px !important;
				height: 44px !important;
			}
			
			#subcategory-nav {
				padding: 0.5rem 0.75rem !important;
			}
			
			#subcategory-nav a {
				font-size: 0.813rem !important;
				padding: 0.375rem 0 !important;
			}
			
			main {
				padding-top: 112px !important;
				min-height: calc(100vh - 112px) !important;
			}
			
			html {
				scroll-padding-top: 112px !important;
			}
			
			#product-list div[class*="grid"] > div img {
				width: 85px !important;
				min-width: 85px !important;
				height: 85px !important;
			}
		}

		/* PARA DESKTOP - manter comportamento original */
		@media (min-width: 769px) {
			#subcategory-nav-container {
				position: sticky;
				top: 72px;
				z-index: 10;
			}
			
			header {
				position: sticky;
				top: 0;
				z-index: 20;
				height: auto !important;
				padding: 1rem 1.5rem !important;
			}
			
			main {
				padding-top: 2rem !important;
				min-height: auto !important;
			}
			
			html {
				scroll-padding-top: 140px !important;
			}
		}
	</style>
	
        <script src="./mapsApiConfig.js"></script>
		
</head>
<body class="bg-pink-50">
    <!-- CABEÇALHO -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-3 py-4 flex justify-between items-center">
            <a href="https://www.anaguimaraesdoceria.com.br" class="flex items-center space-x-4">
                <img src="/logotipo.png" alt="Logotipo" class="h-10">
                <h1 class="text-2xl font-bold text-pink-600">Nosso Cardápio</h1>
            </a>
            <button id="cart-button" class="relative">
                <i class="fa-solid fa-shopping-cart text-2xl text-gray-600"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </header>
    
    <!-- NAVEGAÇÃO DE SUBCATEGORIAS -->
    <nav id="subcategory-nav-container" class="bg-white sticky top-[64px] md:top-[72px] z-10 shadow-sm">
        <div id="subcategory-nav" class="container mx-auto px-6 flex items-center space-x-6 overflow-x-auto whitespace-nowrap"></div>
    </nav>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="container mx-auto px-6 py-8">
        <div id="product-list" class="space-y-12">
            <div id="loading-message" class="col-span-full flex flex-col items-center justify-center py-16">
                <div class="loader"></div>
                <p class="text-pink-600 mt-4">Carregando nosso cardápio...</p>
            </div>
        </div>
    </main>

    <!-- MODAIS -->

    <!-- Modal do Carrinho -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Seu Pedido</h2>
                <button id="close-cart" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="cart-items" class="p-6 max-h-80 overflow-y-auto"></div>
            <div class="p-6 border-t space-y-4">
                <div id="cart-summary" class="space-y-1 text-gray-700">
                    <div class="flex justify-between"><span>Subtotal:</span><span id="cart-subtotal">R$ 0,00</span></div>
                    <div id="discount-line" class="flex justify-between text-green-600 hidden"><span>Desconto:</span><span id="cart-discount"></span></div>
                    <div id="shipping-line" class="flex justify-between hidden"><span>Frete:</span><span id="cart-shipping">R$ 0,00</span></div>
                    <div class="flex justify-between items-center font-bold text-xl"><span>Total:</span><span id="cart-total">R$ 0,00</span></div>
                </div>
                <button id="checkout-button" class="w-full bg-pink-600 text-white py-3 rounded-lg mt-2 font-bold hover:bg-pink-700 transition-colors">Finalizar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Identificação -->
    <div id="identification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Como deseja continuar?</h2>
            <p class="text-gray-600 mb-6">Você pode buscar seu cadastro ou continuar como visitante.</p>
            <div class="space-y-4">
                <button id="use-phone-button" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-mobile-screen-button"></i> Usar número de celular
                </button>
                <button id="continue-guest-button" class="w-full bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700 transition-colors">Continuar sem cadastro</button>
                <button id="close-identification-modal" class="text-sm text-gray-500 mt-4 hover:underline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Login com Telefone -->
    <div id="phone-login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Identificar Cliente</h2>
                <button id="close-phone-login-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Digite seu número de celular para buscar seu cadastro.</p>
                <input id="phone-input" type="tel" placeholder="(00) 00000-0000" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                <p id="phone-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t">
                <button id="search-phone-button" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700 transition-colors">Buscar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Dados do Cliente (Novo/Edição) -->
    <div id="customer-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="customer-modal-title" class="text-2xl font-bold text-pink-600"></h2>
                <button id="close-customer-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="customer-form" class="space-y-4">
                    <p class="text-gray-600">Telefone: <strong id="customer-modal-phone"></strong></p>
                    <div>
                        <label for="customer-modal-name" class="block text-sm font-medium text-gray-700">Nome Completo *</label>
                        <input id="customer-modal-name" type="text" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label for="customer-modal-birthdate" class="block text-sm font-medium text-gray-700">Data de Nascimento *</label>
                        <input id="customer-modal-birthdate" type="date" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <p id="customer-modal-error" class="text-red-500 text-sm hidden"></p>
                </form>
            </div>
            <div id="customer-modal-footer" class="p-6 border-t flex gap-3">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

	<!-- Modal de Gerenciamento de Endereço -->
	<div id="address-management-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
		<div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
			<div class="p-6 border-b bg-white flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-pink-600">Seus Endereços</h2>
                    <p class="text-gray-600 mt-1">Olá, <strong id="confirm-customer-name"></strong>!</p>
                </div>
                <button id="edit-profile-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-600 text-sm flex items-center gap-2">
                    <i class="fa-solid fa-user-pen"></i> Editar Perfil
                </button>
            </div>
			
			<div class="p-6 overflow-y-auto flex-grow">
				<!-- Lista de Endereços Existentes -->
				<div id="address-list" class="space-y-4 mb-6">
					<!-- Endereços serão carregados aqui dinamicamente -->
				</div>

				<!-- Botão para Adicionar Novo Endereço -->
				<div class="border-t pt-6">
					<button id="show-new-address-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
						<i class="fa-solid fa-plus-circle"></i>
						Adicionar Novo Endereço
					</button>
				</div>

				<!-- Seção de Novo Endereço (inicialmente oculta) -->
				<div id="new-address-section" class="hidden mt-6 border-t pt-6">
					<h3 class="text-xl font-bold text-gray-800 mb-4">Novo Endereço</h3>
					
					<div class="space-y-4">
						<!-- Formulário de Endereço -->
						<div class="space-y-4">
							<!-- Container para o mapa e input -->
							<div id="address-map-container" class="relative">
								<!-- O mapa ou o placeholder serão inseridos aqui via JS -->
							</div>
							
							<!-- Rua, Número e Complemento -->
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
									<div>
											<label class="block text-sm font-medium text-gray-700 mb-2">Rua *</label>
											<input id="manual-address-street" type="text" placeholder="Rua"
													   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
									</div>
									<div>
											<label class="block text-sm font-medium text-gray-700 mb-2">Número/Quadra, Lote *</label>
											<input id="manual-address-number" type="text" placeholder="Número/Quadra, Lote"
													   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
									</div>
									<div class="md:col-span-2">
											<label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
											<input id="manual-address-complement" type="text" placeholder="Apto, Bloco, etc."
													   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
									</div>
							</div>

							<!-- Bairro, Cidade e CEP -->
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Bairro *</label>
									<input id="manual-address-neighborhood" type="text" placeholder="Bairro" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
									<input id="manual-address-city" type="text" placeholder="Cidade" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors" value="Goiânia">
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
									<input id="manual-address-zip" type="text" placeholder="CEP" 
										   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
								</div>
							</div>
                             <!-- Endereço Completo (oculto, preenchido pelo mapa) -->
							<!-- Apelido do Endereço -->
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">Apelido do endereço *</label>
								<input id="manual-address-nickname" type="text" placeholder="Como você chama este endereço? (Ex: Casa, Trabalho)" 
									   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
							</div>
						</div>

						<!-- Botões de Ação -->
						<div class="flex gap-3 pt-4">
							<button id="save-manual-address-button" 
									class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
								<i class="fa-solid fa-save"></i>
								Salvar Endereço
							</button>
							<button id="cancel-new-address-button" 
									class="bg-gray-500 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-600 transition-colors">
								Cancelar
							</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Rodapé do Modal -->
			<div class="p-6 border-t bg-gray-50">
				<button id="close-address-management-modal" class="w-full bg-gray-500 text-white py-3 rounded-lg font-bold hover:bg-gray-600 transition-colors">
					Fechar
				</button>
			</div>
		</div>
	</div>

    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <button id="back-to-address" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-pink-600 text-center flex-grow">Forma de Pagamento</h2>
                <button id="close-payment-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm">
                    <p class="text-gray-500">Entregar em:</p>
                    <p id="selected-address-text" class="font-semibold text-gray-800"></p>
                </div>
                <div class="space-y-2 mb-4">
                    <div class="flex gap-2">
                        <input id="payment-cupom-input" type="text" placeholder="Tem um cupom?" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 uppercase">
                        <button id="payment-verify-cupom-button" class="bg-gray-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-700 transition-colors flex-shrink-0">Aplicar</button>
                    </div>
                    <p id="payment-cupom-message" class="text-sm"></p>
                </div>
                <div id="payment-summary" class="mb-4 p-4 border rounded-lg space-y-2">
                    <h3 class="font-bold text-gray-700">Resumo do Pedido</h3>
                    <div class="flex justify-between text-sm"><span>Subtotal Produtos:</span><span id="payment-subtotal" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div id="payment-discount-row" class="flex justify-between text-sm text-green-600 hidden"><span>Desconto:</span><span id="payment-discount" class="font-medium">- R$ 0,00</span></div>
                    <div id="payment-shipping-row" class="flex justify-between text-sm"><span>Frete:</span><span id="payment-shipping" class="font-medium text-gray-800">R$ 0,00</span></div>
                    <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Total a pagar:</span><span id="payment-total" class="text-pink-600">R$ 0,00</span></div>
                </div>
                <p class="text-gray-600 mb-4">Selecione como você prefere pagar.</p>
                <select id="payment-method-select" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                    <option value="" disabled selected>Escolha uma opção...</option>
                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                    <option value="Cartão de Débito">Cartão de Débito</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Link de Pagamento">Link de Pagamento</option>
                </select>
                <p id="payment-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t">
                <button id="confirm-order-button" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700 transition-colors">Confirmar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Checkout do Visitante -->
    <div id="guest-checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-pink-600">Informações para Entrega</h2>
                <button id="close-guest-checkout-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- Dados Pessoais -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Seus Dados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="guest-name" type="text" placeholder="Seu nome completo *" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <input id="guest-phone" type="tel" placeholder="Seu telefone (WhatsApp) *" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                </div>

                <!-- Endereço de Entrega com Mapa -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Endereço de Entrega</h3>
                    <div id="guest-address-map-container" class="relative">
                        <!-- O mapa será inserido aqui -->
                    </div>
                    <div class="space-y-4 mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="guest-address-street" class="block text-sm font-medium text-gray-700 mb-2">Rua *</label>
                                <input id="guest-address-street" type="text" placeholder="Rua" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                            </div>
                            <div>
                                <label for="guest-address-number" class="block text-sm font-medium text-gray-700 mb-2">Número/Quadra, Lote *</label>
                                <input id="guest-address-number" type="text" placeholder="Número/Quadra, Lote" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                            </div>
                            <div class="md:col-span-2">
                                <label for="guest-address-complement" class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                                <input id="guest-address-complement" type="text" placeholder="Apto, Bloco, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="guest-address-neighborhood" class="block text-sm font-medium text-gray-700 mb-2">Bairro *</label>
                                <input id="guest-address-neighborhood" type="text" placeholder="Bairro" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                            </div>
                            <div>
                                <label for="guest-address-city" class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
                                <input id="guest-address-city" type="text" placeholder="Cidade" value="Goiânia" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                            </div>
                            <div>
                                <label for="guest-address-zip" class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                                <input id="guest-address-zip" type="text" placeholder="CEP" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                            </div>
                        </div>
                            <label for="guest-address-nickname" class="block text-sm font-medium text-gray-700 mb-2">Apelido do endereço *</label>
                            <input id="guest-address-nickname" type="text" placeholder="Como você chama este endereço? (Ex: Casa, Trabalho)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                        </div>
                    </div>
                    <input id="guest-address-full" type="hidden"> <!-- Campo oculto para endereço completo -->
                </div>


                <!-- Resumo e Pagamento -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Resumo e Pagamento</h3>
                    <div id="guest-summary" class="mb-4 p-4 border rounded-lg space-y-2">
                        <div class="flex justify-between text-sm"><span>Subtotal Produtos:</span><span id="guest-subtotal" class="font-medium text-gray-800">R$ 0,00</span></div>
                        <div id="guest-discount-row" class="flex justify-between text-sm text-green-600 hidden"><span>Desconto:</span><span id="guest-discount" class="font-medium">- R$ 0,00</span></div>
                        <div id="guest-shipping-row" class="flex justify-between text-sm"><span>Frete:</span><span id="guest-shipping" class="font-medium text-gray-800">Aguardando endereço...</span></div>
                        <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Total a pagar:</span><span id="guest-total" class="text-pink-600">R$ 0,00</span></div>
                    </div>
                    <select id="guest-payment-method" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white">
                        <option value="" disabled selected>Forma de Pagamento *</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Cartão de Débito">Cartão de Débito</option>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Link de Pagamento">Link de Pagamento</option>
                    </select>
                </div>
            </div>
            <div class="p-6 pt-0">
                <button id="send-whatsapp-button" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-2 mt-4">
                    <i class="fa-brands fa-whatsapp"></i> Finalizar e Enviar via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido (WhatsApp) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Enviado!</h2>
            <p class="text-gray-600">Obrigado! Seu pedido foi registrado e a mensagem está pronta para ser enviada.</p>
            <button id="close-confirmation" class="bg-pink-600 text-white py-2 px-6 rounded-lg mt-6 font-bold hover:bg-pink-700 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido (Plataforma) -->
    <div id="platform-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm mx-4">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Registrado!</h2>
            <p class="text-gray-600">Obrigado! Seu pedido foi enviado diretamente para a nossa plataforma.</p>
            <button id="close-platform-confirmation" class="bg-pink-600 text-white py-2 px-6 rounded-lg mt-6 font-bold hover:bg-pink-700 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden opacity-0 transform translate-y-2">
        <p id="toast-message"></p>
    </div>

    <!-- SCRIPTS -->
        <script type="module">
          import { db, doc, getDoc } from "./firebaseClientConfig.js";

          const DEFAULT_STORE_ID = 'ana-guimaraes-garavelo';
          const STORE_ID = new URLSearchParams(window.location.search).get('store') || DEFAULT_STORE_ID;
          window.STORE_ID = STORE_ID;
          const CONFIG_DOC_ID = 'config';
          const storeConfigDocPath = (...segments) => ['lojas', STORE_ID, 'configuracoes', CONFIG_DOC_ID, ...segments];
          const legacyConfigPath = (...segments) => ['lojas', STORE_ID, 'configuracoes', ...segments];

          // Variável global para armazenar os dados de frete
          window.dadosFrete = null;

          async function carregarConfiguracoesFrete() {
                try {
                  const freteSnap = await getDoc(doc(db, ...storeConfigDocPath()));
                  if (freteSnap.exists()) {
                        const data = freteSnap.data() || {};
                        window.dadosFrete = data.frete || data;
                        console.log("✅ Configurações de frete carregadas:", window.dadosFrete);
                        return;
                  }

                  const legacyFreteSnap = await getDoc(doc(db, ...legacyConfigPath('frete')));
                  if (legacyFreteSnap.exists()) {
                        window.dadosFrete = legacyFreteSnap.data();
                        console.warn("⚠️ Usando configuração legada de frete:", window.dadosFrete);
                        return;
                  }

                  const fallbackSnap = await getDoc(doc(db, 'configuracoes', 'frete'));
                  if (fallbackSnap.exists()) {
                        window.dadosFrete = fallbackSnap.data();
                        console.warn("⚠️ Usando fallback padrão de frete:", window.dadosFrete);
                  } else {
                        console.error("❌ Documento 'frete' não encontrado");
                  }
                } catch (error) {
                  console.error("Erro ao carregar frete:", error);
                }
          }

	  document.addEventListener("DOMContentLoaded", carregarConfiguracoesFrete);
	</script>

	<script>
    // --- LÓGICA DO GOOGLE MAPS (CLIENTE CADASTRADO) ---
        let map, marker, geocoder, placeAutocomplete;
    let mapsApiAvailable = true;
    let mapsErrorLogged = false;
    let geocoderErrorLogged = false;
    let guestGeocoderErrorLogged = false;
    window.currentLatLng = null;

    const saveAddressBtn = document.getElementById('save-manual-address-button');
    if(saveAddressBtn) {
        saveAddressBtn.disabled = true;
        saveAddressBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

        function markMapsUnavailable(reason) {
          mapsApiAvailable = false;
          if (!mapsErrorLogged) {
            console.error('Google Maps indisponível:', reason);
            mapsErrorLogged = true;
          }

          const warning = `<div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-lg text-sm">Não foi possível carregar o mapa agora. Preencha o endereço manualmente para continuar.</div>`;
          const containers = [
            document.getElementById('address-map-container'),
            document.getElementById('guest-address-map-container')
          ];

          containers.forEach((container) => {
            if (container && container.innerHTML.trim() === '') {
              container.innerHTML = warning;
            } else if (container) {
              container.insertAdjacentHTML('afterbegin', warning);
            }
          });

          const manualSections = [
            document.getElementById('new-address-section'),
            document.getElementById('guest-address-form')
          ];
          manualSections.forEach((section) => {
            if (section) {
              section.classList.add('ring', 'ring-amber-300', 'ring-offset-1');
            }
          });
        }

        function canUseMaps() {
          return mapsApiAvailable && window.google?.maps;
        }

        function validateAddressForm() {
          const rua = document.getElementById('manual-address-street').value.trim();
          const numero = document.getElementById('manual-address-number').value.trim();
          const bairro = document.getElementById('manual-address-neighborhood').value.trim();
          const cidade = document.getElementById('manual-address-city').value.trim();
          const apelido = document.getElementById('manual-address-nickname').value.trim();
          const hasCoords = window.currentLatLng?.lat && window.currentLatLng?.lng;
          const hasBasicInfo = rua.length > 0 && numero.length > 0 && bairro.length > 0 && cidade.length > 0 && apelido.length > 0;
          const isValid = (hasCoords && hasBasicInfo) || (!canUseMaps() && hasBasicInfo);

          if (saveAddressBtn) {
        if (isValid) {
            saveAddressBtn.disabled = false;
            saveAddressBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            saveAddressBtn.disabled = true;
            saveAddressBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
        }

    async function initAddressMap() {
        const addressMapContainer = document.getElementById('address-map-container');
        addressMapContainer.innerHTML = '';

        try {
            await window.loadGoogleMapsScript();
            mapsApiAvailable = !!window.google?.maps;
            const defaultCenter = { lat: -16.644661430463806, lng: -49.324890665224544 };
            geocoder = new google.maps.Geocoder();
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            const mapDiv = document.createElement('div');
            mapDiv.style.cssText = 'height:300px; width:100%; border-radius:0.5rem; margin-top:0.75rem;';
            
            map = new Map(mapDiv, { center: defaultCenter, zoom: 14, mapId: 'DEMO_MAP_ID' });
            marker = new AdvancedMarkerElement({ map: map, position: defaultCenter, gmpDraggable: true });
			const storeInfoWindow = new google.maps.InfoWindow({
                content: '<div style="font-weight:600;color:#db2777;font-size:0.95rem;">Ana Guimarães doceria</div>',
                disableAutoPan: true,
            });
            storeInfoWindow.open({ anchor: marker, map });
            marker.addListener('dragend', () => reverseGeocode(marker.position));
            marker.addListener('dragstart', () => storeInfoWindow.close());

                        placeAutocomplete = new google.maps.places.PlaceAutocompleteElement();
                        placeAutocomplete.className = 'w-full mb-2 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500';
                        placeAutocomplete.setAttribute('placeholder', 'Digite o endereço...');

                        placeAutocomplete.addEventListener('gmp-select', async ({ placePrediction }) => {
                          try {
                                const place = placePrediction.toPlace();
                                await place.fetchFields({ fields: ['location', 'formattedAddress', 'addressComponents'] });

                                if (place.location) {
                                  const newPosition = { lat: place.location.lat(), lng: place.location.lng() };
                                  map.setCenter(newPosition);
                                  map.setZoom(18);
                                  storeInfoWindow.close();
                                  marker.position = newPosition;
                                  reverseGeocode(newPosition); // Call the robust reverseGeocode function
                                }
                          } catch (error) {
				console.error('Erro ao buscar detalhes do local:', error);
			  }
			});

            const locationBtn = document.createElement('button');
            locationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Minha localização';
            locationBtn.className = 'w-full bg-pink-600 text-white px-3 py-2 rounded-lg font-bold mb-2 hover:bg-pink-700 transition-colors';
            locationBtn.type = 'button';
            locationBtn.onclick = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            map.panTo(coords);
                            map.setZoom(17);
							storeInfoWindow.close();
                            marker.position = coords;
                            reverseGeocode(coords);
                        },
                        (err) => alert('Não foi possível obter localização: ' + err.message)
                    );
                } else {
                    alert('Geolocalização não suportada.');
                }
            };

            addressMapContainer.append(placeAutocomplete, locationBtn, mapDiv);
            validateAddressForm();
        } catch (error) {
            markMapsUnavailable(error);
            addressMapContainer.innerHTML = `<div class="bg-amber-50 p-4 rounded-lg text-amber-800">Mapa indisponível no momento. Preencha os campos para salvar o endereço.</div>`;
        }
    }

        function reverseGeocode(latlng) {
                let normalizedLatLng = null;
		
		try {
			if (latlng && typeof latlng.lat === 'function' && typeof latlng.lng === 'function') {
				normalizedLatLng = { lat: latlng.lat(), lng: latlng.lng() };
			}
			else if (latlng && typeof latlng.lat === 'number' && typeof latlng.lng === 'number') {
				normalizedLatLng = { lat: latlng.lat, lng: latlng.lng };
			}
			else if (latlng && latlng.toJSON) { // Standard Google LatLng object
				const json = latlng.toJSON();
				normalizedLatLng = { lat: json.lat, lng: json.lng };
			}
			
			if (!normalizedLatLng || typeof normalizedLatLng.lat !== 'number' || typeof normalizedLatLng.lng !== 'number') {
				console.error('❌ Falha ao normalizar coordenadas:', latlng);
				showToast('Erro ao obter coordenadas do mapa. Tente novamente.', true);
				return;
			}
			
			window.currentLatLng = normalizedLatLng;
			
		} catch (error) {
			console.error('❌ Erro crítico ao normalizar coordenadas:', error, latlng);
			showToast('Erro ao processar localização. Tente novamente.', true);
			return;
                }

                validateAddressForm();

                if (!canUseMaps() || !geocoder) {
                  if (!geocoderErrorLogged) {
                    console.error('Geocoder indisponível para reverse geocode.');
                    geocoderErrorLogged = true;
                  }
                  return;
                }

                geocoder.geocode({ location: normalizedLatLng }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                                fillAddressFields(results[0]);
                                validateAddressForm();
                        } else {
                                console.warn('Geocodificação reversa falhou:', status);
                        }
                });
        }

        function fillAddressFields(place) {
          const rawComponents = place?.addressComponents || place?.address_components || [];
          const normalizeComponent = (component) => {
            if (!component) return null;
            const name = component.long_name || component.longName || component.name || component.short_name || component.shortName;
            return {
              value: name || '',
              types: component.types || [],
            };
          };

          const components = rawComponents
            .map(normalizeComponent)
            .filter(Boolean);

          const get = (type) => {
            const component = components.find((c) => c.types.includes(type));
            return component?.value?.trim() || '';
          };

          const formattedAddress = place?.formattedAddress || place?.formatted_address || '';
          const streetFromPlace = get('route') || formattedAddress.split(',')[0]?.trim();
          const numberFromPlace = get('street_number');
          const neighborhoodFromPlace = get('sublocality_level_1') || get('neighborhood') || get('political');
          const cityFromPlace = get('administrative_area_level_2');
          const zipFromPlace = get('postal_code');

          const addressInput = document.getElementById('manual-address-street');
          const numberInput = document.getElementById('manual-address-number');
          const neighborhoodInput = document.getElementById('manual-address-neighborhood');
          const cityInput = document.getElementById('manual-address-city');
          const zipInput = document.getElementById('manual-address-zip');

          if (streetFromPlace && addressInput) addressInput.value = streetFromPlace;
          if (numberFromPlace && numberInput && !numberInput.value) numberInput.value = numberFromPlace;
          if (neighborhoodFromPlace && neighborhoodInput) neighborhoodInput.value = neighborhoodFromPlace;
          if (cityInput && (cityFromPlace || !cityInput.value)) {
            cityInput.value = cityFromPlace || cityInput.value || 'Goiânia';
          }
          if (zipFromPlace && zipInput && !zipInput.value) zipInput.value = zipFromPlace;

          validateAddressForm();
        }

    document.getElementById('show-new-address-btn').addEventListener('click', () => {
        setTimeout(initAddressMap, 300);
    });

    ['manual-address-street','manual-address-number','manual-address-neighborhood','manual-address-city','manual-address-nickname']
    .forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', validateAddressForm);
    });
	</script>
    
    <script type="module">
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import {
            app
        } from "./firebaseClientConfig.js";

        // --- VARIÁVEIS GLOBAIS ---
        const WHATSAPP_NUMBER = '5562991056075';
        const STORE_ID = window.STORE_ID || 'ana-guimaraes-garavelo';
        const CONFIG_DOC_ID = 'config';
        const CONFIG_COLLECTIONS = new Set(['cupons', 'logs']);
        const storeConfigDocPath = (...segments) => ['lojas', STORE_ID, 'configuracoes', CONFIG_DOC_ID, ...segments];
        const legacyConfigPath = (...segments) => ['lojas', STORE_ID, 'configuracoes', ...segments];
        const legacyStorePath = (...segments) => ['lojas', STORE_ID, ...segments];
        const storePath = (...segments) => {
            if (!segments.length) return ['lojas', STORE_ID];

            const [first, ...rest] = segments;
            if (CONFIG_COLLECTIONS.has(first)) {
                return storeConfigDocPath(first, ...rest);
            }

            if (first === 'clientes') {
                return ['clientes', ...rest];
            }

            return ["lojas", STORE_ID, first, ...rest];
        };
        let allProducts = [], cart = [], currentClient = null, pendingOrderDetails = {}, appliedCupom = null;
        const subcategoryOrder = ['Queridinhos', 'Bolo no pote', 'Copo da felicidade', 'Bombom aberto', 'Pipoca', 'Cone recheado', 'Bolo gelado', 'Bombom recheado'];
        window.valorFrete = 0;
                window.guestCurrentLatLng = null;
        let storeConfig = {};

        // --- SELEÇÃO DE ELEMENTOS DOM ---
        const productList = document.getElementById('product-list'),
              subcategoryNav = document.getElementById('subcategory-nav'),
              loadingMessage = document.getElementById('loading-message'),
              cartButton = document.getElementById('cart-button'),
              cartModal = document.getElementById('cart-modal'),
              closeCartButton = document.getElementById('close-cart'),
              cartItemsContainer = document.getElementById('cart-items'),
              cartCount = document.getElementById('cart-count'),
              cartSubtotal = document.getElementById('cart-subtotal'),
              cartDiscountLine = document.getElementById('discount-line'),
              cartDiscount = document.getElementById('cart-discount'),
              cartShippingLine = document.getElementById('shipping-line'),
              cartShipping = document.getElementById('cart-shipping'),
              cartTotal = document.getElementById('cart-total'),
              checkoutButton = document.getElementById('checkout-button'),
              identificationModal = document.getElementById('identification-modal'),
              usePhoneButton = document.getElementById('use-phone-button'),
              continueGuestButton = document.getElementById('continue-guest-button'),
              closeIdentificationModal = document.getElementById('close-identification-modal'),
              
              guestCheckoutModal = document.getElementById('guest-checkout-modal'),
              closeGuestCheckoutModal = document.getElementById('close-guest-checkout-modal'),
              sendWhatsappButton = document.getElementById('send-whatsapp-button'),
              guestNameInput = document.getElementById('guest-name'),
              guestPhoneInput = document.getElementById('guest-phone'),
              guestAddressFullInput = document.getElementById('guest-address-full'),
              guestAddressNumberInput = document.getElementById('guest-address-number'),
              guestAddressComplementInput = document.getElementById('guest-address-complement'),
              guestPaymentMethodSelect = document.getElementById('guest-payment-method'),

              phoneLoginModal = document.getElementById('phone-login-modal'),
              closePhoneLoginModal = document.getElementById('close-phone-login-modal'),
              phoneInput = document.getElementById('phone-input'),
              phoneError = document.getElementById('phone-error'),
              searchPhoneButton = document.getElementById('search-phone-button'),
              addressManagementModal = document.getElementById('address-management-modal'),
              addressModalTitle = document.getElementById('address-modal-title'),
              confirmCustomerName = document.getElementById('confirm-customer-name'),
              addressList = document.getElementById('address-list'),
              closeAddressManagementModal = document.getElementById('close-address-management-modal'),
              paymentModal = document.getElementById('payment-modal'),
              closePaymentModal = document.getElementById('close-payment-modal'),
              backToAddressButton = document.getElementById('back-to-address'),
              selectedAddressText = document.getElementById('selected-address-text'),
              paymentMethodSelect = document.getElementById('payment-method-select'),
              confirmOrderButton = document.getElementById('confirm-order-button'),
              paymentError = document.getElementById('payment-error'),
              confirmationModal = document.getElementById('confirmation-modal'),
              closeConfirmationButton = document.getElementById('close-confirmation'),
              platformConfirmationModal = document.getElementById('platform-confirmation-modal'),
              closePlatformConfirmationButton = document.getElementById('close-platform-confirmation'),
              toast = document.getElementById('toast'),
              toastMessage = document.getElementById('toast-message'),
              paymentCupomInput = document.getElementById('payment-cupom-input'),
              paymentVerifyCupomButton = document.getElementById('payment-verify-cupom-button'),
              paymentCupomMessage = document.getElementById('payment-cupom-message');

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        window.appInitialized = false;

        async function startAppFlow(reason = 'sessão anônima') {
            if (window.appInitialized) return;
            window.appInitialized = true;
            try {
                console.log(`🚀 Inicializando aplicação (${reason})...`);
                await fetchStoreConfig();
                await fetchProducts();
                setupEventListeners();
                renderCart();
                console.log("✅ Aplicação inicializada com sucesso!");
            } catch (error) {
                console.error('❌ Erro ao carregar a aplicação:', error);
                showToast('Erro ao carregar a aplicação.', true);
            }
        }

        async function initApp() {
            if (window.appInitialized) return;
            try {
                if (window.firebaseAnonAuthUnavailable) {
                    console.warn('⚠️ Autenticação anônima desativada; iniciando em modo visitante.');
                    await startAppFlow('modo visitante');
                    return;
                }

                const auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("✅ Usuário autenticado anonimamente:", user.uid);
                        await startAppFlow('sessão anônima');
                        return;
                    }

                    if (window.firebaseAnonAuthUnavailable) {
                        console.warn('⚠️ Autenticação anônima desativada; prosseguindo sem login.');
                        await startAppFlow('modo visitante');
                        return;
                    }

                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.warn("⚠️ Falha no login anônimo, continuando sem autenticação:", error);
                        await startAppFlow('modo visitante');
                    }
                });
            } catch (error) {
                console.error('❌ Erro ao inicializar aplicação:', error);
                await startAppFlow('falha na autenticação');
            }
        }

        // --- FUNÇÕES PRINCIPAIS ---

        // Funções de Produtos
        async function fetchStoreConfig() {
            try {
                const { db, doc, getDoc } = await import('./firebaseClientConfig.js');
                const configDoc = await getDoc(doc(db, ...storeConfigDocPath()));
                if (configDoc.exists()) {
                    const data = configDoc.data() || {};
                    storeConfig = data.frete || data;
                    console.log("✅ Configurações da loja carregadas:", storeConfig);
                    return;
                }

                const storeConfigDoc = await getDoc(doc(db, ...storePath("info", "dados")));

                if (storeConfigDoc.exists()) {
                    const data = storeConfigDoc.data();
                    storeConfig = data?.frete || data || {};
                    console.log("✅ Configurações da loja carregadas:", storeConfig);
                    return;
                }

                const legacyFreteDoc = await getDoc(doc(db, ...legacyConfigPath('frete')));
                if (legacyFreteDoc.exists()) {
                    storeConfig = legacyFreteDoc.data();
                    console.log("⚠️ Usando configuração legada da loja:", storeConfig);
                    return;
                }

                const fallbackConfig = await getDoc(doc(db, "configuracoes", "frete"));
                if (fallbackConfig.exists()) {
                    storeConfig = fallbackConfig.data();
                    console.log("⚠️ Configurações específicas não encontradas. Usando fallback padrão:", storeConfig);
                }
            } catch (error) {
                console.error("Erro ao carregar configurações:", error);
            }
        }

        async function fetchProducts() {
            try {
                console.log("🔄 Buscando produtos do Firebase...");
                
                const { db, collection, getDocs } = await import('./firebaseClientConfig.js');

                const productsSnapshot = await getDocs(collection(db, ...storePath("produtos")));
                const products = productsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                allProducts = products.filter((product) => {
                    const status = product.status || 'Ativo';
                    const isExplicitlyInactive = product.ativo === false || status === 'Inativo';

                    return !isExplicitlyInactive && status === 'Ativo';
                });
                
                console.log(`✅ ${allProducts.length} produtos carregados`);
                
                if (allProducts.length === 0) {
                    throw new Error('Nenhum produto encontrado');
                }
                
                renderMenu();
                
            } catch (error) { 
                console.error("❌ Erro ao buscar produtos:", error);
                loadingMessage.innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 text-lg font-bold mb-2">Erro ao carregar o cardápio</p>
                        <p class="text-gray-600 text-sm">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700">
                            Tentar Novamente
                        </button>
                    </div>
                `;
                showToast("Erro ao buscar produtos: " + error.message, true);
            } finally { 
                loadingMessage.style.display = 'none'; 
            }
        }

        function renderMenu() {
            const deliveryProducts = allProducts.filter(p => p.categoria === 'Delivery');
            
            if (deliveryProducts.length === 0) {
                productList.innerHTML = `
                    <div class="text-center py-16">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-gray-600 text-lg">Nenhum produto disponível para delivery no momento.</p>
                    </div>
                `;
                return;
            }

            const productsBySubcategory = deliveryProducts.reduce((acc, product) => { 
                const sub = product.subcategoria || 'Outros'; 
                if (!acc[sub]) acc[sub] = []; 
                acc[sub].push(product); 
                return acc; 
            }, {});
            
            const availableSubcategories = subcategoryOrder.filter(sub => productsBySubcategory[sub]?.length > 0);
            const otherSubcategories = Object.keys(productsBySubcategory)
                .filter(sub => !subcategoryOrder.includes(sub) && productsBySubcategory[sub]?.length > 0);
            
            const allSubcategories = [...availableSubcategories, ...otherSubcategories];
            
            productList.innerHTML = ''; 
            subcategoryNav.innerHTML = '';
            
            allSubcategories.forEach(sub => { 
                const slug = sub.toLowerCase().replace(/\s+/g, '-'); 
                const link = document.createElement('a'); 
                link.href = `#${slug}`; 
                link.textContent = sub; 
                link.className = 'py-4 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:text-pink-600 transition-colors'; 
                subcategoryNav.appendChild(link); 
            });
            
            allSubcategories.forEach(sub => { 
                const slug = sub.toLowerCase().replace(/\s+/g, '-'); 
                const section = document.createElement('section'); 
                section.id = slug;
                section.className = 'mb-12';
                
                section.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-2">${sub}</h2>
                `; 
                
                const grid = document.createElement('div'); 
                grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6';
                
                productsBySubcategory[sub].forEach(product => { 
                    grid.innerHTML += createProductCard(product); 
                });
                
                section.appendChild(grid); 
                productList.appendChild(section);
            });
            
            setupScrollSpy();
        }

        function createProductCard(product) {
            const isOutOfStock = product.estoque !== null && product.estoque <= 0;
            const imageUrl = product.imageUrl || 'https://placehold.co/600x400/FFC0CB/FFFFFF?text=Doce+Ana+Guimarães';
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col h-full transform hover:scale-105 transition-transform duration-300 ${isOutOfStock ? 'opacity-50 grayscale' : ''}">
                    <img src="${imageUrl}" alt="${product.nome}" 
                         class="w-full h-48 object-cover" 
                         onerror="this.src='https://placehold.co/600x400/FFC0CB/FFFFFF?text=Doce+Ana+Guimarães'">
                    <div class="p-4 flex flex-col flex-grow justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 leading-tight mb-2">${product.nome}</h3>
                            <p class="text-gray-600 text-sm mb-3">${product.descricao || 'Delicioso produto da Ana Guimarães Doceria'}</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-lg font-bold text-pink-600">R$ ${product.preco?.toFixed(2) || '0,00'}</span>
                            <button class="bg-pink-600 text-white font-bold py-2 px-4 rounded-md hover:bg-pink-700 transition-colors ${isOutOfStock ? 'cursor-not-allowed bg-gray-300' : ''}" 
                                    onclick="addToCart('${product.id}')" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Esgotado' : 'Adicionar'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funções do Carrinho
        window.addToCart = (productId) => {
            const product = allProducts.find(p => p.id === productId); 
            if (!product) {
                showToast('Produto não encontrado!', true);
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            if (product.estoque !== null && (existingItem?.quantity || 0) >= product.estoque) { 
                showToast('Quantidade máxima em estoque atingida!', true); 
                return; 
            }
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ 
                    id: product.id,
                    nome: product.nome,
                    preco: product.preco,
                    quantity: 1 
                });
            }
            
            renderCart();
            showToast(`${product.nome} adicionado ao carrinho!`);
        };

        window.removeFromCart = (productId) => { 
            cart = cart.filter(item => item.id !== productId); 
            renderCart(); 
            showToast('Item removido do carrinho', true);
        };

        window.updateQuantity = (productId, change) => {
            const item = cart.find(item => item.id === productId); 
            if (!item) return;
            
            if (change > 0) { 
                const product = allProducts.find(p => p.id === productId); 
                if (product.estoque !== null && item.quantity >= product.estoque) { 
                    showToast('Quantidade máxima em estoque atingida!', true); 
                    return; 
                } 
            }
            
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
        };

        function renderCart() {
            cartItemsContainer.innerHTML = cart.length === 0 
                ? '<p class="text-gray-500 text-center py-8">Seu carrinho está vazio.</p>' 
                : cart.map(item => `
                    <div class="flex justify-between items-center mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${item.nome}</p>
                            <p class="text-sm text-gray-500">R$ ${item.preco.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center" 
                                    onclick="updateQuantity('${item.id}', -1)">-</button>
                            <span class="font-semibold min-w-8 text-center">${item.quantity}</span>
                            <button class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center" 
                                    onclick="updateQuantity('${item.id}', 1)">+</button>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 ml-2">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            
            updateCartInfo();
        }

		function updateCartInfo() {
			const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			const desconto = appliedCupom?.valorDesconto || 0;
			const total = subtotal - desconto + window.valorFrete;
			
			cartCount.textContent = totalItems;
			cartSubtotal.textContent = `R$ ${subtotal.toFixed(2)}`;
			cartTotal.textContent = `R$ ${total.toFixed(2)}`;
			
			if (desconto > 0) {
				cartDiscount.textContent = `- R$ ${desconto.toFixed(2)}`;
				cartDiscountLine.classList.remove('hidden');
			} else {
				cartDiscountLine.classList.add('hidden');
			}
			
			if (window.valorFrete > 0) {
				cartShipping.textContent = `R$ ${window.valorFrete.toFixed(2)}`;
				cartShippingLine.classList.remove('hidden');
			} else {
                // Modificação para mostrar R$ 0,00 se o frete for zero, mesmo se a linha não estiver oculta (caso de retirada)
				cartShipping.textContent = `R$ 0,00`; 
                // A linha só fica oculta se não for retirada na loja E o frete for zero.
                // Se for retirada na loja, a linha aparece, mas com valor R$ 0,00.
                if (pendingOrderDetails?.clienteEndereco !== "Retirar na Loja") {
				    cartShippingLine.classList.add('hidden');
                } else {
                    cartShippingLine.classList.remove('hidden'); // Garante que a linha apareça para Retirada
                }
			}
		}


        // Funções de Navegação
        function setupScrollSpy() {
            const sections = document.querySelectorAll('#product-list section');
            const navLinks = document.querySelectorAll('#subcategory-nav a');
            
            if (sections.length === 0 || navLinks.length === 0) return;
            
            const observer = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    if (entry.isIntersecting && entry.target.id) { 
                        navLinks.forEach(link => { 
                            const targetId = (link.getAttribute('href') || '').substring(1);
                            link.classList.toggle('active', targetId === entry.target.id);
                            if (targetId === entry.target.id) {
                                link.style.color = '#db2777';
                                link.style.borderBottomColor = '#db2777';
                            } else {
                                link.style.color = '';
                                link.style.borderBottomColor = '';
                            }
                        }); 
                    } 
                }); 
            }, { rootMargin: '-150px 0px -50% 0px', threshold: 0.1 });
            
            sections.forEach(section => observer.observe(section));
        }

        // Toast Notifications
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { 
                toast.classList.remove('opacity-0', 'translate-y-2'); 
            }, 10);
            setTimeout(() => { 
                toast.classList.add('opacity-0', 'translate-y-2'); 
                setTimeout(() => toast.classList.add('hidden'), 500); 
            }, 3000);
        }
        window.showToast = showToast;

        // Event Listeners
        function setupEventListeners() {
            cartButton.addEventListener('click', () => cartModal.classList.remove('hidden'));
            closeCartButton.addEventListener('click', () => cartModal.classList.add('hidden'));
            
            checkoutButton.addEventListener('click', () => { 
                if (cart.length === 0) { 
                    showToast('Seu carrinho está vazio!', true); 
                    return; 
                } 
                cartModal.classList.add('hidden'); 
                identificationModal.classList.remove('hidden'); 
            });
            
            closeIdentificationModal.addEventListener('click', () => identificationModal.classList.add('hidden'));
            
            usePhoneButton.addEventListener('click', () => { 
                identificationModal.classList.add('hidden'); 
                phoneLoginModal.classList.remove('hidden'); 
                phoneInput.value = ''; 
                phoneError.classList.add('hidden'); 
            });
            
            closePhoneLoginModal.addEventListener('click', () => { 
                phoneLoginModal.classList.add('hidden'); 
                currentClient = null; 
            });

            continueGuestButton.addEventListener('click', () => {
                identificationModal.classList.add('hidden');
                guestCheckoutModal.classList.remove('hidden');
                window.valorFrete = 0;
                window.guestCurrentLatLng = null;
                updateGuestSummary();
                setTimeout(window.initGuestAddressMap, 300);
            });

            closeGuestCheckoutModal.addEventListener('click', () => {
                guestCheckoutModal.classList.add('hidden');
                window.guestCurrentLatLng = null;
            });

            searchPhoneButton.addEventListener('click', handlePhoneSearch);

            document.getElementById('close-customer-modal').addEventListener('click', () => {
                document.getElementById('customer-details-modal').classList.add('hidden');
            });
            
            document.getElementById('edit-profile-btn').addEventListener('click', () => {
                if (currentClient) {
                    addressManagementModal.classList.add('hidden');
                    openCustomerModalForEdit(currentClient);
                }
            });

            document.getElementById('show-new-address-btn').addEventListener('click', showNewAddressSection);
            document.getElementById('cancel-new-address-button').addEventListener('click', cancelNewAddress);
            document.getElementById('save-manual-address-button').addEventListener('click', saveManualAddress);

            closeAddressManagementModal.addEventListener('click', () => { 
                addressManagementModal.classList.add('hidden'); 
                currentClient = null; 
            });

            closePaymentModal.addEventListener('click', () => paymentModal.classList.add('hidden'));
            backToAddressButton.addEventListener('click', () => { 
                paymentModal.classList.add('hidden'); 
                addressManagementModal.classList.remove('hidden'); 
            });

            sendWhatsappButton.addEventListener('click', handleGuestOrder);
            confirmOrderButton.addEventListener('click', handlePlatformOrder);

            closeConfirmationButton.addEventListener('click', () => { 
                confirmationModal.classList.add('hidden'); 
                location.reload(); 
            });
            closePlatformConfirmationButton.addEventListener('click', () => { 
                platformConfirmationModal.classList.add('hidden'); 
                location.reload(); 
            });

            if (paymentVerifyCupomButton) paymentVerifyCupomButton.addEventListener('click', () => handleVerifyCupom('payment'));
        
            ['guest-address-street', 'guest-address-number', 'guest-address-neighborhood', 'guest-address-city'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('blur', async () => {
                        const street = document.getElementById('guest-address-street').value.trim();
						const number = document.getElementById('guest-address-number').value.trim();
                        const neighborhood = document.getElementById('guest-address-neighborhood').value.trim();
                        const city = document.getElementById('guest-address-city').value.trim() || 'Goiânia';

                        if (street && number && neighborhood && city) {
                            const fullAddressForGeocode = `${street}, ${number}, ${neighborhood}, ${city}`;

                            try {
                                if (!canUseMaps()) {
                                    window.updateGuestShippingAndSummary(null);
                                    return;
                                }

                                await window.aguardarGoogleMaps();
                                const geocoder = new google.maps.Geocoder();
                                geocoder.geocode({ address: fullAddressForGeocode }, (results, status) => {
                                    if (status === 'OK' && results[0]) {
                                        const location = results[0].geometry.location;
                                        const latlng = { lat: location.lat(), lng: location.lng() };
                                        fillGuestAddressFields(results[0]);
                                        window.guestCurrentLatLng = latlng;
                                        window.updateGuestShippingAndSummary(latlng);
                                    } else {
                                        console.warn('Não foi possível geocodificar o endereço digitado:', status);
                                        showToast('Endereço não encontrado para cálculo. Tente mover o pino no mapa.', true);
                                    }
                                });
                            } catch (error) {
                                markMapsUnavailable(error);
                                console.error('Erro ao geocodificar endereço do visitante:', error);
                            }
                        } else {
                            window.guestCurrentLatLng = null;
                            window.valorFrete = 0;
                            updateGuestSummary();
                        }
                    });
                }
            });
        }

        function showNewAddressSection() {
            document.getElementById('new-address-section').classList.remove('hidden');
            document.getElementById('show-new-address-btn').classList.add('hidden');
        }

        function cancelNewAddress() {
            document.getElementById('new-address-section').classList.add('hidden');
            document.getElementById('show-new-address-btn').classList.remove('hidden');
        }

        async function saveManualAddress() {
            const nickname = document.getElementById('manual-address-nickname').value.trim();
            const street = document.getElementById('manual-address-street').value.trim();
            const number = document.getElementById('manual-address-number').value.trim();
            const complement = document.getElementById('manual-address-complement').value.trim();
            const neighborhood = document.getElementById('manual-address-neighborhood').value.trim();
            const city = document.getElementById('manual-address-city').value.trim();
            const zip = document.getElementById('manual-address-zip').value.trim();

                        if (canUseMaps() && (!window.currentLatLng || typeof window.currentLatLng.lat === 'undefined' || typeof window.currentLatLng.lng === 'undefined')) {
                                showToast("Selecione a localização no mapa antes de salvar.", true);
                                return;
                        }

                        if (!street) {
                                        showToast("Informe a rua do endereço.", true);
                                        return;
                        }

			if (!number) {
					showToast("Informe o número, quadra ou lote.", true);
					return;
			}

			if (!nickname) {
					showToast("Digite um apelido para o endereço.", true);
					return;
			}

            const addressText = `${street}${number ? ', ' + number : ''}${complement ? ' - ' + complement : ''}${neighborhood ? ', ' + neighborhood : ''}${city ? ', ' + city : ''}${zip ? ' - CEP: ' + zip : ''}`;

            try {
                const { db, doc, getDoc, updateDoc } = await import('./firebaseClientConfig.js');
                const clientDocRef = doc(db, ...storePath("clientes", currentClient.id));
                
                const clientSnap = await getDoc(clientDocRef);
                if (!clientSnap.exists()) {
                    throw new Error("Cliente não encontrado para atualizar endereço.");
                }
                const existingAddresses = clientSnap.data().enderecos || [];

                const lat = canUseMaps() ? parseFloat(window.currentLatLng?.lat) : null;
                const lng = canUseMaps() ? parseFloat(window.currentLatLng?.lng) : null;

                if (canUseMaps() && (isNaN(lat) || isNaN(lng))) {
                    showToast("Localização inválida. Tente selecionar novamente no mapa.", true);
                    return;
                }

                const newAddress = {
                    enderecoCompleto: addressText,
                    nickname: nickname,
                    lat: lat,
                    lng: lng,
                    criadoEm: new Date().toISOString()
                };

                existingAddresses.push(newAddress);

                await updateDoc(clientDocRef, {
                    enderecos: existingAddresses
                });
                
                currentClient.enderecos = existingAddresses;

                showToast("✅ Endereço salvo com sucesso!");
                cancelNewAddress();
                openAddressManagementModal(currentClient);

            } catch (error) {
                console.error("Erro ao salvar endereço:", error);
                showToast("❌ Erro ao salvar o endereço: " + error.message, true);
            }
        }

		function openAddressManagementModal(client) {
			currentClient = client;
			addressList.innerHTML = '';
			confirmCustomerName.textContent = client.nome || 'Cliente';
			
			document.getElementById('new-address-section').classList.add('hidden');
			document.getElementById('show-new-address-btn').classList.remove('hidden');
			
            /* === INÍCIO DA MODIFICAÇÃO === */
			/* Adiciona a opção "Retirar na Loja" primeiro */
			const pickupCard = document.createElement('div');
			pickupCard.className = 'bg-white border border-blue-300 rounded-lg p-4 hover:shadow-md transition-shadow mb-4';
			pickupCard.innerHTML = `
				<div class="flex items-center justify-between gap-2 mb-2">
					<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">Opção Padrão</span>
				</div>
				<p class="text-gray-800 font-medium text-base leading-tight flex items-center gap-2">
					<i class="fa-solid fa-store text-blue-600"></i>
					<strong>Retirar na Loja</strong>
				</p>
				<p class="text-xs text-gray-500 mt-1">Nenhuma taxa de frete será aplicada.</p>
				<button class="w-full mt-3 bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 use-pickup-btn"><i class="fa-solid fa-person-walking"></i> Selecionar Retirada</button>
			`;
            // Atribui o novo handler
			pickupCard.querySelector('.use-pickup-btn').onclick = usePickupAddress;
			addressList.appendChild(pickupCard);
            /* === FIM DA MODIFICAÇÃO === */

			if (client.enderecos && client.enderecos.length > 0) {
				client.enderecos.forEach((address, index) => {
					const { enderecoCompleto, nickname } = (typeof address === 'string') 
                        ? { enderecoCompleto: address, nickname: `Endereço ${index + 1}` } 
                        : { enderecoCompleto: address.enderecoCompleto, nickname: address.nickname || `Endereço ${index + 1}`};
					
					const addressDiv = document.createElement('div');
					addressDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow mb-4';
					addressDiv.innerHTML = `
						<div class="flex items-center justify-between gap-2 mb-2">
							<span class="bg-pink-100 text-pink-800 text-xs font-medium px-2 py-1 rounded">${nickname}</span>
							<button class="text-red-500 hover:text-red-700 transition-colors delete-address-btn" title="Excluir endereço"><i class="fa-solid fa-trash-alt text-lg"></i></button>
						</div>
						<p class="text-gray-800 font-medium text-sm leading-tight">${enderecoCompleto}</p>
						<button class="w-full mt-3 bg-pink-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-pink-700 transition-colors flex items-center justify-center gap-2 use-address-btn"><i class="fa-solid fa-truck"></i> Usar este Endereço</button>
					`;
					
					addressDiv.querySelector('.use-address-btn').onclick = () => useExistingAddress(enderecoCompleto, address);
					addressDiv.querySelector('.delete-address-btn').onclick = (e) => { e.stopPropagation(); deleteAddress(index); };
					addressList.appendChild(addressDiv);
				});
			} 
            // O 'else' block que exibia "Nenhum endereço cadastrado" foi removido 
            // para não apagar a opção "Retirar na Loja".
			addressManagementModal.classList.remove('hidden');
		}
		
		async function deleteAddress(addressIndex) {
			if (!confirm('Tem certeza que deseja excluir este endereço?')) return;

			try {
                           const { db, doc, getDoc, updateDoc } = await import('./firebaseClientConfig.js');
                           const clientDocRef = doc(db, ...storePath('clientes', currentClient.id));
				const clientSnap = await getDoc(clientDocRef);
				if (!clientSnap.exists()) {
                    throw new Error('Cliente não encontrado.');
                }

				const existingAddresses = clientSnap.data().enderecos || [];
				
                existingAddresses.splice(addressIndex, 1);

				await updateDoc(clientDocRef, {
                    enderecos: existingAddresses
                });
				
                currentClient.enderecos = existingAddresses;
				
                showToast('Endereço excluído!');
				openAddressManagementModal(currentClient);

			} catch (error) {
				console.error('Erro ao deletar endereço:', error);
				showToast('Erro ao excluir endereço.', true);
			}
		}

        /* === INÍCIO DA MODIFICAÇÃO === */
		/* Nova função para lidar com a opção "Retirar na Loja" */
		function usePickupAddress() {
			window.valorFrete = 0; // Requisito principal: frete zero
			
			pendingOrderDetails = {
				clienteId: currentClient.id,
				clienteNome: currentClient.nome,
				clienteEndereco: "Retirar na Loja", // Endereço especial
				telefone: currentClient.telefone
			};
			
			selectedAddressText.textContent = "Retirar na Loja";
			addressManagementModal.classList.add('hidden');
			
			updateAllSummaries(); // Atualiza todos os resumos (carrinho, pagamento)
			paymentModal.classList.remove('hidden');
		}
        /* === FIM DA MODIFICAÇÃO === */

		async function useExistingAddress(addressText, addressData) {
			pendingOrderDetails = {
				clienteId: currentClient.id,
				clienteNome: currentClient.nome,
				clienteEndereco: addressText,
				telefone: currentClient.telefone
			};
			selectedAddressText.textContent = addressText;
			addressManagementModal.classList.add('hidden');

			if (addressData?.lat && addressData?.lng) {
				try {
					await window.aguardarGoogleMaps();
					const resultado = await window.calcularFreteParaEndereco({ lat: parseFloat(addressData.lat), lng: parseFloat(addressData.lng) });
					window.valorFrete = parseFloat(resultado.valorFrete);
					showToast(`Frete: R$ ${window.valorFrete.toFixed(2)}`);
				} catch (error) {
					console.error('Erro ao calcular frete:', error);
					showToast('Não foi possível calcular o frete.', true);
					window.valorFrete = 0;
				}
			} else {
				window.valorFrete = 0;
			}
            updateAllSummaries();
			paymentModal.classList.remove('hidden');
		}

        function openCustomerModalForEdit(client) {
            const modal = document.getElementById('customer-details-modal');
            document.getElementById('customer-modal-title').textContent = 'Editar Perfil';
            document.getElementById('customer-modal-phone').textContent = client.telefone;
            const nameInput = document.getElementById('customer-modal-name');
            const birthdateInput = document.getElementById('customer-modal-birthdate');
            
            nameInput.value = client.nome || '';
            birthdateInput.value = client.aniversario || '';
            
            nameInput.readOnly = false;
            birthdateInput.readOnly = false;
            nameInput.classList.remove('bg-gray-100');
            birthdateInput.classList.remove('bg-gray-100');

            const footer = document.getElementById('customer-modal-footer');
            footer.innerHTML = `
                <button id="cancel-edit-btn" type="button" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600">Cancelar</button>
                <button id="save-customer-btn" type="button" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-600">Salvar Alterações</button>
            `;

            document.getElementById('cancel-edit-btn').onclick = () => {
                modal.classList.add('hidden');
                openAddressManagementModal(currentClient); // Go back
            };

            document.getElementById('save-customer-btn').onclick = async () => {
                const newName = nameInput.value.trim();
                const newBirthdate = birthdateInput.value;
                if (!newName || !newBirthdate) {
                    document.getElementById('customer-modal-error').textContent = 'Nome e data de nascimento são obrigatórios.';
                    document.getElementById('customer-modal-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('customer-modal-error').classList.add('hidden');

                try {
                    const { db, doc, updateDoc } = await import('./firebaseClientConfig.js');
                    const clientRef = doc(db, ...storePath('clientes', client.id));
                    await updateDoc(clientRef, { nome: newName, aniversario: newBirthdate });
                    
                    currentClient.nome = newName;
                    currentClient.aniversario = newBirthdate;

                    showToast('Dados atualizados com sucesso!');
                    modal.classList.add('hidden');
                    openAddressManagementModal(currentClient); // Reopen address modal with updated name
                } catch (error) {
                    console.error("Erro ao atualizar cliente:", error);
                    showToast('Erro ao atualizar dados.', true);
                }
            };

            modal.classList.remove('hidden');
        }

        function openCustomerModalForCreate(phone) {
            const modal = document.getElementById('customer-details-modal');
            document.getElementById('customer-modal-title').textContent = 'Novo Cadastro';
            document.getElementById('customer-modal-phone').textContent = phone;
            const nameInput = document.getElementById('customer-modal-name');
            const birthdateInput = document.getElementById('customer-modal-birthdate');
            nameInput.value = '';
            birthdateInput.value = '';
            nameInput.readOnly = false;
            birthdateInput.readOnly = false;
            nameInput.classList.remove('bg-gray-100');
            birthdateInput.classList.remove('bg-gray-100');

            const footer = document.getElementById('customer-modal-footer');
            footer.innerHTML = `
                <button id="create-customer-btn" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold hover:bg-pink-700">Criar Cadastro e Continuar</button>
            `;

            document.getElementById('create-customer-btn').onclick = async () => {
                const newName = nameInput.value.trim();
                const newBirthdate = birthdateInput.value;
                if (!newName || !newBirthdate) {
                    document.getElementById('customer-modal-error').textContent = 'Nome e data de nascimento são obrigatórios.';
                    document.getElementById('customer-modal-error').classList.remove('hidden');
                    return;
                }
                document.getElementById('customer-modal-error').classList.add('hidden');

                const button = document.getElementById('create-customer-btn');
                button.disabled = true;
                button.textContent = 'Criando...';

                try {
                    const { db, addDoc, collection, serverTimestamp } = await import('./firebaseClientConfig.js');
                    const newClientData = {
                        nome: newName,
                        aniversario: newBirthdate,
                        telefone: phone.replace(/\D/g, ''),
                        enderecos: [],
                        lojasVisitadas: [STORE_ID],
                        numeroDeCompras: 0,
                        valorEmCompras: 0,
                        criadoEm: serverTimestamp(),
                        atualizadoEm: serverTimestamp(),
                        lojaId: STORE_ID
                    };
                    const docRef = await addDoc(collection(db, ...storePath("clientes")), newClientData);
                    currentClient = { id: docRef.id, ...newClientData };
                    showToast("Novo cliente criado com sucesso!");
                    modal.classList.add('hidden');
                    openAddressManagementModal(currentClient);

                } catch (error) {
                    console.error("Erro ao criar cliente:", error);
                    showToast("Erro ao criar cadastro. Tente novamente.", true);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Criar Cadastro e Continuar';
                }
            };

            modal.classList.remove('hidden');
            nameInput.focus();
        }

        async function handlePhoneSearch() {
            const phone = phoneInput.value.trim();
            const phoneDigits = phone.replace(/\D/g, ''); 
            
            if (phoneDigits.length < 10) {
                phoneError.textContent = 'Digite um número válido com DDD';
                phoneError.classList.remove('hidden');
                return;
            }

            phoneError.classList.add('hidden');
            searchPhoneButton.disabled = true;
            searchPhoneButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div> Buscando...';
            
            try {
                const { db, collection, getDocs, query, where, doc, updateDoc, arrayUnion } = await import('./firebaseClientConfig.js');
                const q = query(collection(db, ...storePath("clientes")), where("telefone", "==", phoneDigits));
                const querySnapshot = await getDocs(q);

                phoneLoginModal.classList.add('hidden');

                if (!querySnapshot.empty) {
                    const clientDoc = querySnapshot.docs[0];
                    await updateDoc(doc(db, 'clientes', clientDoc.id), {
                        lojasVisitadas: arrayUnion(STORE_ID),
                        lojaId: STORE_ID
                    });
                    const existingData = clientDoc.data();
                    const lojasVisitadas = Array.from(new Set([...(existingData.lojasVisitadas || []), STORE_ID]));
                    currentClient = { id: clientDoc.id, ...existingData, lojasVisitadas };
                    console.log("✅ Cliente encontrado:", currentClient);
                    openAddressManagementModal(currentClient);
                } else {
                    console.log("❌ Cliente não encontrado. Abrindo modal de criação.");
                    openCustomerModalForCreate(phone);
                }
                
            } catch (error) { 
                console.error("Error searching client:", error);
                phoneError.textContent = 'Erro ao buscar cliente. Tente novamente.'; 
                phoneError.classList.remove('hidden');
                phoneLoginModal.classList.remove('hidden');
            } finally {
                searchPhoneButton.disabled = false;
                searchPhoneButton.textContent = 'Buscar';
            }
        }

        function updateAllSummaries() { 
            updateCartInfo(); 
            updatePaymentSummary(); 
            updateGuestSummary(); 
        }

		function updatePaymentSummary() {
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			let discount = appliedCupom?.valorDesconto || 0;
			let total = subtotal - discount + window.valorFrete;
			
			document.getElementById('payment-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
			document.getElementById('payment-total').textContent = `R$ ${total.toFixed(2)}`;
			document.getElementById('payment-discount-row').classList.toggle('hidden', discount === 0);
			if (discount > 0) document.getElementById('payment-discount').textContent = `- R$ ${discount.toFixed(2)}`;
			
			// Atualiza a linha de frete no modal de pagamento
			const shippingRowPayment = document.getElementById('payment-shipping-row');
			const shippingValuePayment = document.getElementById('payment-shipping');
			if (pendingOrderDetails?.clienteEndereco === "Retirar na Loja") {
				shippingValuePayment.textContent = 'R$ 0,00';
				shippingRowPayment.classList.remove('hidden'); // Mostra a linha com R$ 0,00
			} else if (window.valorFrete > 0) {
				shippingValuePayment.textContent = `R$ ${window.valorFrete.toFixed(2)}`;
				shippingRowPayment.classList.remove('hidden'); // Mostra a linha com o valor
			} else {
				shippingRowPayment.classList.add('hidden'); // Oculta se não for retirada e frete for 0
			}
		}


		function updateGuestSummary() {
			const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
			let discount = appliedCupom?.valorDesconto || 0;
			let total = subtotal - discount + window.valorFrete;
			
			document.getElementById('guest-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
			document.getElementById('guest-total').textContent = `R$ ${total.toFixed(2)}`;
			document.getElementById('guest-discount-row').classList.toggle('hidden', discount === 0);
			if (discount > 0) document.getElementById('guest-discount').textContent = `- R$ ${discount.toFixed(2)}`;
			
                        const shippingRow = document.getElementById('guest-shipping-row');
                        const shippingValue = document.getElementById('guest-shipping');
                        if (window.valorFrete > 0) {
                                shippingValue.textContent = `R$ ${window.valorFrete.toFixed(2)}`;
                                shippingRow.classList.remove('hidden');
                        } else if (window.guestCurrentLatLng) {
                                shippingValue.textContent = 'R$ 0,00';
                                shippingRow.classList.remove('hidden');
                        } else {
                                shippingRow.classList.remove('hidden');
                                shippingValue.textContent = 'Aguardando endereço...';
                        }
                }
        window.updateGuestSummary = updateGuestSummary;

        async function handleVerifyCupom(type) {
            const isGuest = type === 'guest';
            if (isGuest) return;
            const cupomInput = paymentCupomInput;
            const cupomMessage = paymentCupomMessage;
            const verifyButton = paymentVerifyCupomButton;
            
            if (appliedCupom) { removeCupom(); return; }
            
            const codigo = cupomInput.value.trim().toUpperCase(); 
            if (!codigo) { showToast('Digite um cupom.', true); return; }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0); 
            if (subtotal <= 0) { showToast('Adicione itens ao carrinho.', true); return; }
            
            verifyButton.disabled = true; 
            verifyButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div>';
            
                try {
                    const { db, collection, getDocs, query, where, getDoc, doc } = await import('./firebaseClientConfig.js');

                    if (!isGuest && currentClient?.id) {
                        const clientDoc = await getDoc(doc(db, ...storePath("clientes", currentClient.id)));
                        if (clientDoc.exists() && clientDoc.data().cuponsUsados?.includes(codigo)) {
                            throw new Error('Você já utilizou este cupom.');
                        }
                    }

                    let cupomPathResolver = storePath;
                    const q = query(collection(db, ...storePath("cupons")), where("codigo", "==", codigo));
                    let cupomSnapshot = await getDocs(q);

                    if (cupomSnapshot.empty) {
                        const legacyQuery = query(collection(db, ...legacyStorePath('cupons')), where('codigo', '==', codigo));
                        cupomSnapshot = await getDocs(legacyQuery);
                        cupomPathResolver = legacyStorePath;
                    }

                    if (cupomSnapshot.empty) throw new Error('Cupom inválido.');

                    const cupom = { id: cupomSnapshot.docs[0].id, ...cupomSnapshot.docs[0].data(), _pathResolver: cupomPathResolver };

                if (cupom.status !== 'Ativo') throw new Error('Cupom inativo.');
                if (cupom.limiteUso > 0 && (cupom.usos || 0) >= cupom.limiteUso) throw new Error('Cupom esgotado.');
                if (subtotal < (cupom.valorMinimo || 0)) throw new Error(`Pedido mínimo de R$ ${cupom.valorMinimo.toFixed(2)}.`);
                
                appliedCupom = cupom;
                appliedCupom.valorDesconto = cupom.tipoDesconto === 'percentual' ? (subtotal * cupom.valor) / 100 : cupom.valor;
                
                cupomMessage.textContent = `Cupom "${appliedCupom.codigo}" aplicado!`; 
                cupomMessage.className = 'text-sm text-green-600';
                cupomInput.value = appliedCupom.codigo; 
                cupomInput.disabled = true;
                verifyButton.textContent = 'Remover'; 
                verifyButton.classList.replace('bg-gray-600', 'bg-red-600');
                showToast('Cupom aplicado!'); 
                updateAllSummaries();

            } catch (error) { 
                cupomMessage.textContent = error.message; 
                cupomMessage.className = 'text-sm text-red-500'; 
                appliedCupom = null;
            } finally { 
                verifyButton.disabled = false; 
                verifyButton.innerHTML = appliedCupom ? 'Remover' : 'Aplicar'; 
            }
        }

        function removeCupom() {
            if (appliedCupom) { showToast('Cupom removido.'); appliedCupom = null; }
            [paymentCupomInput].filter(Boolean).forEach(input => { input.value = ''; input.disabled = false; });
            [paymentVerifyCupomButton].filter(Boolean).forEach(btn => { btn.textContent = 'Aplicar'; btn.classList.replace('bg-red-600', 'bg-gray-600'); });
            [paymentCupomMessage].filter(Boolean).forEach(msg => { msg.textContent = ''; });
            updateAllSummaries();
        }

		async function handleGuestOrder() {
            const name = guestNameInput.value.trim();
            const phone = guestPhoneInput.value.trim();
            const paymentMethod = guestPaymentMethodSelect.value;
            const street = document.getElementById('guest-address-street').value.trim();
            const number = document.getElementById('guest-address-number').value.trim();
            const complement = document.getElementById('guest-address-complement').value.trim();
            const neighborhood = document.getElementById('guest-address-neighborhood').value.trim();
            const city = document.getElementById('guest-address-city').value.trim();
            const zip = document.getElementById('guest-address-zip').value.trim();
            const nickname = document.getElementById('guest-address-nickname').value.trim();

            if (!name || !phone || !paymentMethod || !street || !number || !neighborhood || !city || !nickname) {
                showToast('Preencha todos os campos obrigatórios (*).', true);
                return;
            }
            

            if (!window.guestCurrentLatLng || typeof window.guestCurrentLatLng.lat === 'undefined' || typeof window.guestCurrentLatLng.lng === 'undefined') {
                showToast('Confirme a localização no mapa antes de finalizar.', true);
                return;
            }

            let fullAddress = `${street}${number ? ', ' + number : ''}${complement ? ' - ' + complement : ''}${neighborhood ? ', ' + neighborhood : ''}${city ? ', ' + city : ''}${zip ? ' - CEP: ' + zip : ''}`;
            if (nickname) fullAddress += ` (${nickname})`;

            document.getElementById('guest-address-full').value = fullAddress;
			
			sendWhatsappButton.disabled = true;
			sendWhatsappButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processando...';
			
			try {
				await finalizeOrder({
					clienteNome: name,
					clienteEndereco: fullAddress,
					telefone: phone,
					formaPagamento: paymentMethod
				}, null, false);
				
			} catch (error) {
				console.error('Erro ao processar pedido do visitante:', error);
				showToast('Erro ao processar o pedido.', true);
				sendWhatsappButton.disabled = false;
				sendWhatsappButton.innerHTML = '<i class="fa-brands fa-whatsapp"></i> Finalizar e Enviar via WhatsApp';
			}
		}

        async function handlePlatformOrder() {
            if (!paymentMethodSelect.value) { 
                paymentError.textContent = 'Selecione uma forma de pagamento.'; 
                paymentError.classList.remove('hidden'); 
                return; 
            }
            paymentError.classList.add('hidden');
            confirmOrderButton.disabled = true;
            confirmOrderButton.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !border-t-white mx-auto"></div> Confirmando...';
            
            try {
                const finalOrderDetails = { ...pendingOrderDetails, formaPagamento: paymentMethodSelect.value };
                await finalizeOrder(finalOrderDetails, finalOrderDetails.clienteId, true);
            } catch (error) {
                console.error('Erro ao confirmar pedido:', error);
                showToast('Erro ao confirmar o pedido.', true);
            } finally {
                confirmOrderButton.disabled = false;
                confirmOrderButton.textContent = 'Confirmar Pedido';
            }
        }

        async function finalizeOrder(clientInfo, clientId, isPlatform) {
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            let cupomData = null;
            if(appliedCupom) {
                cupomData = { codigo: appliedCupom.codigo, valorDesconto: appliedCupom.valorDesconto };
            }
            const desconto = cupomData?.valorDesconto || 0;
            const total = subtotal - desconto + window.valorFrete;
            
            const { db, collection, addDoc, serverTimestamp, doc, updateDoc, arrayUnion, getDoc } = await import('./firebaseClientConfig.js');
            
            const orderData = {
                clienteId: clientId,
                clienteNome: clientInfo.clienteNome,
                clienteEndereco: clientInfo.clienteEndereco,
                telefone: clientInfo.telefone,
                formaPagamento: clientInfo.formaPagamento,
                itens: cart.map(item => ({ produtoId: item.id, nome: item.nome, quantity: item.quantity, preco: item.preco })),
                subtotal, desconto, valorFrete: window.valorFrete, total, cupom: cupomData,
                status: 'Pendente',
                origem: isPlatform ? 'Plataforma' : 'Cardapio Online',
                lojaId: STORE_ID,
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, ...storePath("pedidos")), orderData);

                // --- INÍCIO DA LÓGICA DE ATUALIZAÇÃO DE ESTOQUE ---
                for (const item of cart) {
                    try {
                        const productRef = doc(db, ...storePath("produtos", item.id));
                        const productSnap = await getDoc(productRef);

                        if (productSnap.exists()) {
                            const productData = productSnap.data();
                            // Verifica se o controle de estoque está ativo para este produto
                            if (typeof productData.estoque === 'number') {
                                const newStock = productData.estoque - item.quantity;
                                await updateDoc(productRef, { estoque: newStock });
                                console.log(`Estoque do produto ${item.nome} atualizado para ${newStock}.`);
                            }
                        }
                    } catch (stockError) {
                        console.error(`Falha ao atualizar o estoque para o produto ${item.id}:`, stockError);
                        // Apenas registra o erro no console, mas não impede a finalização do pedido.
                    }
                }
                // --- FIM DA LÓGICA DE ATUALIZAÇÃO DE ESTOQUE ---

                if (clientId && appliedCupom) {
                    try {
                        const clientDocRef = doc(db, ...storePath("clientes", clientId));
                        await updateDoc(clientDocRef, { cuponsUsados: arrayUnion(appliedCupom.codigo) });
                        const cupomDocRef = doc(db, ...((appliedCupom._pathResolver || storePath)("cupons", appliedCupom.id)));
                        const cupomDoc = await getDoc(cupomDocRef);
                        if (cupomDoc.exists()) {
                            await updateDoc(cupomDocRef, { usos: (cupomDoc.data().usos || 0) + 1 });
                        }
                    } catch (updateError) {
                        console.error("Erro ao registrar o uso do cupom:", updateError);
                    }
                }
                
                if (!isPlatform) {
                    let message = `*Novo Pedido* 🎂 (Nº ${docRef.id.substring(0, 5)})\n\n*Itens:*\n${cart.map(item => `• ${item.quantity}x ${item.nome}`).join('\n')}\n\n*Resumo:*\nSubtotal: R$ ${subtotal.toFixed(2)}\n`;
                    if (cupomData) message += `Desconto (${cupomData.codigo}): -R$ ${desconto.toFixed(2)}\n`;
                    // Modificação: Não incluir linha de frete se for retirada na loja
                    if (clientInfo.clienteEndereco !== "Retirar na Loja" && window.valorFrete > 0) {
                         message += `Frete: R$ ${window.valorFrete.toFixed(2)}\n`;
                    } else if (clientInfo.clienteEndereco === "Retirar na Loja") {
                         message += `*RETIRAR NA LOJA*\n`; // Indica que é para retirada
                    }
                    message += `*Total: R$ ${total.toFixed(2)}*\n\n*Dados:*\nNome: ${clientInfo.clienteNome}\nTelefone: ${clientInfo.telefone}\nEndereço: ${clientInfo.clienteEndereco}\nPagamento: ${clientInfo.formaPagamento}\n\n_Pedido via Cardápio Online_`;
                    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
                    confirmationModal.classList.remove('hidden');
                } else {
                    platformConfirmationModal.classList.remove('hidden');
                }
                
                cart = []; 
                currentClient = null; 
                pendingOrderDetails = {}; 
                removeCupom(); 
                renderCart();
                
            } catch (error) {
                console.error("Erro ao salvar pedido:", error);
                showToast('Erro ao confirmar o pedido.', true);
            }
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
	
	<script type="module">
		import { db, doc, getDoc } from './firebaseClientConfig.js';
	</script>

	<script>
	// ==================== CÁLCULO DE FRETE E MAPA PARA VISITANTES ====================
    let guestMap, guestMarker, guestGeocoder, guestPlaceAutocomplete;
	
    function normalizeGuestLatLng(latlng) {
        try {
            if (!latlng) return null;
            if (typeof latlng.lat === 'function' && typeof latlng.lng === 'function') {
                return { lat: latlng.lat(), lng: latlng.lng() };
            }
            if (typeof latlng.lat === 'number' && typeof latlng.lng === 'number') {
                return { lat: latlng.lat, lng: latlng.lng };
            }
            if (latlng.toJSON) {
                const json = latlng.toJSON();
                if (typeof json.lat === 'number' && typeof json.lng === 'number') {
                    return { lat: json.lat, lng: json.lng };
                }
            }
        } catch (error) {
            console.error('Erro ao normalizar coordenadas de visitante:', error, latlng);
        }
        return null;
    }

    async function updateGuestShippingAndSummary(latlng) {
        const normalizedLatLng = normalizeGuestLatLng(latlng);
        if (!normalizedLatLng) {
            console.warn('Coordenadas inválidas para cálculo de frete do visitante:', latlng);
            window.guestCurrentLatLng = null;
            window.valorFrete = 0;
        window.guestCurrentLatLng = normalizedLatLng;
            window.updateGuestSummary();
            return;
        }

        if (!canUseMaps()) {
            window.valorFrete = 0;
            window.updateGuestSummary();
            return;
        }

        document.getElementById('guest-shipping').textContent = 'Calculando...';
        window.valorFrete = 0;
        window.updateGuestSummary();

        try {
            await window.aguardarGoogleMaps();
            const resultado = await window.calcularFreteParaEndereco(normalizedLatLng);
            const valorCalculado = parseFloat(resultado.valorFrete);
            window.valorFrete = Number.isFinite(valorCalculado) ? valorCalculado : 0;
            window.showToast(`Frete: R$ ${window.valorFrete.toFixed(2)}`);
        } catch (error) {
            markMapsUnavailable(error);
            console.error('Falha ao calcular frete para visitante:', error);
            window.showToast('Não foi possível calcular o frete.', true);
            window.valorFrete = 0;
        } finally {
            window.updateGuestSummary();
        }
    }
    window.updateGuestShippingAndSummary = updateGuestShippingAndSummary;

    function fillGuestAddressFields(place) {
        const rawComponents = place?.addressComponents || place?.address_components || [];
        const normalizeComponent = (component) => {
            if (!component) return null;
            const name = component.long_name || component.longName || component.name || component.short_name || component.shortName;
            return {
                value: name || '',
                types: component.types || [],
            };
        };

        const components = rawComponents.map(normalizeComponent).filter(Boolean);
        const get = (type) => components.find((c) => c.types.includes(type))?.value?.trim() || '';

        const formattedAddress = place?.formattedAddress || place?.formatted_address || '';
        const streetFromPlace = get('route') || formattedAddress.split(',')[0]?.trim();
        const numberFromPlace = get('street_number');
        const neighborhoodFromPlace = get('sublocality_level_1') || get('neighborhood') || get('political');
        const cityFromPlace = get('administrative_area_level_2');
        const zipFromPlace = get('postal_code');

        const streetInput = document.getElementById('guest-address-street');
        const numberInput = document.getElementById('guest-address-number');
        const neighborhoodInput = document.getElementById('guest-address-neighborhood');
        const cityInput = document.getElementById('guest-address-city');
        const zipInput = document.getElementById('guest-address-zip');

        if (streetFromPlace && streetInput) streetInput.value = streetFromPlace;
        if (numberFromPlace && numberInput && !numberInput.value) numberInput.value = numberFromPlace;
        if (neighborhoodFromPlace && neighborhoodInput) neighborhoodInput.value = neighborhoodFromPlace;
        if (cityInput) {
            cityInput.value = cityFromPlace || cityInput.value || 'Goiânia';
        }
        if (zipFromPlace && zipInput && !zipInput.value) zipInput.value = zipFromPlace;

        const fullInput = document.getElementById('guest-address-full');
        if (fullInput) fullInput.value = formattedAddress || fullInput.value || '';
    }

    function reverseGeocodeGuest(latlng) {
        const normalizedLatLng = normalizeGuestLatLng(latlng);
        if (!normalizedLatLng) {
            showToast('Erro ao obter coordenadas do endereço. Tente novamente.', true);
            return;
        }

        if (!canUseMaps()) {
          if (!guestGeocoderErrorLogged) {
            console.error('Geocoder para visitante indisponível.');
            guestGeocoderErrorLogged = true;
          }
          updateGuestShippingAndSummary(normalizedLatLng);
          return;
        }

        if (!guestGeocoder) {
            guestGeocoder = new google.maps.Geocoder();
        }

        guestGeocoder.geocode({ location: normalizedLatLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                fillGuestAddressFields(results[0]);
            }
            updateGuestShippingAndSummary(normalizedLatLng);
        });
    }

    window.initGuestAddressMap = async function() {
        const addressMapContainer = document.getElementById('guest-address-map-container');
        if (addressMapContainer.dataset.initialized) return;
        addressMapContainer.innerHTML = '';

        try {
            await window.loadGoogleMapsScript();
            mapsApiAvailable = !!window.google?.maps;
            const defaultCenter = { lat: -16.644661430463806, lng: -49.324890665224544 };
            guestGeocoder = new google.maps.Geocoder();

            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            const mapDiv = document.createElement('div');
            mapDiv.style.cssText = 'height:300px; width:100%; border-radius:0.5rem; margin-top:0.75rem;';
            
            guestMap = new Map(mapDiv, { center: defaultCenter, zoom: 14, mapId: 'DEMO_MAP_ID' });
            guestMarker = new AdvancedMarkerElement({ map: guestMap, position: defaultCenter, gmpDraggable: true });
			const guestStoreInfoWindow = new google.maps.InfoWindow({
                content: '<div style="font-weight:600;color:#db2777;font-size:0.95rem;">Ana Guimarães doceria</div>',
                disableAutoPan: true,
            });
            guestStoreInfoWindow.open({ anchor: guestMarker, map: guestMap });
            guestMarker.addListener('dragend', () => reverseGeocodeGuest(guestMarker.position));
            guestMarker.addListener('dragstart', () => guestStoreInfoWindow.close());
			guestPlaceAutocomplete = new google.maps.places.PlaceAutocompleteElement();
            guestPlaceAutocomplete.className = 'w-full mb-2 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500';
            guestPlaceAutocomplete.setAttribute('placeholder', 'Digite o endereço para entrega...');

            guestPlaceAutocomplete.addEventListener('gmp-select', async ({ placePrediction }) => {
                const place = placePrediction.toPlace();
                await place.fetchFields({ fields: ['location', 'formattedAddress', 'addressComponents'] });
                if (place.location) {
                    const newPosition = { lat: place.location.lat(), lng: place.location.lng() };
                    guestMap.setCenter(newPosition);
                    guestMap.setZoom(18);
                    guestStoreInfoWindow.close();
                    guestMarker.position = newPosition;
                    fillGuestAddressFields(place);
                    updateGuestShippingAndSummary(newPosition);
                }
            });
            
            const locationBtn = document.createElement('button');
            locationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i> Usar minha localização';
            locationBtn.className = 'w-full bg-pink-600 text-white px-3 py-2 rounded-lg font-bold mb-2 hover:bg-pink-700 transition-colors';
            locationBtn.type = 'button';
            locationBtn.onclick = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        guestMap.panTo(coords);
                        guestMap.setZoom(17);
                                                guestStoreInfoWindow.close();
                        guestMarker.position = coords;
                        reverseGeocodeGuest(coords);
                    });
                }
            };
            
            addressMapContainer.append(guestPlaceAutocomplete, locationBtn, mapDiv);
            addressMapContainer.dataset.initialized = 'true';
        } catch (error) {
            markMapsUnavailable(error);
            addressMapContainer.innerHTML = `<div class="bg-amber-50 p-4 text-amber-800 rounded-lg">Mapa indisponível. Preencha o endereço manualmente para continuar.</div>`;
        }
    }
	// ==================== CÁLCULO DE FRETE - VERSÃO ÚNICA ====================

	// Função auxiliar para aguardar o Google Maps carregar
        function aguardarGoogleMaps() {
                return new Promise((resolve, reject) => {
                        if (window.google && window.google.maps) {
                                return resolve();
                        }
            let attempt = 0;
                        const checkInterval = setInterval(() => {
                attempt++;
                                if (window.google && window.google.maps) {
                                        clearInterval(checkInterval);
                                        resolve();
                                } else if (attempt > 50) { // Timeout after 10 seconds
                    clearInterval(checkInterval);
                    markMapsUnavailable('Timeout: Google Maps não carregou.');
                    reject('Timeout: Google Maps não carregou.');
                }
                        }, 200);
                });
        }
    window.aguardarGoogleMaps = aguardarGoogleMaps;

	// Função para calcular frete usando Google Distance Matrix API
	async function calcularFreteParaEndereco(destinoLatLng) {
		console.log('🚚 Iniciando cálculo de frete...');
		
		return new Promise((resolve, reject) => {
			if (!window.dadosFrete) {
				return reject('Configurações de frete não carregadas');
			}
			if (!window.google || !window.google.maps) {
				return reject('Google Maps não carregado');
			}
			
			const loja = {
				lat: parseFloat(window.dadosFrete.lat),
				lng: parseFloat(window.dadosFrete.lng)
			};
			const valorPorKm = parseFloat(window.dadosFrete.valorPorKm);
			
			const service = new google.maps.DistanceMatrixService();
			service.getDistanceMatrix({
				origins: [loja],
				destinations: [destinoLatLng],
				travelMode: google.maps.TravelMode.DRIVING,
				unitSystem: google.maps.UnitSystem.METRIC
			}, (response, status) => {
				if (status !== 'OK' || response.rows[0]?.elements[0]?.status !== 'OK') {
                    console.error('Erro no Distance Matrix:', status, response);
					return reject(status);
				}
				
				const element = response.rows[0].elements[0];
				const distanceKm = element.distance.value / 1000;
				let valorFreteCalculado = distanceKm * valorPorKm;

				if (valorFreteCalculado < 2) {
					valorFreteCalculado = 2.00;
				}

				resolve({
					distanciaKm: distanceKm.toFixed(2),
					valorFrete: valorFreteCalculado.toFixed(2)
				});
			});
		});
	}
    window.calcularFreteParaEndereco = calcularFreteParaEndereco;

	console.log('✅ Módulos de frete e mapa carregados');
	

	</script>
	

</body>
</html>


